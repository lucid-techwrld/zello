var Xt={},br=Object.create,Zi=Object.defineProperty,vr=Object.getOwnPropertyDescriptor,en=Object.getOwnPropertyNames,Cr=Object.getPrototypeOf,Sr=Object.prototype.hasOwnProperty,qe=(e,t)=>function(){return t||(0,e[en(e)[0]])((t={exports:{}}).exports,t),t.exports},Rr=(e,t,s,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of en(t))!Sr.call(e,n)&&n!==s&&Zi(e,n,{get:()=>t[n],enumerable:!(i=vr(t,n))||i.enumerable});return e},Be=(e,t,s)=>(s=e!=null?br(Cr(e)):{},Rr(!e||!e.__esModule?Zi(s,"default",{value:e,enumerable:!0}):s,e)),Er=qe({"node_modules/base64-js/index.js"(e){e.byteLength=l,e.toByteArray=c,e.fromByteArray=m;var t=[],s=[],i=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(r=0,a=n.length;r<a;++r)t[r]=n[r],s[n.charCodeAt(r)]=r;var r,a;s[45]=62,s[95]=63;function o(u){var p=u.length;if(p%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var y=u.indexOf("=");y===-1&&(y=p);var b=y===p?0:4-y%4;return[y,b]}function l(u){var p=o(u),y=p[0],b=p[1];return(y+b)*3/4-b}function d(u,p,y){return(p+y)*3/4-y}function c(u){var p,y=o(u),b=y[0],w=y[1],v=new i(d(u,b,w)),C=0,S=w>0?b-4:b,U;for(U=0;U<S;U+=4)p=s[u.charCodeAt(U)]<<18|s[u.charCodeAt(U+1)]<<12|s[u.charCodeAt(U+2)]<<6|s[u.charCodeAt(U+3)],v[C++]=p>>16&255,v[C++]=p>>8&255,v[C++]=p&255;return w===2&&(p=s[u.charCodeAt(U)]<<2|s[u.charCodeAt(U+1)]>>4,v[C++]=p&255),w===1&&(p=s[u.charCodeAt(U)]<<10|s[u.charCodeAt(U+1)]<<4|s[u.charCodeAt(U+2)]>>2,v[C++]=p>>8&255,v[C++]=p&255),v}function h(u){return t[u>>18&63]+t[u>>12&63]+t[u>>6&63]+t[u&63]}function f(u,p,y){for(var b,w=[],v=p;v<y;v+=3)b=(u[v]<<16&16711680)+(u[v+1]<<8&65280)+(u[v+2]&255),w.push(h(b));return w.join("")}function m(u){for(var p,y=u.length,b=y%3,w=[],v=16383,C=0,S=y-b;C<S;C+=v)w.push(f(u,C,C+v>S?S:C+v));return b===1?(p=u[y-1],w.push(t[p>>2]+t[p<<4&63]+"==")):b===2&&(p=(u[y-2]<<8)+u[y-1],w.push(t[p>>10]+t[p>>4&63]+t[p<<2&63]+"=")),w.join("")}}}),xr=qe({"(disabled):https"(){}}),Ur=qe({"node_modules/form-data/lib/browser.js"(e,t){t.exports=typeof self=="object"?self.FormData:window.FormData}}),Mr=qe({"(disabled):node_modules/jsonwebtoken/index.js"(){}}),Ar=qe({"(disabled):crypto"(){}}),Lr=Be(Er());function _s(e){return typeof e=="string"}function di(e,t){return!!t&&_s(e)}function Tr(e,t){const s=[];if(_s(e)&&di(e,t)){for(let i=0,n=e.length;i<n;i++)if(e.charAt(i)){const r=e.charAt(i),a=t(r,i,e);s[i]=a}}else if(!_s(e)&&!di(e,t)){for(let i=0,n=e.length;i<n;i++)if(i in e){const r=e[i],a=t(r,i,e);s[i]=a}}return s}var Ir=e=>(0,Lr.fromByteArray)(new Uint8Array(Tr(e,t=>t.charCodeAt(0)))),Dr=e=>{const t={},s=String.fromCharCode,i=e.length;let n,r=0,a,o,l=0,d,c="";const h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(n=0;n<64;n++)t[h.charAt(n)]=n;for(o=0;o<i;o++)for(a=t[e.charAt(o)],r=(r<<6)+a,l+=6;l>=8;)((d=r>>>(l-=8)&255)||o<i-2)&&(c+=s(d));return c},hi=class{constructor(e,t,s){this.client=e,this.id=t,this.data=s}async create(){const e={id:this.id,message_template:this.data?.message_template,segment_ids:this.data?.segment_ids,sender_id:this.data?.sender_id,sender_mode:this.data?.sender_mode,channel_template:this.data?.channel_template,create_channels:this.data?.create_channels,show_channels:this.data?.show_channels,description:this.data?.description,name:this.data?.name,skip_push:this.data?.skip_push,skip_webhook:this.data?.skip_webhook,user_ids:this.data?.user_ids},t=await this.client.createCampaign(e);return this.id=t.campaign.id,this.data=t.campaign,t}verifyCampaignId(){if(!this.id)throw new Error("Campaign id is missing. Either create the campaign using campaign.create() or set the id during instantiation - const campaign = client.campaign(id)")}async start(e){return this.verifyCampaignId(),await this.client.startCampaign(this.id,e)}update(e){return this.verifyCampaignId(),this.client.updateCampaign(this.id,e)}async delete(){return this.verifyCampaignId(),await this.client.deleteCampaign(this.id)}stop(){return this.verifyCampaignId(),this.client.stopCampaign(this.id)}get(e){return this.verifyCampaignId(),this.client.getCampaign(this.id,e)}};function tn(e,t){return function(){return e.apply(t,arguments)}}var{toString:Pr}=Object.prototype,{getPrototypeOf:js}=Object,$t=(e=>t=>{const s=Pr.call(t);return e[s]||(e[s]=s.slice(8,-1).toLowerCase())})(Object.create(null)),$=e=>(e=e.toLowerCase(),t=>$t(t)===e),Vt=e=>t=>typeof t===e,{isArray:ge}=Array,Pe=Vt("undefined");function Or(e){return e!==null&&!Pe(e)&&e.constructor!==null&&!Pe(e.constructor)&&N(e.constructor.isBuffer)&&e.constructor.isBuffer(e)}var sn=$("ArrayBuffer");function kr(e){let t;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?t=ArrayBuffer.isView(e):t=e&&e.buffer&&sn(e.buffer),t}var Nr=Vt("string"),N=Vt("function"),nn=Vt("number"),Ht=e=>e!==null&&typeof e=="object",Fr=e=>e===!0||e===!1,Xe=e=>{if($t(e)!=="object")return!1;const t=js(e);return(t===null||t===Object.prototype||Object.getPrototypeOf(t)===null)&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)},qr=$("Date"),Br=$("File"),$r=$("Blob"),Vr=$("FileList"),Hr=e=>Ht(e)&&N(e.pipe),jr=e=>{let t;return e&&(typeof FormData=="function"&&e instanceof FormData||N(e.append)&&((t=$t(e))==="formdata"||t==="object"&&N(e.toString)&&e.toString()==="[object FormData]"))},Wr=$("URLSearchParams"),zr=e=>e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function $e(e,t,{allOwnKeys:s=!1}={}){if(e===null||typeof e>"u")return;let i,n;if(typeof e!="object"&&(e=[e]),ge(e))for(i=0,n=e.length;i<n;i++)t.call(null,e[i],i,e);else{const r=s?Object.getOwnPropertyNames(e):Object.keys(e),a=r.length;let o;for(i=0;i<a;i++)o=r[i],t.call(null,e[o],o,e)}}function rn(e,t){t=t.toLowerCase();const s=Object.keys(e);let i=s.length,n;for(;i-- >0;)if(n=s[i],t===n.toLowerCase())return n;return null}var an=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,on=e=>!Pe(e)&&e!==an;function ws(){const{caseless:e}=on(this)&&this||{},t={},s=(i,n)=>{const r=e&&rn(t,n)||n;Xe(t[r])&&Xe(i)?t[r]=ws(t[r],i):Xe(i)?t[r]=ws({},i):ge(i)?t[r]=i.slice():t[r]=i};for(let i=0,n=arguments.length;i<n;i++)arguments[i]&&$e(arguments[i],s);return t}var Qr=(e,t,s,{allOwnKeys:i}={})=>($e(t,(n,r)=>{s&&N(n)?e[r]=tn(n,s):e[r]=n},{allOwnKeys:i}),e),Gr=e=>(e.charCodeAt(0)===65279&&(e=e.slice(1)),e),Jr=(e,t,s,i)=>{e.prototype=Object.create(t.prototype,i),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),s&&Object.assign(e.prototype,s)},Kr=(e,t,s,i)=>{let n,r,a;const o={};if(t=t||{},e==null)return t;do{for(n=Object.getOwnPropertyNames(e),r=n.length;r-- >0;)a=n[r],(!i||i(a,e,t))&&!o[a]&&(t[a]=e[a],o[a]=!0);e=s!==!1&&js(e)}while(e&&(!s||s(e,t))&&e!==Object.prototype);return t},Yr=(e,t,s)=>{e=String(e),(s===void 0||s>e.length)&&(s=e.length),s-=t.length;const i=e.indexOf(t,s);return i!==-1&&i===s},Xr=e=>{if(!e)return null;if(ge(e))return e;let t=e.length;if(!nn(t))return null;const s=new Array(t);for(;t-- >0;)s[t]=e[t];return s},Zr=(e=>t=>e&&t instanceof e)(typeof Uint8Array<"u"&&js(Uint8Array)),ea=(e,t)=>{const i=(e&&e[Symbol.iterator]).call(e);let n;for(;(n=i.next())&&!n.done;){const r=n.value;t.call(e,r[0],r[1])}},ta=(e,t)=>{let s;const i=[];for(;(s=e.exec(t))!==null;)i.push(s);return i},sa=$("HTMLFormElement"),ia=e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(s,i,n){return i.toUpperCase()+n}),ui=(({hasOwnProperty:e})=>(t,s)=>e.call(t,s))(Object.prototype),na=$("RegExp"),ln=(e,t)=>{const s=Object.getOwnPropertyDescriptors(e),i={};$e(s,(n,r)=>{let a;(a=t(n,r,e))!==!1&&(i[r]=a||n)}),Object.defineProperties(e,i)},ra=e=>{ln(e,(t,s)=>{if(N(e)&&["arguments","caller","callee"].indexOf(s)!==-1)return!1;const i=e[s];if(N(i)){if(t.enumerable=!1,"writable"in t){t.writable=!1;return}t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+s+"'")})}})},aa=(e,t)=>{const s={},i=n=>{n.forEach(r=>{s[r]=!0})};return ge(e)?i(e):i(String(e).split(t)),s},oa=()=>{},la=(e,t)=>(e=+e,Number.isFinite(e)?e:t),Zt="abcdefghijklmnopqrstuvwxyz",fi="0123456789",cn={DIGIT:fi,ALPHA:Zt,ALPHA_DIGIT:Zt+Zt.toUpperCase()+fi},ca=(e=16,t=cn.ALPHA_DIGIT)=>{let s="";const{length:i}=t;for(;e--;)s+=t[Math.random()*i|0];return s};function da(e){return!!(e&&N(e.append)&&e[Symbol.toStringTag]==="FormData"&&e[Symbol.iterator])}var ha=e=>{const t=new Array(10),s=(i,n)=>{if(Ht(i)){if(t.indexOf(i)>=0)return;if(!("toJSON"in i)){t[n]=i;const r=ge(i)?[]:{};return $e(i,(a,o)=>{const l=s(a,n+1);!Pe(l)&&(r[o]=l)}),t[n]=void 0,r}}return i};return s(e,0)},ua=$("AsyncFunction"),fa=e=>e&&(Ht(e)||N(e))&&N(e.then)&&N(e.catch),g={isArray:ge,isArrayBuffer:sn,isBuffer:Or,isFormData:jr,isArrayBufferView:kr,isString:Nr,isNumber:nn,isBoolean:Fr,isObject:Ht,isPlainObject:Xe,isUndefined:Pe,isDate:qr,isFile:Br,isBlob:$r,isRegExp:na,isFunction:N,isStream:Hr,isURLSearchParams:Wr,isTypedArray:Zr,isFileList:Vr,forEach:$e,merge:ws,extend:Qr,trim:zr,stripBOM:Gr,inherits:Jr,toFlatObject:Kr,kindOf:$t,kindOfTest:$,endsWith:Yr,toArray:Xr,forEachEntry:ea,matchAll:ta,isHTMLForm:sa,hasOwnProperty:ui,hasOwnProp:ui,reduceDescriptors:ln,freezeMethods:ra,toObjectSet:aa,toCamelCase:ia,noop:oa,toFiniteNumber:la,findKey:rn,global:an,isContextDefined:on,ALPHABET:cn,generateString:ca,isSpecCompliantForm:da,toJSONObject:ha,isAsyncFn:ua,isThenable:fa};function fe(e,t,s,i,n){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=e,this.name="AxiosError",t&&(this.code=t),s&&(this.config=s),i&&(this.request=i),n&&(this.response=n)}g.inherits(fe,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:g.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var dn=fe.prototype,hn={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(e=>{hn[e]={value:e}});Object.defineProperties(fe,hn);Object.defineProperty(dn,"isAxiosError",{value:!0});fe.from=(e,t,s,i,n,r)=>{const a=Object.create(dn);return g.toFlatObject(e,a,function(l){return l!==Error.prototype},o=>o!=="isAxiosError"),fe.call(a,e.message,t,s,i,n),a.cause=e,a.name=e.name,r&&Object.assign(a,r),a};var E=fe,pa=null;function bs(e){return g.isPlainObject(e)||g.isArray(e)}function un(e){return g.endsWith(e,"[]")?e.slice(0,-2):e}function pi(e,t,s){return e?e.concat(t).map(function(n,r){return n=un(n),!s&&r?"["+n+"]":n}).join(s?".":""):t}function ga(e){return g.isArray(e)&&!e.some(bs)}var ma=g.toFlatObject(g,{},null,function(t){return/^is[A-Z]/.test(t)});function ya(e,t,s){if(!g.isObject(e))throw new TypeError("target must be an object");t=t||new FormData,s=g.toFlatObject(s,{metaTokens:!0,dots:!1,indexes:!1},!1,function(p,y){return!g.isUndefined(y[p])});const i=s.metaTokens,n=s.visitor||c,r=s.dots,a=s.indexes,l=(s.Blob||typeof Blob<"u"&&Blob)&&g.isSpecCompliantForm(t);if(!g.isFunction(n))throw new TypeError("visitor must be a function");function d(u){if(u===null)return"";if(g.isDate(u))return u.toISOString();if(!l&&g.isBlob(u))throw new E("Blob is not supported. Use a Buffer instead.");return g.isArrayBuffer(u)||g.isTypedArray(u)?l&&typeof Blob=="function"?new Blob([u]):Buffer.from(u):u}function c(u,p,y){let b=u;if(u&&!y&&typeof u=="object"){if(g.endsWith(p,"{}"))p=i?p:p.slice(0,-2),u=JSON.stringify(u);else if(g.isArray(u)&&ga(u)||(g.isFileList(u)||g.endsWith(p,"[]"))&&(b=g.toArray(u)))return p=un(p),b.forEach(function(v,C){!(g.isUndefined(v)||v===null)&&t.append(a===!0?pi([p],C,r):a===null?p:p+"[]",d(v))}),!1}return bs(u)?!0:(t.append(pi(y,p,r),d(u)),!1)}const h=[],f=Object.assign(ma,{defaultVisitor:c,convertValue:d,isVisitable:bs});function m(u,p){if(!g.isUndefined(u)){if(h.indexOf(u)!==-1)throw Error("Circular reference detected in "+p.join("."));h.push(u),g.forEach(u,function(b,w){(!(g.isUndefined(b)||b===null)&&n.call(t,b,g.isString(w)?w.trim():w,p,f))===!0&&m(b,p?p.concat(w):[w])}),h.pop()}}if(!g.isObject(e))throw new TypeError("data must be an object");return m(e),t}var jt=ya;function gi(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,function(i){return t[i]})}function fn(e,t){this._pairs=[],e&&jt(e,this,t)}var pn=fn.prototype;pn.append=function(t,s){this._pairs.push([t,s])};pn.toString=function(t){const s=t?function(i){return t.call(this,i,gi)}:gi;return this._pairs.map(function(n){return s(n[0])+"="+s(n[1])},"").join("&")};var gn=fn;function _a(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function mn(e,t,s){if(!t)return e;const i=s&&s.encode||_a,n=s&&s.serialize;let r;if(n?r=n(t,s):r=g.isURLSearchParams(t)?t.toString():new gn(t,s).toString(i),r){const a=e.indexOf("#");a!==-1&&(e=e.slice(0,a)),e+=(e.indexOf("?")===-1?"?":"&")+r}return e}var wa=class{constructor(){this.handlers=[]}use(e,t,s){return this.handlers.push({fulfilled:e,rejected:t,synchronous:s?s.synchronous:!1,runWhen:s?s.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){g.forEach(this.handlers,function(s){s!==null&&e(s)})}},mi=wa,yn={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},ba=typeof URLSearchParams<"u"?URLSearchParams:gn,va=typeof FormData<"u"?FormData:null,Ca=typeof Blob<"u"?Blob:null,Sa=(()=>{let e;return typeof navigator<"u"&&((e=navigator.product)==="ReactNative"||e==="NativeScript"||e==="NS")?!1:typeof window<"u"&&typeof document<"u"})(),Ra=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",B={classes:{URLSearchParams:ba,FormData:va,Blob:Ca},isStandardBrowserEnv:Sa,isStandardBrowserWebWorkerEnv:Ra,protocols:["http","https","file","blob","url","data"]};function Ea(e,t){return jt(e,new B.classes.URLSearchParams,Object.assign({visitor:function(s,i,n,r){return B.isNode&&g.isBuffer(s)?(this.append(i,s.toString("base64")),!1):r.defaultVisitor.apply(this,arguments)}},t))}function xa(e){return g.matchAll(/\w+|\[(\w*)]/g,e).map(t=>t[0]==="[]"?"":t[1]||t[0])}function Ua(e){const t={},s=Object.keys(e);let i;const n=s.length;let r;for(i=0;i<n;i++)r=s[i],t[r]=e[r];return t}function Ma(e){function t(s,i,n,r){let a=s[r++];const o=Number.isFinite(+a),l=r>=s.length;return a=!a&&g.isArray(n)?n.length:a,l?(g.hasOwnProp(n,a)?n[a]=[n[a],i]:n[a]=i,!o):((!n[a]||!g.isObject(n[a]))&&(n[a]=[]),t(s,i,n[a],r)&&g.isArray(n[a])&&(n[a]=Ua(n[a])),!o)}if(g.isFormData(e)&&g.isFunction(e.entries)){const s={};return g.forEachEntry(e,(i,n)=>{t(xa(i),n,s,0)}),s}return null}var _n=Ma;function Aa(e,t,s){if(g.isString(e))try{return(t||JSON.parse)(e),g.trim(e)}catch(i){if(i.name!=="SyntaxError")throw i}return(s||JSON.stringify)(e)}var Ws={transitional:yn,adapter:["xhr","http"],transformRequest:[function(t,s){const i=s.getContentType()||"",n=i.indexOf("application/json")>-1,r=g.isObject(t);if(r&&g.isHTMLForm(t)&&(t=new FormData(t)),g.isFormData(t))return n&&n?JSON.stringify(_n(t)):t;if(g.isArrayBuffer(t)||g.isBuffer(t)||g.isStream(t)||g.isFile(t)||g.isBlob(t))return t;if(g.isArrayBufferView(t))return t.buffer;if(g.isURLSearchParams(t))return s.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let o;if(r){if(i.indexOf("application/x-www-form-urlencoded")>-1)return Ea(t,this.formSerializer).toString();if((o=g.isFileList(t))||i.indexOf("multipart/form-data")>-1){const l=this.env&&this.env.FormData;return jt(o?{"files[]":t}:t,l&&new l,this.formSerializer)}}return r||n?(s.setContentType("application/json",!1),Aa(t)):t}],transformResponse:[function(t){const s=this.transitional||Ws.transitional,i=s&&s.forcedJSONParsing,n=this.responseType==="json";if(t&&g.isString(t)&&(i&&!this.responseType||n)){const a=!(s&&s.silentJSONParsing)&&n;try{return JSON.parse(t)}catch(o){if(a)throw o.name==="SyntaxError"?E.from(o,E.ERR_BAD_RESPONSE,this,null,this.response):o}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:B.classes.FormData,Blob:B.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};g.forEach(["delete","get","head","post","put","patch"],e=>{Ws.headers[e]={}});var zs=Ws,La=g.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),Ta=e=>{const t={};let s,i,n;return e&&e.split(`
`).forEach(function(a){n=a.indexOf(":"),s=a.substring(0,n).trim().toLowerCase(),i=a.substring(n+1).trim(),!(!s||t[s]&&La[s])&&(s==="set-cookie"?t[s]?t[s].push(i):t[s]=[i]:t[s]=t[s]?t[s]+", "+i:i)}),t},yi=Symbol("internals");function _e(e){return e&&String(e).trim().toLowerCase()}function Ze(e){return e===!1||e==null?e:g.isArray(e)?e.map(Ze):String(e)}function Ia(e){const t=Object.create(null),s=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let i;for(;i=s.exec(e);)t[i[1]]=i[2];return t}var Da=e=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(e.trim());function es(e,t,s,i,n){if(g.isFunction(i))return i.call(this,t,s);if(n&&(t=s),!!g.isString(t)){if(g.isString(i))return t.indexOf(i)!==-1;if(g.isRegExp(i))return i.test(t)}}function Pa(e){return e.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(t,s,i)=>s.toUpperCase()+i)}function Oa(e,t){const s=g.toCamelCase(" "+t);["get","set","has"].forEach(i=>{Object.defineProperty(e,i+s,{value:function(n,r,a){return this[i].call(this,t,n,r,a)},configurable:!0})})}var Wt=class{constructor(e){e&&this.set(e)}set(e,t,s){const i=this;function n(a,o,l){const d=_e(o);if(!d)throw new Error("header name must be a non-empty string");const c=g.findKey(i,d);(!c||i[c]===void 0||l===!0||l===void 0&&i[c]!==!1)&&(i[c||o]=Ze(a))}const r=(a,o)=>g.forEach(a,(l,d)=>n(l,d,o));return g.isPlainObject(e)||e instanceof this.constructor?r(e,t):g.isString(e)&&(e=e.trim())&&!Da(e)?r(Ta(e),t):e!=null&&n(t,e,s),this}get(e,t){if(e=_e(e),e){const s=g.findKey(this,e);if(s){const i=this[s];if(!t)return i;if(t===!0)return Ia(i);if(g.isFunction(t))return t.call(this,i,s);if(g.isRegExp(t))return t.exec(i);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=_e(e),e){const s=g.findKey(this,e);return!!(s&&this[s]!==void 0&&(!t||es(this,this[s],s,t)))}return!1}delete(e,t){const s=this;let i=!1;function n(r){if(r=_e(r),r){const a=g.findKey(s,r);a&&(!t||es(s,s[a],a,t))&&(delete s[a],i=!0)}}return g.isArray(e)?e.forEach(n):n(e),i}clear(e){const t=Object.keys(this);let s=t.length,i=!1;for(;s--;){const n=t[s];(!e||es(this,this[n],n,e,!0))&&(delete this[n],i=!0)}return i}normalize(e){const t=this,s={};return g.forEach(this,(i,n)=>{const r=g.findKey(s,n);if(r){t[r]=Ze(i),delete t[n];return}const a=e?Pa(n):String(n).trim();a!==n&&delete t[n],t[a]=Ze(i),s[a]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return g.forEach(this,(s,i)=>{s!=null&&s!==!1&&(t[i]=e&&g.isArray(s)?s.join(", "):s)}),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,t])=>e+": "+t).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const s=new this(e);return t.forEach(i=>s.set(i)),s}static accessor(e){const s=(this[yi]=this[yi]={accessors:{}}).accessors,i=this.prototype;function n(r){const a=_e(r);s[a]||(Oa(i,r),s[a]=!0)}return g.isArray(e)?e.forEach(n):n(e),this}};Wt.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);g.reduceDescriptors(Wt.prototype,({value:e},t)=>{let s=t[0].toUpperCase()+t.slice(1);return{get:()=>e,set(i){this[s]=i}}});g.freezeMethods(Wt);var W=Wt;function ts(e,t){const s=this||zs,i=t||s,n=W.from(i.headers);let r=i.data;return g.forEach(e,function(o){r=o.call(s,r,n.normalize(),t?t.status:void 0)}),n.normalize(),r}function wn(e){return!!(e&&e.__CANCEL__)}function bn(e,t,s){E.call(this,e??"canceled",E.ERR_CANCELED,t,s),this.name="CanceledError"}g.inherits(bn,E,{__CANCEL__:!0});var zt=bn;function ka(e,t,s){const i=s.config.validateStatus;!s.status||!i||i(s.status)?e(s):t(new E("Request failed with status code "+s.status,[E.ERR_BAD_REQUEST,E.ERR_BAD_RESPONSE][Math.floor(s.status/100)-4],s.config,s.request,s))}var Na=B.isStandardBrowserEnv?(function(){return{write:function(s,i,n,r,a,o){const l=[];l.push(s+"="+encodeURIComponent(i)),g.isNumber(n)&&l.push("expires="+new Date(n).toGMTString()),g.isString(r)&&l.push("path="+r),g.isString(a)&&l.push("domain="+a),o===!0&&l.push("secure"),document.cookie=l.join("; ")},read:function(s){const i=document.cookie.match(new RegExp("(^|;\\s*)("+s+")=([^;]*)"));return i?decodeURIComponent(i[3]):null},remove:function(s){this.write(s,"",Date.now()-864e5)}}})():(function(){return{write:function(){},read:function(){return null},remove:function(){}}})();function Fa(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}function qa(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}function vn(e,t){return e&&!Fa(t)?qa(e,t):t}var Ba=B.isStandardBrowserEnv?(function(){const t=/(msie|trident)/i.test(navigator.userAgent),s=document.createElement("a");let i;function n(r){let a=r;return t&&(s.setAttribute("href",a),a=s.href),s.setAttribute("href",a),{href:s.href,protocol:s.protocol?s.protocol.replace(/:$/,""):"",host:s.host,search:s.search?s.search.replace(/^\?/,""):"",hash:s.hash?s.hash.replace(/^#/,""):"",hostname:s.hostname,port:s.port,pathname:s.pathname.charAt(0)==="/"?s.pathname:"/"+s.pathname}}return i=n(window.location.href),function(a){const o=g.isString(a)?n(a):a;return o.protocol===i.protocol&&o.host===i.host}})():(function(){return function(){return!0}})();function $a(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}function Va(e,t){e=e||10;const s=new Array(e),i=new Array(e);let n=0,r=0,a;return t=t!==void 0?t:1e3,function(l){const d=Date.now(),c=i[r];a||(a=d),s[n]=l,i[n]=d;let h=r,f=0;for(;h!==n;)f+=s[h++],h=h%e;if(n=(n+1)%e,n===r&&(r=(r+1)%e),d-a<t)return;const m=c&&d-c;return m?Math.round(f*1e3/m):void 0}}var Ha=Va;function _i(e,t){let s=0;const i=Ha(50,250);return n=>{const r=n.loaded,a=n.lengthComputable?n.total:void 0,o=r-s,l=i(o),d=r<=a;s=r;const c={loaded:r,total:a,progress:a?r/a:void 0,bytes:o,rate:l||void 0,estimated:l&&a&&d?(a-r)/l:void 0,event:n};c[t?"download":"upload"]=!0,e(c)}}var ja=typeof XMLHttpRequest<"u",Wa=ja&&function(e){return new Promise(function(s,i){let n=e.data;const r=W.from(e.headers).normalize(),a=e.responseType;let o;function l(){e.cancelToken&&e.cancelToken.unsubscribe(o),e.signal&&e.signal.removeEventListener("abort",o)}let d;g.isFormData(n)&&(B.isStandardBrowserEnv||B.isStandardBrowserWebWorkerEnv?r.setContentType(!1):r.getContentType(/^\s*multipart\/form-data/)?g.isString(d=r.getContentType())&&r.setContentType(d.replace(/^\s*(multipart\/form-data);+/,"$1")):r.setContentType("multipart/form-data"));let c=new XMLHttpRequest;if(e.auth){const u=e.auth.username||"",p=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";r.set("Authorization","Basic "+btoa(u+":"+p))}const h=vn(e.baseURL,e.url);c.open(e.method.toUpperCase(),mn(h,e.params,e.paramsSerializer),!0),c.timeout=e.timeout;function f(){if(!c)return;const u=W.from("getAllResponseHeaders"in c&&c.getAllResponseHeaders()),y={data:!a||a==="text"||a==="json"?c.responseText:c.response,status:c.status,statusText:c.statusText,headers:u,config:e,request:c};ka(function(w){s(w),l()},function(w){i(w),l()},y),c=null}if("onloadend"in c?c.onloadend=f:c.onreadystatechange=function(){!c||c.readyState!==4||c.status===0&&!(c.responseURL&&c.responseURL.indexOf("file:")===0)||setTimeout(f)},c.onabort=function(){c&&(i(new E("Request aborted",E.ECONNABORTED,e,c)),c=null)},c.onerror=function(){i(new E("Network Error",E.ERR_NETWORK,e,c)),c=null},c.ontimeout=function(){let p=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded";const y=e.transitional||yn;e.timeoutErrorMessage&&(p=e.timeoutErrorMessage),i(new E(p,y.clarifyTimeoutError?E.ETIMEDOUT:E.ECONNABORTED,e,c)),c=null},B.isStandardBrowserEnv){const u=Ba(h)&&e.xsrfCookieName&&Na.read(e.xsrfCookieName);u&&r.set(e.xsrfHeaderName,u)}n===void 0&&r.setContentType(null),"setRequestHeader"in c&&g.forEach(r.toJSON(),function(p,y){c.setRequestHeader(y,p)}),g.isUndefined(e.withCredentials)||(c.withCredentials=!!e.withCredentials),a&&a!=="json"&&(c.responseType=e.responseType),typeof e.onDownloadProgress=="function"&&c.addEventListener("progress",_i(e.onDownloadProgress,!0)),typeof e.onUploadProgress=="function"&&c.upload&&c.upload.addEventListener("progress",_i(e.onUploadProgress)),(e.cancelToken||e.signal)&&(o=u=>{c&&(i(!u||u.type?new zt(null,e,c):u),c.abort(),c=null)},e.cancelToken&&e.cancelToken.subscribe(o),e.signal&&(e.signal.aborted?o():e.signal.addEventListener("abort",o)));const m=$a(h);if(m&&B.protocols.indexOf(m)===-1){i(new E("Unsupported protocol "+m+":",E.ERR_BAD_REQUEST,e));return}c.send(n||null)})},vs={http:pa,xhr:Wa};g.forEach(vs,(e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch{}Object.defineProperty(e,"adapterName",{value:t})}});var wi=e=>`- ${e}`,za=e=>g.isFunction(e)||e===null||e===!1,Cn={getAdapter:e=>{e=g.isArray(e)?e:[e];const{length:t}=e;let s,i;const n={};for(let r=0;r<t;r++){s=e[r];let a;if(i=s,!za(s)&&(i=vs[(a=String(s)).toLowerCase()],i===void 0))throw new E(`Unknown adapter '${a}'`);if(i)break;n[a||"#"+r]=i}if(!i){const r=Object.entries(n).map(([o,l])=>`adapter ${o} `+(l===!1?"is not supported by the environment":"is not available in the build"));let a=t?r.length>1?`since :
`+r.map(wi).join(`
`):" "+wi(r[0]):"as no adapter specified";throw new E("There is no suitable adapter to dispatch the request "+a,"ERR_NOT_SUPPORT")}return i},adapters:vs};function ss(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new zt(null,e)}function bi(e){return ss(e),e.headers=W.from(e.headers),e.data=ts.call(e,e.transformRequest),["post","put","patch"].indexOf(e.method)!==-1&&e.headers.setContentType("application/x-www-form-urlencoded",!1),Cn.getAdapter(e.adapter||zs.adapter)(e).then(function(i){return ss(e),i.data=ts.call(e,e.transformResponse,i),i.headers=W.from(i.headers),i},function(i){return wn(i)||(ss(e),i&&i.response&&(i.response.data=ts.call(e,e.transformResponse,i.response),i.response.headers=W.from(i.response.headers))),Promise.reject(i)})}var vi=e=>e instanceof W?e.toJSON():e;function pe(e,t){t=t||{};const s={};function i(d,c,h){return g.isPlainObject(d)&&g.isPlainObject(c)?g.merge.call({caseless:h},d,c):g.isPlainObject(c)?g.merge({},c):g.isArray(c)?c.slice():c}function n(d,c,h){if(g.isUndefined(c)){if(!g.isUndefined(d))return i(void 0,d,h)}else return i(d,c,h)}function r(d,c){if(!g.isUndefined(c))return i(void 0,c)}function a(d,c){if(g.isUndefined(c)){if(!g.isUndefined(d))return i(void 0,d)}else return i(void 0,c)}function o(d,c,h){if(h in t)return i(d,c);if(h in e)return i(void 0,d)}const l={url:r,method:r,data:r,baseURL:a,transformRequest:a,transformResponse:a,paramsSerializer:a,timeout:a,timeoutMessage:a,withCredentials:a,adapter:a,responseType:a,xsrfCookieName:a,xsrfHeaderName:a,onUploadProgress:a,onDownloadProgress:a,decompress:a,maxContentLength:a,maxBodyLength:a,beforeRedirect:a,transport:a,httpAgent:a,httpsAgent:a,cancelToken:a,socketPath:a,responseEncoding:a,validateStatus:o,headers:(d,c)=>n(vi(d),vi(c),!0)};return g.forEach(Object.keys(Object.assign({},e,t)),function(c){const h=l[c]||n,f=h(e[c],t[c],c);g.isUndefined(f)&&h!==o||(s[c]=f)}),s}var Sn="1.6.0",Qs={};["object","boolean","number","function","string","symbol"].forEach((e,t)=>{Qs[e]=function(i){return typeof i===e||"a"+(t<1?"n ":" ")+e}});var Ci={};Qs.transitional=function(t,s,i){function n(r,a){return"[Axios v"+Sn+"] Transitional option '"+r+"'"+a+(i?". "+i:"")}return(r,a,o)=>{if(t===!1)throw new E(n(a," has been removed"+(s?" in "+s:"")),E.ERR_DEPRECATED);return s&&!Ci[a]&&(Ci[a]=!0,console.warn(n(a," has been deprecated since v"+s+" and will be removed in the near future"))),t?t(r,a,o):!0}};function Qa(e,t,s){if(typeof e!="object")throw new E("options must be an object",E.ERR_BAD_OPTION_VALUE);const i=Object.keys(e);let n=i.length;for(;n-- >0;){const r=i[n],a=t[r];if(a){const o=e[r],l=o===void 0||a(o,r,e);if(l!==!0)throw new E("option "+r+" must be "+l,E.ERR_BAD_OPTION_VALUE);continue}if(s!==!0)throw new E("Unknown option "+r,E.ERR_BAD_OPTION)}}var Cs={assertOptions:Qa,validators:Qs},z=Cs.validators,ot=class{constructor(e){this.defaults=e,this.interceptors={request:new mi,response:new mi}}request(e,t){typeof e=="string"?(t=t||{},t.url=e):t=e||{},t=pe(this.defaults,t);const{transitional:s,paramsSerializer:i,headers:n}=t;s!==void 0&&Cs.assertOptions(s,{silentJSONParsing:z.transitional(z.boolean),forcedJSONParsing:z.transitional(z.boolean),clarifyTimeoutError:z.transitional(z.boolean)},!1),i!=null&&(g.isFunction(i)?t.paramsSerializer={serialize:i}:Cs.assertOptions(i,{encode:z.function,serialize:z.function},!0)),t.method=(t.method||this.defaults.method||"get").toLowerCase();let r=n&&g.merge(n.common,n[t.method]);n&&g.forEach(["delete","get","head","post","put","patch","common"],m=>{delete n[m]}),t.headers=W.concat(r,n);const a=[];let o=!0;this.interceptors.request.forEach(function(u){typeof u.runWhen=="function"&&u.runWhen(t)===!1||(o=o&&u.synchronous,a.unshift(u.fulfilled,u.rejected))});const l=[];this.interceptors.response.forEach(function(u){l.push(u.fulfilled,u.rejected)});let d,c=0,h;if(!o){const m=[bi.bind(this),void 0];for(m.unshift.apply(m,a),m.push.apply(m,l),h=m.length,d=Promise.resolve(t);c<h;)d=d.then(m[c++],m[c++]);return d}h=a.length;let f=t;for(c=0;c<h;){const m=a[c++],u=a[c++];try{f=m(f)}catch(p){u.call(this,p);break}}try{d=bi.call(this,f)}catch(m){return Promise.reject(m)}for(c=0,h=l.length;c<h;)d=d.then(l[c++],l[c++]);return d}getUri(e){e=pe(this.defaults,e);const t=vn(e.baseURL,e.url);return mn(t,e.params,e.paramsSerializer)}};g.forEach(["delete","get","head","options"],function(t){ot.prototype[t]=function(s,i){return this.request(pe(i||{},{method:t,url:s,data:(i||{}).data}))}});g.forEach(["post","put","patch"],function(t){function s(i){return function(r,a,o){return this.request(pe(o||{},{method:t,headers:i?{"Content-Type":"multipart/form-data"}:{},url:r,data:a}))}}ot.prototype[t]=s(),ot.prototype[t+"Form"]=s(!0)});var et=ot,Ga=class Rn{constructor(t){if(typeof t!="function")throw new TypeError("executor must be a function.");let s;this.promise=new Promise(function(r){s=r});const i=this;this.promise.then(n=>{if(!i._listeners)return;let r=i._listeners.length;for(;r-- >0;)i._listeners[r](n);i._listeners=null}),this.promise.then=n=>{let r;const a=new Promise(o=>{i.subscribe(o),r=o}).then(n);return a.cancel=function(){i.unsubscribe(r)},a},t(function(r,a,o){i.reason||(i.reason=new zt(r,a,o),s(i.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(t){if(this.reason){t(this.reason);return}this._listeners?this._listeners.push(t):this._listeners=[t]}unsubscribe(t){if(!this._listeners)return;const s=this._listeners.indexOf(t);s!==-1&&this._listeners.splice(s,1)}static source(){let t;return{token:new Rn(function(n){t=n}),cancel:t}}},Ja=Ga;function Ka(e){return function(s){return e.apply(null,s)}}function Ya(e){return g.isObject(e)&&e.isAxiosError===!0}var Ss={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(Ss).forEach(([e,t])=>{Ss[t]=e});var Xa=Ss;function En(e){const t=new et(e),s=tn(et.prototype.request,t);return g.extend(s,et.prototype,t,{allOwnKeys:!0}),g.extend(s,t,null,{allOwnKeys:!0}),s.create=function(n){return En(pe(e,n))},s}var A=En(zs);A.Axios=et;A.CanceledError=zt;A.CancelToken=Ja;A.isCancel=wn;A.VERSION=Sn;A.toFormData=jt;A.AxiosError=E;A.Cancel=A.CanceledError;A.all=function(t){return Promise.all(t)};A.spread=Ka;A.isAxiosError=Ya;A.mergeConfig=pe;A.AxiosHeaders=W;A.formToJSON=e=>_n(g.isHTMLForm(e)?new FormData(e):e);A.getAdapter=Cn.getAdapter;A.HttpStatusCode=Xa;A.default=A;var Oe=A,{Axios:dd,AxiosError:hd,CanceledError:ud,isCancel:fd,CancelToken:pd,VERSION:gd,all:md,Cancel:yd,isAxiosError:_d,spread:wd,toFormData:bd,AxiosHeaders:vd,HttpStatusCode:Cd,formToJSON:Sd,getAdapter:Rd,mergeConfig:Ed}=Oe,Za=Be(xr()),eo=Be(Ur()),to=25,so=100,is={hasNext:!1,hasPrev:!1},io=100*1024*1024,no=10,ro=100,ao={created_at:!0,deleted_at:!0,pinned_at:!0,updated_at:!0,command:!0,mentioned_users:!0,quoted_message:!0,latest_reactions:!0,own_reactions:!0,reaction_counts:!0,reply_count:!0,i18n:!0,type:!0,html:!0,__html:!0,user:!0},oo={error:!0},lo=3,co=1e3;function xn(e,t){e.then().catch(s=>{console.warn(`failed to do ${t}, ran into error: `,s)})}var K=e=>new Promise(t=>setTimeout(t,e));function Rs(e){return typeof e=="function"||e instanceof Function||Object.prototype.toString.call(e)==="[object Function]"}var Ce={TOKEN_EXPIRED:40,WS_CLOSED_SUCCESS:1e3};function ho(e){return e!==null&&typeof e=="object"&&(e.readable||typeof e._read=="function")}function uo(e){return e!=null&&e.constructor!=null&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function fo(e){return typeof window<"u"&&"File"in window&&e instanceof File}function po(e){return typeof window<"u"&&"Blob"in window&&e instanceof Blob}function go(e){return{channel_mutes:!0,devices:!0,mutes:!0,total_unread_count:!0,unread_channels:!0,unread_count:!0,unread_threads:!0,invisible:!0,privacy_settings:!0,roles:!0,push_preferences:!0}[e]}function mo(e,t,s){const i=new eo.default;return ho(e)||uo(e)||fo(e)||po(e)?t?i.append("file",e,t):i.append("file",e):i.append("file",{uri:e,name:t||e.split("/").reverse()[0],contentType:s,type:s}),i}function L(e){const t=[],s=Array.isArray(e)?e:[e];for(const i of s){const n=Object.entries(i);n.length>1&&console.warn("client._buildSort() - multiple fields in a single sort object detected. Object's field order is not guaranteed");for(const[r,a]of n)t.push({field:r,direction:a})}return t}function lt(e){const t=Math.min(500+e*2e3,25e3),s=Math.min(Math.max(250,(e-1)*2e3),25e3);return Math.floor(Math.random()*(t-s)+s)}function de(){return P()}function we(e){let t="";for(let s=0;s<e.length;s++)t+=e[s].toString(16).padStart(2,"0");return t}function P(){const e=wo(16);return e[6]=e[6]&15|64,e[8]=e[8]&191|128,we(e.subarray(0,4))+"-"+we(e.subarray(4,6))+"-"+we(e.subarray(6,8))+"-"+we(e.subarray(8,10))+"-"+we(e.subarray(10,16))}function yo(e){const t=Math.pow(2,8*e.byteLength/e.length);for(let s=0;s<e.length;s++)e[s]=Math.random()*t}var _o=typeof crypto<"u"&&typeof crypto?.getRandomValues<"u"?crypto.getRandomValues.bind(crypto):typeof msCrypto<"u"?msCrypto.getRandomValues.bind(msCrypto):yo;function wo(e){const t=new Uint8Array(e);return _o(t),t}function bo(e){const t={};if(!e)return t;try{Object.getOwnPropertyNames(e).forEach(s=>{t[s]=Object.getOwnPropertyDescriptor(e,s)})}catch{return{error:"failed to serialize the error"}}return t}function vo(){const e=typeof navigator<"u"?navigator:typeof window<"u"&&window.navigator?window.navigator:void 0;return e?typeof e.onLine!="boolean"?!0:e.onLine:(console.warn("isOnline failed to access window.navigator and assume browser is online"),!0)}function Un(e){typeof window<"u"&&window.addEventListener&&(window.addEventListener("offline",e),window.addEventListener("online",e))}function Mn(e){typeof window<"u"&&window.removeEventListener&&(window.removeEventListener("offline",e),window.removeEventListener("online",e))}var Co=e=>{const t=[];for(const s in e)e[s]!==void 0&&(Array.isArray(e[s])||typeof e[s]=="object"?t.push(`${s}=${encodeURIComponent(JSON.stringify(e[s]))}`):t.push(`${s}=${encodeURIComponent(e[s])}`));return t.join("&")};function I(e){const t=s=>s?{...s,created_at:e.created_at?new Date(e.created_at):new Date,deleted_at:e.deleted_at?new Date(e.deleted_at):null,pinned_at:e.pinned_at?new Date(e.pinned_at):null,reaction_groups:Ro(e.reaction_groups,e.reaction_counts,e.reaction_scores),status:e.status||"received",updated_at:e.updated_at?new Date(e.updated_at):new Date}:null;return{...t(e),error:e.error??null,quoted_message:t(e.quoted_message)}}function So(e){const t=s=>{if(!s)return null;const i=new Date().toISOString();return{...s,created_at:e.created_at?e.created_at.toISOString():i,deleted_at:e.deleted_at?e.deleted_at.toISOString():void 0,pinned_at:e.pinned_at?e.pinned_at.toISOString():void 0,updated_at:e.updated_at?e.updated_at.toISOString():i}};return{...t(e),quoted_message:t(e.quoted_message)}}var xd=e=>{const{created_at:t,updated_at:s,deleted_at:i,error:n,status:r,latest_reactions:a,own_reactions:o,reaction_counts:l,reaction_scores:d,reply_count:c,command:h,html:f,i18n:m,quoted_message:u,mentioned_users:p,...y}=e;return{...y,pinned_at:y.pinned_at?.toISOString(),mentioned_users:p?.map(b=>b.id)}},An=e=>{const t={...ao,...oo};return{...Object.fromEntries(Object.entries(e).filter(([i])=>!t[i])),pinned:!!e.pinned_at,mentioned_users:e.mentioned_users?.map(i=>typeof i=="string"?i:i.id)}},Si=({message:e,deletedAt:t,hardDelete:s=!1})=>s?{attachments:[],cid:e.cid,created_at:e.created_at,deleted_at:t,id:e.id,latest_reactions:[],mentioned_users:[],own_reactions:[],parent_id:e.parent_id,reply_count:e.reply_count,status:e.status,thread_participants:e.thread_participants,type:"deleted",updated_at:e.updated_at,user:e.user}:{...e,attachments:[],type:"deleted",deleted_at:t},ns=({messages:e,user:t,hardDelete:s=!1,deletedAt:i})=>{for(let n=0;n<e.length;n++){const r=e[n];r.user?.id===t.id&&(e[n]=r.type==="deleted"?r:Si({message:r,hardDelete:s,deletedAt:i})),r.quoted_message?.user?.id===t.id&&(e[n].quoted_message=r.quoted_message.type==="deleted"?r.quoted_message:Si({message:e[n].quoted_message,hardDelete:s,deletedAt:i}))}},Ln=({needle:e,sortedArray:t,selectKey:s,selectValueToCompare:i=r=>r,sortDirection:n="ascending"})=>{if(!t.length)return 0;let r=0,a=t.length-1,o=0;const l=()=>{o=Math.round((r+a)/2)},d=i(e);for(;r<=a;){l();const c=i(t[o]);n==="ascending"&&d<c||n==="descending"&&d>=c?a=o-1:r=o+1}if(s){const c=s(e),h=n==="ascending"?-1:1;for(let f=r+h;0<=f&&f<t.length&&i(t[f])===d;f+=h)if(s(t[f])===c)return f}return r};function Tn(e,t,s=!1,i="created_at",n=!0){const r=n||s;let a=[...e];if(s&&(a=a.filter(c=>!(c.id&&t.id===c.id))),a.length===0&&r)return a.concat(t);if(a.length===0)return a;const o=t[i].getTime(),l=a.at(-1)[i].getTime()<o;if(l&&r)return a.concat(t);if(l)return a;const d=Ln({needle:t,sortedArray:a,sortDirection:"ascending",selectValueToCompare:c=>c[i].getTime(),selectKey:c=>c.id});return!s&&t.id&&a[d]&&t.id===a[d].id?(a[d]=t,a):(r&&a.splice(d,0,t),a)}function Ro(e,t,s){if(e)return e;if(t&&s){const i={};for(const n of Object.keys(t))i[n]={count:t[n],sum_scores:s[n]};return i}return null}var ke=(e,t=0,{leading:s=!1,trailing:i=!0}={})=>{let n=null,r=null,a;const o=(...l)=>(n?clearTimeout(n):s&&(a=e(...l)),i&&(r=l),n=setTimeout(()=>{r&&(a=e(...r),r=null),n=null},t),a);return o.cancel=()=>{n&&clearTimeout(n)},o.flush=()=>(n&&(clearTimeout(n),n=null,r&&(a=e(...r))),a),o},In=(e,t=200,{leading:s=!0,trailing:i=!1}={})=>{let n=null,r=null;return(...a)=>{if(n){i&&(r=a);return}s&&e(...a);const o=()=>{if(r){e(...r),r=null,n=setTimeout(o,t);return}n=null};n=setTimeout(o,t)}},Eo=(e,t)=>t.split(".").reduce((s,i)=>{if(s&&typeof s=="object"&&i in s)return s[i]},e),xo=(e,t)=>{if(!Array.isArray(e))return[];const s=new Set;return e.filter(i=>{const n=Eo(i,t);return s.has(n)?!1:(s.add(n),!0)})};function Uo(e,t){let s=0,i=e.length-1;for(;s<=i;){const n=Math.floor((s+i)/2),r=e[n].created_at;if(!r){s+=1;continue}const a=new Date(r);if(a.getTime()===t.getTime())return n;a.getTime()<t.getTime()?s=n+1:i=n-1}return s}var Mo=({parentSet:e,requestedPageSize:t,returnedPage:s,messagePaginationOptions:i})=>{const n={...e.pagination};if(!i?.created_at_around)return n;let r,a,o,l;const d=new Date(i.created_at_around),[c,h]=[s[0],s.slice(-1)[0]],f=!!c?.created_at&&new Date(c.created_at)>d,m=!!h?.created_at&&new Date(h.created_at)<d,u=t>e.messages.length&&t>s.length,p=(t>e.messages.length||e.messages.length>=s.length)&&t>s.length;if(f)r=!1,o=!0,u&&(a=!1,l=!0);else if(m)a=!1,l=!0,u&&(r=!1,o=!0);else if(p)a=r=!1,o=l=!0;else{const[y,b]=[c?.id&&c.id===e.messages[0]?.id,h?.id&&h.id===e.messages.slice(-1)[0]?.id];o=y,l=b;const w=Math.floor(s.length/2),v=Uo(s,d);v!==-1&&(r=w<=v,a=w>=v)}return o&&typeof r<"u"&&(n.hasPrev=r),l&&typeof a<"u"&&(n.hasNext=a),n},Ao=({parentSet:e,requestedPageSize:t,returnedPage:s,messagePaginationOptions:i})=>{const n={...e.pagination},{id_around:r}=i||{};if(!r)return n;let a,o;const[l,d]=[s[0],s.slice(-1)[0]],[c,h]=[l?.id===e.messages[0]?.id,d?.id===e.messages.slice(-1)[0]?.id];let f=c,m=h;const u=Math.floor(s.length/2);if((t>e.messages.length||e.messages.length>=s.length)&&t>s.length)o=a=!1,f=m=!0;else if(s[u])if(s[u].id===r)a=o=!0;else{let y;const b=[s.slice(0,u),s.slice(u)];a=o=!0;for(let w=0;w<b.length;w++)y=b[w].find(v=>v.id===r),y&&w===0&&(a=!1),y&&w===1&&(o=!1)}else return n;return f&&typeof a<"u"&&(n.hasPrev=a),m&&typeof o<"u"&&(n.hasNext=o),n},Lo=({parentSet:e,requestedPageSize:t,returnedPage:s,messagePaginationOptions:i})=>{const n={...e.pagination};let r,a;const[o,l]=[s[0],s.slice(-1)[0]],[d,c]=[o?.id&&o.id===e.messages[0]?.id,l?.id&&l.id===e.messages.slice(-1)[0]?.id],h=i&&(i.created_at_after_or_equal||i.created_at_after||i.id_gt||i.id_gte),f=typeof i>"u"?!0:i.created_at_before_or_equal||i.created_at_before||i.id_lt||i.id_lte||i.offset,m=!h&&!f&&!i?.id_around&&!i?.created_at_around,u=s.length>=t;(typeof f<"u"||m)&&(r=u),typeof h<"u"&&(a=u);const p=s.length===0;return(d||p)&&typeof r<"u"&&(n.hasPrev=r),(c||p)&&typeof a<"u"&&(n.hasNext=a),n},Dn=e=>{const t=e.returnedPage.filter(({shadowed:s})=>s);return e.parentSet.messages.length+t.length<e.returnedPage.length?(e.logger?.("error","Corrupted message set state: parent set size < returned page size"),e.parentSet.pagination):e.messagePaginationOptions?.created_at_around?Mo(e):e.messagePaginationOptions?.id_around?Ao(e):Lo(e)},He={},rs=async({channel:e,client:t,id:s,members:i,options:n,type:r})=>{if(!e&&!r)throw new Error("Channel or channel type have to be provided to query a channel.");const a=e||t.channel(r,s,{members:i}),o=a.id?a.cid:i&&i.length?Gs(a.type,i):void 0;if(!o)throw new Error("Channel ID or channel members array have to be provided to query a channel.");const l=He[o];if(l)await l;else try{He[o]=a.watch(n),await He[o]}finally{delete He[o]}return a},Gs=(e,t)=>{if(!t)return;const s=[...t].sort().join(",");if(s)return`${e}:!members-${s}`},ct=e=>e?!!e.state.membership?.pinned_at:!1,je=e=>e?!!e.state.membership?.archived_at:!1,We=e=>e?typeof e.archived=="boolean":!1,Pn=({atIndex:e,sort:t,targetKey:s})=>{if(!t)return null;let i=null;if(Array.isArray(t))i=t[e]??null;else for(const n in t){if(n!==s)return null;i=t;break}return i?.[s]??null},Es=e=>{const t=To({sort:e});return typeof t!="number"?!1:Math.abs(t)===1},To=({sort:e})=>Pn({atIndex:0,sort:e,targetKey:"pinned_at"}),On=({channels:e})=>{let t=null;for(const s of e){if(!ct(s))break;typeof t=="number"?t++:t=0}return t},ze=({channels:e,channelToMove:t,channelToMoveIndexWithinChannels:s,sort:i})=>{const n=s??e.findIndex(h=>h.cid===t.cid),r=n>=0,a=n===0,o=Es(i),l=ct(t);if(a||o&&l)return e;const d=[...e];r&&d.splice(n,1);let c=null;return o&&(c=On({channels:d})),d.splice(typeof c=="number"?c+1:0,0,t),d},Io=e=>!!e.getTime,kn=e=>Io(e.created_at),Do=class{constructor(e){this.messageSets=[],this.formatMessage=t=>I(t),this.setIsUpToDate=t=>{this.isUpToDate=t},this.removeMessageFromArray=(t,s)=>{const i=t.filter(n=>!(n.id&&s.id&&n.id===s.id));return{removed:i.length<t.length,result:i}},this.updateUserMessages=t=>{const s=(i,n)=>{for(let r=0;r<i.length;r++){const a=i[r];a.user?.id===n.id&&(i[r]={...a,user:n})}};this.messageSets.forEach(i=>s(i.messages,t));for(const i in this.threads)s(this.threads[i],t);s(this.pinnedMessages,t)},this.deleteUserMessages=(t,s=!1,i)=>{this.messageSets.forEach(({messages:n})=>ns({messages:n,user:t,hardDelete:s,deletedAt:i??null}));for(const n in this.threads)ns({messages:this.threads[n],user:t,hardDelete:s,deletedAt:i??null});ns({messages:this.pinnedMessages,user:t,hardDelete:s,deletedAt:i??null})},this._channel=e,this.watcher_count=0,this.typing={},this.read={},this.initMessages(),this.pinnedMessages=[],this.pending_messages=[],this.threads={},this.mutedUsers=[],this.watchers={},this.members={},this.membership={},this.unreadCount=0,this.isUpToDate=!0,this.last_message_at=e?.state?.last_message_at!=null?new Date(e.state.last_message_at):null}get messages(){return this.messageSets.find(e=>e.isCurrent)?.messages||[]}set messages(e){const t=this.messageSets.findIndex(s=>s.isCurrent);this.messageSets[t].messages=e}get latestMessages(){return this.messageSets.find(e=>e.isLatest)?.messages||[]}set latestMessages(e){const t=this.messageSets.findIndex(s=>s.isLatest);this.messageSets[t].messages=e}get messagePagination(){return this.messageSets.find(e=>e.isCurrent)?.pagination||is}addMessageSorted(e,t=!1,s=!0,i="latest"){return this.addMessagesSorted([e],t,!1,s,i)}addMessagesSorted(e,t=!1,s=!1,i=!0,n="current"){const{messagesToAdd:r,targetMessageSetIndex:a}=this.findTargetMessageSet(e,i,n);for(let o=0;o<r.length;o+=1){if(r[o].shadowed)continue;const d=r[o].created_at instanceof Date;let c;d?c=r[o]:(c=this.formatMessage(r[o]),c.user&&this._channel?.cid&&this._channel.getClient().state.updateUserReference(c.user,this._channel.cid),s&&c.id&&this.threads[c.id]&&delete this.threads[c.id],this.last_message_at||(this.last_message_at=new Date(c.created_at.getTime())),c.created_at.getTime()>this.last_message_at.getTime()&&(this.last_message_at=new Date(c.created_at.getTime())));const h=c.parent_id;if((!h||c.show_in_channel)&&a!==-1&&(this.messageSets[a].messages=this._addToMessageList(this.messageSets[a].messages,c,t,"created_at",i)),h&&!s){const f=this.threads[h]||[];this.threads[h]=this._addToMessageList(f,c,t,"created_at",i)}}return{messageSet:this.messageSets[a]}}addPinnedMessages(e){for(let t=0;t<e.length;t+=1)this.addPinnedMessage(e[t])}addPinnedMessage(e){this.pinnedMessages=this._addToMessageList(this.pinnedMessages,this.formatMessage(e),!1,"pinned_at")}removePinnedMessage(e){const{result:t}=this.removeMessageFromArray(this.pinnedMessages,e);this.pinnedMessages=t}addReaction(e,t,s){const i=t;let n;if(i||(n=this.findMessage(e.message_id)),!i&&!n)return;const r=i??n,a={id:r?.id,parent_id:r?.parent_id,pinned:r?.pinned,show_in_channel:r?.show_in_channel};return this._updateMessage(a,o=>{if(i){const l={...i};return i.own_reactions=this._addOwnReactionToMessage(o.own_reactions,e,s),l.own_reactions=this._channel.getClient().userID===e.user_id?i.own_reactions:o.own_reactions,this.formatMessage(l)}return n?this._addReactionToState(n,e,s):o}),i??n}_addReactionToState(e,t,s){if(e.reaction_groups||(e.reaction_groups={}),s)for(const o of e.own_reactions??[]){const l=e.reaction_groups[o.type];e.reaction_groups[o.type]={...l,count:l.count-1,sum_scores:l.sum_scores-(o.score??1)},e.reaction_groups[o.type].count<1&&delete e.reaction_groups[o.type]}const n=e.reaction_groups[t.type],r=t.score??1;e.reaction_groups[t.type]=n?{...n,count:n.count+1,sum_scores:n.sum_scores+r,last_reaction_at:t.created_at}:{count:1,first_reaction_at:t.created_at,last_reaction_at:t.created_at,sum_scores:r},e.own_reactions=this._addOwnReactionToMessage(e.own_reactions,t,s);const a=this._channel.getClient().userID;return e.latest_reactions=s?[...(e.latest_reactions||[]).filter(o=>o.user_id!==a),t]:[...e.latest_reactions||[],t],e}_addOwnReactionToMessage(e,t,s){return s?e=[]:e=this._removeOwnReactionFromMessage(e,t),e=e||[],this._channel.getClient().userID===t.user_id&&e.push(t),e}_removeOwnReactionFromMessage(e,t){return e&&e.filter(s=>s.user_id!==t.user_id||s.type!==t.type)}removeReaction(e,t){const s=t;let i;if(s||(i=this.findMessage(e.message_id)),!s&&!i)return;const n=s??i,r={id:n?.id,parent_id:n?.parent_id,pinned:n?.pinned,show_in_channel:n?.show_in_channel};return this._updateMessage(r,a=>s?(s.own_reactions=this._removeOwnReactionFromMessage(a.own_reactions,e),this.formatMessage(s)):i?this._removeReactionFromState(i,e):a),s}_removeReactionFromState(e,t){const s=e.own_reactions?.find(n=>n.type===t.type);if(s&&e.reaction_groups?.[s.type]){const n=e.reaction_groups[s.type];e.reaction_groups[s.type]={...n,count:n.count-1,sum_scores:n.sum_scores-(s.score??1)},e.reaction_groups[s.type].count<1&&delete e.reaction_groups[s.type]}e.own_reactions=e.own_reactions?.filter(n=>n.type!==t.type);const i=this._channel.getClient().userID;return e.latest_reactions=e.latest_reactions?.filter(n=>!(n.user_id===i&&n.type===t.type)),e}_updateQuotedMessageReferences({message:e,remove:t}){const s=n=>({...n,created_at:n.created_at.toISOString(),pinned_at:n.pinned_at?.toISOString(),updated_at:n.updated_at?.toISOString()}),i=n=>{const r=n.reduce((a,o)=>(o.quoted_message_id===e.id&&a.push({...s(o),quoted_message:t?{...e,attachments:[]}:e}),a),[]);this.addMessagesSorted(r,!0)};e.parent_id?e.parent_id&&this.threads[e.parent_id]&&i(this.threads[e.parent_id]):this.messageSets.forEach(n=>i(n.messages))}removeQuotedMessageReferences(e){this._updateQuotedMessageReferences({message:e,remove:!0})}_updateMessage(e,t){const{parent_id:s,show_in_channel:i,pinned:n}=e;if(s&&this.threads[s]){const r=this.threads[s],a=r.findIndex(o=>o.id===e.id);a!==-1&&(r[a]=t(r[a]),this.threads[s]=r)}if(!i&&!s||i){const r=this.findMessageSetIndex(e);if(r!==-1){const a=this.messageSets[r].messages.findIndex(o=>o.id===e.id);if(a!==-1){const o=t(this.messageSets[r].messages[a]);this.messageSets[r].messages[a]=o}}}if(n){const r=this.pinnedMessages.findIndex(a=>a.id===e.id);r!==-1&&(this.pinnedMessages[r]=t(this.pinnedMessages[r]))}}_addToMessageList(e,t,s=!1,i="created_at",n=!0){return Tn(e,t,s,i,n)}removeMessage(e){let t=!1;if(e.parent_id&&this.threads[e.parent_id]){const{removed:s,result:i}=this.removeMessageFromArray(this.threads[e.parent_id],e);this.threads[e.parent_id]=i,t=s}else{const s=e.messageSetIndex??this.findMessageSetIndex(e);if(s!==-1){const{removed:i,result:n}=this.removeMessageFromArray(this.messageSets[s].messages,e);this.messageSets[s].messages=n,t=i}}return t}filterErrorMessages(){const e=this.latestMessages.filter(t=>t.type!=="error");this.latestMessages=e}clean(){const e=new Date;for(const[t,s]of Object.entries(this.typing)){const i=typeof s.received_at=="string"?new Date(s.received_at):s.received_at||new Date;e.getTime()-i.getTime()>7e3&&(delete this.typing[t],this._channel.getClient().dispatchEvent({cid:this._channel.cid,type:"typing.stop",user:{id:t}}))}}clearMessages(){this.initMessages(),this.pinnedMessages=[]}initMessages(){this.messageSets=[{messages:[],isLatest:!0,isCurrent:!0,pagination:is}]}async loadMessageIntoState(e,t,s=25){let i,n=!1,r=!1;const a=t||e;if(e==="latest"){if(this.messages===this.latestMessages)return;i=this.messageSets.findIndex(o=>o.isLatest)}else i=this.findMessageSetIndex({id:a});i!==-1&&(this.switchToMessageSet(i),n=!0),r=!t||!!this.threads[t]?.find(o=>o.id===e),!(n&&r)&&(n||await this._channel.query({messages:{id_around:a,limit:s}},"new"),!r&&t&&await this._channel.getReplies(t,{id_around:e,limit:s}),i=this.findMessageSetIndex({id:a}),i!==-1&&this.switchToMessageSet(i))}findMessage(e,t){if(t){const i=this.threads[t];return i?i.find(n=>n.id===e):void 0}const s=this.findMessageSetIndex({id:e});if(s!==-1)return this.messageSets[s].messages.find(i=>i.id===e)}switchToMessageSet(e){const t=this.messageSets.find(s=>s.isCurrent);t&&(t.isCurrent=!1,this.messageSets[e].isCurrent=!0)}areMessageSetsOverlap(e,t){return e.some(s=>t.find(i=>s.id===i.id))}findMessageSetIndex(e){return this.messageSets.findIndex(t=>!!t.messages.find(s=>s.id===e.id))}findTargetMessageSet(e,t=!0,s="current"){let i=e,n;if(t){const r=this.messageSets.map((l,d)=>d).filter(l=>this.areMessageSetsOverlap(this.messageSets[l].messages,e));switch(s){case"new":r.length>0?n=r[0]:e.some(l=>!l.parent_id)&&(this.messageSets.push({messages:[],isCurrent:!1,isLatest:!1,pagination:is}),n=this.messageSets.length-1);break;case"current":n=this.messageSets.findIndex(l=>l.isCurrent);break;case"latest":n=this.messageSets.findIndex(l=>l.isLatest);break;default:n=-1}const a=r.splice(0,1)[0],o=[...r];if(a!==void 0&&a!==n&&o.push(n),o.length>0){const l=this.messageSets[a],d=this.messageSets.filter((h,f)=>o.indexOf(f)!==-1);d.forEach(h=>{l.isLatest=l.isLatest||h.isLatest,l.isCurrent=l.isCurrent||h.isCurrent,l.pagination.hasPrev=h.messages[0].created_at<l.messages[0].created_at?h.pagination.hasPrev:l.pagination.hasPrev,l.pagination.hasNext=l.messages.slice(-1)[0].created_at<h.messages.slice(-1)[0].created_at?h.pagination.hasNext:l.pagination.hasNext,i=[...i,...h.messages]}),d.forEach(h=>this.messageSets.splice(this.messageSets.indexOf(h),1)),n=this.messageSets.findIndex(h=>this.areMessageSetsOverlap(h.messages,e))}}else n=this.findMessageSetIndex(e[0]);return{targetMessageSetIndex:n,messagesToAdd:i}}},Po=e=>!!e?.og_scrape_url||!!e?.title_link,me=e=>!!e?.localMetadata?.id,Ud=e=>!!e?.localMetadata?.uploadState,Nn=(e,t=[])=>e.type==="file"||!!(e.mime_type&&t.indexOf(e.mime_type)===-1&&e.type!=="video"),Md=e=>Nn(e)&&me(e),Fn=e=>e.type==="image"&&!Po(e),qn=e=>Fn(e)&&me(e),Bn=e=>e.type==="audio",Ad=e=>Bn(e)&&me(e),$n=e=>e.type==="voiceRecording",Ld=e=>$n(e)&&me(e),Vn=(e,t=[])=>e.type==="video"||!!(e.mime_type&&t.indexOf(e.mime_type)!==-1),Td=e=>Vn(e)&&me(e),Oo=e=>Bn(e)||Nn(e)||Fn(e)||Vn(e)||$n(e),Id=e=>!!e.latitude&&!!e.longitude&&!!e.channel_cid,dt=e=>!!e.lastModified&&!("uri"in e),ko=e=>e==null||typeof e!="object"?!1:typeof FileList<"u"&&e instanceof FileList||"item"in e&&"length"in e&&!Array.isArray(e),No=e=>e instanceof Blob&&!(e instanceof File),te=e=>e!==null&&typeof e=="object"&&!dt(e)&&!No(e)&&typeof e.name=="string"&&typeof e.uri=="string"&&typeof e.size=="number"&&typeof e.type=="string",Hn=({blobsArray:e,fileName:t,mimeType:s})=>{const i=new Blob(e,{type:s});return new File([i],t,{type:i.type})},Fo=e=>e.match(/\/([^/;]+)/)?.[1],jn=e=>{const t=Fo(e);return`file_${new Date().toISOString()}${t?"."+t:""}`},Re=e=>{const t=e.type;return t.startsWith("image/")&&!t.endsWith(".photoshop")},qo=e=>e.startsWith("image/")&&!e.endsWith(".photoshop")?"image":e.includes("video/")?"video":e.includes("audio/")?"audio":"file",Ri=e=>{if(!e)return null;if(me(e))return e;const{localMetadata:t,...s}=e;return{localMetadata:{...t??{},id:t?.id||P()},...s}},Bo=()=>({id:"stream-io/attachment-manager-middleware/post-upload-enrichment",handlers:{postProcess:({state:e,discard:t,forward:s,next:i})=>{const{attachment:n,error:r,response:a}=e;if(r)return s();if(!n||!a)return t();const o={...n};return qn(n)?(n.localMetadata.previewUri&&(URL.revokeObjectURL(n.localMetadata.previewUri),delete o.localMetadata.previewUri),o.image_url=a.file):o.asset_url=a.file,a.thumb_url&&(o.thumb_url=a.thumb_url),i({...e,attachment:o})}}}),Wn=$o(Vo),xs=new Map;function $o(e){return function(s,i){const{cb:n,onContinued:r}=e(s,i),a=xs.get(s);a?.onContinued();const o=a?a.promise.then(n,n):n();return xs.set(s,{promise:o,onContinued:r}),o}}function Vo(e,t){const s=new AbortController;return{cb:()=>s.signal.aborted?Promise.resolve("canceled"):t(s.signal).finally(()=>{s.signal.aborted||xs.delete(e)}),onContinued:()=>s.abort()}}var ne=class{constructor(){this.middleware=[],this.id=P()}use(e){return this.middleware=this.middleware.concat(e),this}replace(e){const t=[...this.middleware];return e.forEach(s=>{const i=this.middleware.findIndex(n=>n.id===s.id);i>=0?t.splice(i,1,s):t.push(s)}),this.middleware=t,this}insert({middleware:e,position:t,unique:s}){s&&e.forEach(a=>{const o=this.middleware.findIndex(l=>l.id===a.id);o>=0&&this.middleware.splice(o,1)});const i=t.after||t.before,n=this.middleware.findIndex(a=>a.id===i),r=t.after?n+1:n;return this.middleware.splice(r,0,...e),this}setOrder(e){this.middleware=e.map(t=>this.middleware.find(s=>s.id===t)).filter(Boolean)}remove(e){!e&&!e.length||(this.middleware=this.middleware.filter(t=>typeof e=="string"?e!==t.id:!e.includes(t.id)))}async executeMiddlewareChain({eventName:e,initialValue:t,mode:s="cancelable"}){let i=-1;const n=async(a,o,l)=>{if(a<=i)throw new Error("next() called multiple times");if(i=a,a===this.middleware.length||l&&["complete","discard"].includes(l))return{state:o,status:l};const h=this.middleware[a].handlers[e];return h?await h({state:o,next:y=>n(a+1,y),complete:y=>n(a+1,y,"complete"),discard:()=>n(a+1,o,"discard"),forward:()=>n(a+1,o)}):n(a+1,o,l)},r=s==="cancelable"?await Wn(`middleware-execution-${this.id}-${e}`,async a=>{const o=await n(0,t);return a.aborted?"canceled":o}):await n(0,t);return r==="canceled"?{state:t,status:"discard"}:r}async execute({eventName:e,initialValue:t,mode:s}){return await this.executeMiddlewareChain({eventName:e,initialValue:t,mode:s})}},Ho=e=>({id:"stream-io/attachment-manager-middleware/upload-error",handlers:{postProcess:({state:t,discard:s,forward:i})=>{const{attachment:n,error:r}=t;if(!r)return i();if(!n)return s();const a=r instanceof Error?r.message:"unknown error";return e.client.notifications.addError({message:"Error uploading attachment",origin:{emitter:"AttachmentManager",context:{attachment:n}},options:{type:"api:attachment:upload:failed",metadata:{reason:a},originalError:r}}),i()}}}),jo=class extends ne{constructor({composer:e}){super(),this.use([Ho(e),Bo()])}},Wo=e=>({id:"stream-io/attachment-manager-middleware/file-upload-config-check",handlers:{prepare:async({state:t,next:s,discard:i})=>{const{attachmentManager:n}=e;if(!n||!t.attachment)return i();const r=await n.getUploadConfigCheck(t.attachment.localMetadata.file),a={...t.attachment,localMetadata:{...t.attachment.localMetadata,uploadPermissionCheck:r,uploadState:r.uploadBlocked?"blocked":"pending"}};return s({...t,attachment:a})}}}),zo=e=>({id:"stream-io/attachment-manager-middleware/blocked-upload-notification",handlers:{prepare:({state:{attachment:t},forward:s})=>(t&&t.localMetadata.uploadPermissionCheck?.uploadBlocked&&e.client.notifications.addError({message:"The attachment upload was blocked",origin:{emitter:"AttachmentManager",context:{blockedAttachment:t}},options:{type:"validation:attachment:upload:blocked",metadata:{reason:t.localMetadata.uploadPermissionCheck?.reason}}}),s())}}),Qo=class extends ne{constructor({composer:e}){super(),this.use([Wo(e),zo(e)])}},zn=e=>typeof e=="function",Go=()=>{},x=class{constructor(e){this.value=e,this.handlers=new Set,this.preprocessors=new Set,this.partialNext=t=>this.next(s=>({...s,...t})),this.subscribeWithSelector=(t,s)=>{let i;const n=r=>{const a=t(r);let o=typeof i>"u";for(const d in i)if(i[d]!==a[d]){o=!0;break}if(!o)return;const l=i;i=a,s(a,l)};return this.subscribe(n)}}merge(e){return new Jo({original:this,merged:e})}next(e){const t=zn(e)?e(this.value):e;if(t===this.value)return;this.preprocessors.forEach(i=>i(t,this.value));const s=this.value;this.value=t,this.handlers.forEach(i=>i(this.value,s))}getLatestValue(){return this.value}subscribe(e){return e(this.value,void 0),this.handlers.add(e),()=>{this.handlers.delete(e)}}addPreprocessor(e){return this.preprocessors.add(e),()=>{this.preprocessors.delete(e)}}},Jo=class tt extends x{constructor({original:t,merged:s}){const i=t.getLatestValue(),n=s.getLatestValue();super({...i,...n}),this.next=()=>{console.warn(`${tt.name}.next is disabled, call original.next or merged.next instead`)},this.partialNext=()=>{console.warn(`${tt.name}.partialNext is disabled, call original.partialNext or merged.partialNext instead`)},this.cachedOriginalValue=i,this.cachedMergedValue=n,this.original=t,this.merged=s}subscribe(t){const s=[];if(!this.handlers.size){const i=n=>{super.next(r=>({...r,...n}))};s.push(this.original.subscribe(n=>{n!==this.cachedOriginalValue&&(this.cachedOriginalValue=n,i(n))}),this.merged.subscribe(n=>{n!==this.cachedMergedValue&&(this.cachedMergedValue=n,i(n))}))}return s.push(super.subscribe(t)),()=>{s.forEach(i=>i())}}getLatestValue(){if(!this.handlers.size){const t=this.original.getLatestValue(),s=this.merged.getLatestValue();(t!==this.cachedOriginalValue||s!==this.cachedMergedValue)&&(this.value={...t,...s},this.cachedMergedValue=s,this.cachedOriginalValue=t)}return super.getLatestValue()}addPreprocessor(){return console.warn(`${tt.name}.addPreprocessor is disabled, call original.addPreprocessor or merged.addPreprocessor instead`),Go}},ie=e=>{if(!e||typeof e!="object"||Array.isArray(e))return!1;const t=Object.getPrototypeOf(e);return t===null||t===Object.prototype?!1:e.constructor&&e.constructor!==Object},Us=(e,t,s=new Set,i=new WeakSet,n=new WeakSet)=>{if(e===t)return!0;if(e==null||t==null)return!1;const r=typeof e;if(r!==typeof t)return!1;if(r!=="object")return e!==e&&t!==t?!0:e===t;const o=e,l=t;if(i.has(o)||n.has(l))return i.has(o)&&n.has(l);if(i.add(o),n.add(l),e instanceof Date&&t instanceof Date)return i.delete(o),n.delete(l),e.getTime()===t.getTime();if(e instanceof RegExp&&t instanceof RegExp)return i.delete(o),n.delete(l),e.toString()===t.toString();if(ie(e)||ie(t))return i.delete(o),n.delete(l),!1;const d=Array.isArray(e),c=Array.isArray(t);if(d!==c)return i.delete(o),n.delete(l),!1;if(d&&c){const y=e,b=t;if(y.length!==b.length)return i.delete(o),n.delete(l),!1;const w=[e,t];if(s.has(w))return i.delete(o),n.delete(l),!0;s.add(w);for(let v=0;v<y.length;v++)if(!Us(y[v],b[v],s,i,n))return s.delete(w),i.delete(o),n.delete(l),!1;return s.delete(w),i.delete(o),n.delete(l),!0}const h=e,f=t,m=Object.keys(h),u=Object.keys(f);if(m.length!==u.length)return i.delete(o),n.delete(l),!1;for(const y of u)if(!Object.prototype.hasOwnProperty.call(h,y))return i.delete(o),n.delete(l),!1;const p=[e,t];if(s.has(p))return i.delete(o),n.delete(l),!0;s.add(p);for(const y of m)if(!Us(h[y],f[y],s,i,n))return s.delete(p),i.delete(o),n.delete(l),!1;return s.delete(p),i.delete(o),n.delete(l),!0};function Ko(e,t){const s={children:{}};return Qn(e,t,s),Js(s)}function Qn(e,t,s,i,n=new Set,r=new Set){if(Us(e,t,new Set(n)))return;if(e==null){i!==void 0&&(s.children[String(i)]={type:"added",value:t,children:{}});return}if(typeof e=="object"&&e!==null){if(r.has(e)){i!==void 0&&(s.children[String(i)]={type:"circular",value:t,oldValue:e,children:{}});return}r.add(e)}if(typeof e!="object"||typeof t!="object"||e===null||t===null||Array.isArray(e)!==Array.isArray(t)||ie(e)||ie(t)){i!==void 0&&(s.children[String(i)]={type:"updated",value:t,oldValue:e,children:{}}),typeof e=="object"&&e!==null&&r.delete(e);return}const o=e,l=t,d=i!==void 0?{type:"updated",children:{},oldValue:e,value:t}:s;i!==void 0&&(s.children[String(i)]=d);const c=[e,t];if(n.has(c)){typeof e=="object"&&e!==null&&r.delete(e);return}n.add(c);const h=new Set([...Object.keys(o),...Object.getOwnPropertySymbols(o),...Object.keys(l),...Object.getOwnPropertySymbols(l)]);for(const f of h){const m=o[f],u=l[f];if(f in l){if(!(f in o)){d.children[String(f)]={type:"added",value:u,children:{}};continue}Qn(m,u,d,f,n,r)}}n.delete(c),typeof e=="object"&&e!==null&&r.delete(e)}function Gn(e={}){const{trackDiff:t=!1}=e;return function({target:i,source:n,customizer:r}){const a=Array.isArray(n)?n:[n],o=t?structuredClone(i):void 0;function l(y,b,w,v,C,S){const U=r?.(y,b,w,v,C,S);return U!==void 0?(Object.defineProperty(v,w,{value:U,enumerable:!0,writable:!0,configurable:!0}),!0):!1}function d(y,b){if(y===null||typeof y>"u"||!Array.isArray(y)&&typeof y!="object")return b;if(y&&typeof y=="object"){const w=ie(y),v=ie(b);return w||v?v?b:y:Array.isArray(y)?[...y]:{...y}}return Array.isArray(b)?[]:{}}function c(y,b,w,v,C){const S=b[w],U=y[w];if(!l(U,S,w,y,b,v))if(S&&typeof S=="object"){if(!v.has(S)){const Y=d(U,S);if(Object.defineProperty(y,w,{value:Y,enumerable:!0,writable:!0,configurable:!0}),ie(Y))return;C.push({target:Y,source:S,sourceKey:w,parentTarget:y})}}else S!==void 0&&(y[w]=S)}function h(y,b,w,v){const C=[...Object.keys(b),...Object.getOwnPropertySymbols(b)];for(const S of C)c(y,b,S,w,v)}function f({target:y,source:b,sourceKey:w,parentTarget:v},C,S){if(C.has(b)){t&&w&&v&&Object.defineProperty(v,w,{value:y,enumerable:!0,writable:!0,configurable:!0});return}!C.has(y)&&!C.has(b)&&(C.add(y),C.add(b),h(y,b,C,S),C.delete(b),C.delete(y))}function m(y,b,w=new Set){if(w.has(y)||w.has(b))return{...y};const v={...y},C=[];for(w.add(v),w.add(b),h(v,b,w,C);C.length;)f(C.pop(),w,C);return w.delete(b),w.delete(v),v}const u=a.reduce((y,b)=>m(y,b),{...i}),p=t&&o?Ko(o,u):null;return{result:u,diff:p}}}function Js(e){const t={};let s=!1;for(const i in e.children){const n=Js(e.children[i]);n&&(t[i]=n,s=!0)}return e.type||s?{...e,children:t}:null}function he(e,t,s){return Gn()({target:e,source:t,customizer:s}).result}function Jn(e,t,s){const i=Gn({trackDiff:!0}),{result:n,diff:r}=i({target:e,source:t,customizer:s});return{result:n,diff:Js(r??{children:{}})||{children:{}}}}var Ei=({message:e})=>({attachments:(e?.attachments??[])?.filter(({og_scrape_url:t})=>!t).map(t=>{const s=Oo(t)?{id:P(),uploadState:"finished"}:{id:P()};return{...t,localMetadata:s}})}),Kn=class Ms{constructor({composer:t,message:s}){this.setCustomUploadFn=i=>{this.composer.updateConfig({attachments:{doUploadRequest:i}})},this.initState=({message:i}={})=>{this.state.next(Ei({message:i}))},this.getAttachmentIndex=i=>{const n=this.attachmentsById;return this.attachments.indexOf(n[i])},this.prepareAttachmentUpdate=i=>{const n=this.attachments,r=[...this.attachments],a=this.getAttachmentIndex(i.localMetadata.id);if(a===-1)return null;const o=Jn(n[a],i);if(o.diff&&Object.keys(o.diff.children).length){const d=Ri(o.result);if(d)return r.splice(a,1,d),r}return null},this.updateAttachment=i=>{const n=this.prepareAttachmentUpdate(i);n&&this.state.partialNext({attachments:n})},this.upsertAttachments=i=>{if(!i.length)return;let n=[...this.attachments],r=!1;i.forEach(a=>{const o=this.prepareAttachmentUpdate(a);if(o)n=o,r=!0;else{const l=Ri(a);l&&(n.push(l),r=!0)}}),r&&this.state.partialNext({attachments:n})},this.removeAttachments=i=>{this.state.partialNext({attachments:this.attachments.filter(n=>!i.includes(n.localMetadata?.id))})},this.getUploadConfigCheck=async i=>{const n=this.channel.getClient();let r;n.appSettingsPromise?r=await n.appSettingsPromise:r=await n.getAppSettings();const a=Re(i)?r?.app?.image_upload_config:r?.app?.file_upload_config;if(!a)return{uploadBlocked:!1};const{allowed_file_extensions:o,allowed_mime_types:l,blocked_file_extensions:d,blocked_mime_types:c,size_limit:h}=a,f=h||io,m=i.type;if(dt(i)||te(i)){if(o?.length&&!o.some(u=>i.name.toLowerCase().endsWith(u.toLowerCase())))return{uploadBlocked:!0,reason:"allowed_file_extensions"};if(d?.length&&d.some(u=>i.name.toLowerCase().endsWith(u.toLowerCase())))return{uploadBlocked:!0,reason:"blocked_file_extensions"}}return l?.length&&!l.some(u=>u.toLowerCase()===m?.toLowerCase())?{uploadBlocked:!0,reason:"allowed_mime_types"}:c?.length&&c.some(u=>u.toLowerCase()===m?.toLowerCase())?{uploadBlocked:!0,reason:"blocked_mime_types"}:i.size&&i.size>f?{uploadBlocked:!0,reason:"size_limit"}:{uploadBlocked:!1}},this.fileToLocalUploadAttachment=async i=>{const n=Ms.toLocalUploadAttachment(i),r=await this.getUploadConfigCheck(n.localMetadata.file);return n.localMetadata.uploadPermissionCheck=r,n.localMetadata.uploadState=r.uploadBlocked?"blocked":"pending",n},this.ensureLocalUploadAttachment=async i=>{if(!i.localMetadata?.file){this.client.notifications.addError({message:"File is required for upload attachment",origin:{emitter:"AttachmentManager",context:{attachment:i}},options:{type:"validation:attachment:file:missing"}});return}if(!i.localMetadata.id){this.client.notifications.addError({message:"Local upload attachment missing local id",origin:{emitter:"AttachmentManager",context:{attachment:i}},options:{type:"validation:attachment:id:missing"}});return}if(!this.fileUploadFilter(i))return;const n=await this.fileToLocalUploadAttachment(i.localMetadata.file);return i.localMetadata.id&&(n.localMetadata.id=i.localMetadata.id),n},this.doDefaultUploadRequest=async i=>{if(te(i))return this.channel[Re(i)?"sendImage":"sendFile"](i.uri,i.name,i.type);const n=dt(i)?i:Hn({blobsArray:[i],fileName:jn(i.type),mimeType:i.type}),{duration:r,...a}=await this.channel[Re(i)?"sendImage":"sendFile"](n);return a},this.doUploadRequest=async i=>{const n=this.config.doUploadRequest;return n?await n(i):this.doDefaultUploadRequest(i)},this.uploadAttachment=async i=>{if(!this.isUploadEnabled)return;const n=await this.ensureLocalUploadAttachment(i);if(typeof n>"u")return;if(n.localMetadata.uploadState==="blocked")return this.upsertAttachments([n]),this.client.notifications.addError({message:"The attachment upload was blocked",origin:{emitter:"AttachmentManager",context:{attachment:i,blockedAttachment:n}},options:{type:"validation:attachment:upload:blocked",metadata:{reason:n.localMetadata.uploadPermissionCheck?.reason}}}),n;this.upsertAttachments([{...i,localMetadata:{...i.localMetadata,uploadState:"uploading"}}]);let r;try{r=await this.doUploadRequest(n.localMetadata.file)}catch(o){const l=o instanceof Error?o.message:"unknown error",d={...i,localMetadata:{...i.localMetadata,uploadState:"failed"}};return this.client.notifications.addError({message:"Error uploading attachment",origin:{emitter:"AttachmentManager",context:{attachment:i,failedAttachment:d}},options:{type:"api:attachment:upload:failed",metadata:{reason:l},originalError:o instanceof Error?o:void 0}}),this.updateAttachment(d),d}if(!r){this.removeAttachments([i.localMetadata.id]);return}const a={...i,localMetadata:{...i.localMetadata,uploadState:"finished"}};return qn(a)?(a.localMetadata.previewUri&&(URL.revokeObjectURL(a.localMetadata.previewUri),delete a.localMetadata.previewUri),a.image_url=r.file):a.asset_url=r.file,r.thumb_url&&(a.thumb_url=r.thumb_url),this.updateAttachment(a),a},this.uploadFile=async i=>{const n=await this.preUploadMiddlewareExecutor.execute({eventName:"prepare",initialValue:{attachment:Ms.toLocalUploadAttachment(i)},mode:"concurrent"});let r=n.state.attachment;if(n.status==="discard"||!this.fileUploadFilter(r))return r;if(r.localMetadata.uploadState==="blocked")return this.upsertAttachments([r]),n.state.attachment;r={...r,localMetadata:{...r.localMetadata,uploadState:"uploading"}},this.upsertAttachments([r]);let a,o;try{a=await this.doUploadRequest(i)}catch(d){o=d instanceof Error?d:void 0}const l=await this.postUploadMiddlewareExecutor.execute({eventName:"postProcess",initialValue:{attachment:{...r,localMetadata:{...r.localMetadata,uploadState:o?"failed":"finished"}},error:o,response:a},mode:"concurrent"});return r=l.state.attachment,l.status==="discard"?(this.removeAttachments([r.localMetadata.id]),r):(this.updateAttachment(r),r)},this.uploadFiles=async i=>{if(!this.isUploadEnabled)return;const n=ko(i)?Array.from(i):i;return await Promise.all(n.slice(0,this.availableUploadSlots).map(this.uploadFile))},this.composer=t,this.state=new x(Ei({message:s})),this.attachmentsByIdGetterCache={attachmentsById:{},attachments:[]},this.preUploadMiddlewareExecutor=new Qo({composer:t}),this.postUploadMiddlewareExecutor=new jo({composer:t})}get attachmentsById(){const{attachments:t}=this.state.getLatestValue();return t!==this.attachmentsByIdGetterCache.attachments&&(this.attachmentsByIdGetterCache.attachments=t,this.attachmentsByIdGetterCache.attachmentsById=t.reduce((s,i)=>{var n;return i.localMetadata.id&&(s[n=i.localMetadata.id]??(s[n]=i)),s},{})),this.attachmentsByIdGetterCache.attachmentsById}get client(){return this.composer.client}get channel(){return this.composer.channel}get config(){return this.composer.config.attachments}get acceptedFiles(){return this.config.acceptedFiles}set acceptedFiles(t){this.composer.updateConfig({attachments:{acceptedFiles:t}})}get fileUploadFilter(){return this.config.fileUploadFilter}set fileUploadFilter(t){this.composer.updateConfig({attachments:{fileUploadFilter:t}})}get maxNumberOfFilesPerMessage(){return this.config.maxNumberOfFilesPerMessage}set maxNumberOfFilesPerMessage(t){t!==this.maxNumberOfFilesPerMessage&&this.composer.updateConfig({attachments:{maxNumberOfFilesPerMessage:t}})}get attachments(){return this.state.getLatestValue().attachments}get hasUploadPermission(){return!!this.channel.data?.own_capabilities?.includes("upload-file")}get isUploadEnabled(){return this.hasUploadPermission&&this.availableUploadSlots>0}get successfulUploads(){return this.getUploadsByState("finished")}get successfulUploadsCount(){return this.successfulUploads.length}get uploadsInProgressCount(){return this.getUploadsByState("uploading").length}get failedUploadsCount(){return this.getUploadsByState("failed").length}get blockedUploadsCount(){return this.getUploadsByState("blocked").length}get pendingUploadsCount(){return this.getUploadsByState("pending").length}get availableUploadSlots(){return this.config.maxNumberOfFilesPerMessage-this.successfulUploadsCount-this.uploadsInProgressCount}getUploadsByState(t){return Object.values(this.attachments).filter(({localMetadata:s})=>s.uploadState===t)}};Kn.toLocalUploadAttachment=e=>{const t=te(e)||dt(e)?e:Hn({blobsArray:[e],fileName:jn(e.type),mimeType:e.type}),s={file_size:t.size,mime_type:t.type,localMetadata:{file:t,id:P(),uploadState:"pending"},type:qo(t.type)};return s[Re(t)?"fallback":"title"]=t.name,Re(t)&&(s.localMetadata.previewUri=te(e)?e.uri:URL.createObjectURL?.(e),te(e)&&e.height&&e.width&&(s.original_height=e.height,s.original_width=e.width)),te(e)&&e.thumb_url&&(s.thumb_url=e.thumb_url),te(e)&&e.duration&&(s.duration=e.duration),s};var Yo=Kn,Xo="aaa1rp3bb0ott3vie4c1le2ogado5udhabi7c0ademy5centure6ountant0s9o1tor4d0s1ult4e0g1ro2tna4f0l1rica5g0akhan5ency5i0g1rbus3force5tel5kdn3l0ibaba4pay4lfinanz6state5y2sace3tom5m0azon4ericanexpress7family11x2fam3ica3sterdam8nalytics7droid5quan4z2o0l2partments8p0le4q0uarelle8r0ab1mco4chi3my2pa2t0e3s0da2ia2sociates9t0hleta5torney7u0ction5di0ble3o3spost5thor3o0s4w0s2x0a2z0ure5ba0by2idu3namex4d1k2r0celona5laycard4s5efoot5gains6seball5ketball8uhaus5yern5b0c1t1va3cg1n2d1e0ats2uty4er2rlin4st0buy5t2f1g1h0arti5i0ble3d1ke2ng0o3o1z2j1lack0friday9ockbuster8g1omberg7ue3m0s1w2n0pparibas9o0ats3ehringer8fa2m1nd2o0k0ing5sch2tik2on4t1utique6x2r0adesco6idgestone9oadway5ker3ther5ussels7s1t1uild0ers6siness6y1zz3v1w1y1z0h3ca0b1fe2l0l1vinklein9m0era3p2non3petown5ital0one8r0avan4ds2e0er0s4s2sa1e1h1ino4t0ering5holic7ba1n1re3c1d1enter4o1rn3f0a1d2g1h0anel2nel4rity4se2t2eap3intai5ristmas6ome4urch5i0priani6rcle4sco3tadel4i0c2y3k1l0aims4eaning6ick2nic1que6othing5ud3ub0med6m1n1o0ach3des3ffee4llege4ogne5m0mbank4unity6pany2re3uter5sec4ndos3struction8ulting7tact3ractors9oking4l1p2rsica5untry4pon0s4rses6pa2r0edit0card4union9icket5own3s1uise0s6u0isinella9v1w1x1y0mru3ou3z2dad1nce3ta1e1ing3sun4y2clk3ds2e0al0er2s3gree4livery5l1oitte5ta3mocrat6ntal2ist5si0gn4v2hl2iamonds6et2gital5rect0ory7scount3ver5h2y2j1k1m1np2o0cs1tor4g1mains5t1wnload7rive4tv2ubai3nlop4pont4rban5vag2r2z2earth3t2c0o2deka3u0cation8e1g1mail3erck5nergy4gineer0ing9terprises10pson4quipment8r0icsson6ni3s0q1tate5t1u0rovision8s2vents5xchange6pert3osed4ress5traspace10fage2il1rwinds6th3mily4n0s2rm0ers5shion4t3edex3edback6rrari3ero6i0delity5o2lm2nal1nce1ial7re0stone6mdale6sh0ing5t0ness6j1k1lickr3ghts4r2orist4wers5y2m1o0o0d1tball6rd1ex2sale4um3undation8x2r0ee1senius7l1ogans4ntier7tr2ujitsu5n0d2rniture7tbol5yi3ga0l0lery3o1up4me0s3p1rden4y2b0iz3d0n2e0a1nt0ing5orge5f1g0ee3h1i0ft0s3ves2ing5l0ass3e1obal2o4m0ail3bh2o1x2n1odaddy5ld0point6f2o0dyear5g0le4p1t1v2p1q1r0ainger5phics5tis4een3ipe3ocery4up4s1t1u0cci3ge2ide2tars5ru3w1y2hair2mburg5ngout5us3bo2dfc0bank7ealth0care8lp1sinki6re1mes5iphop4samitsu7tachi5v2k0t2m1n1ockey4ldings5iday5medepot5goods5s0ense7nda3rse3spital5t0ing5t0els3mail5use3w2r1sbc3t1u0ghes5yatt3undai7ibm2cbc2e1u2d1e0ee3fm2kano4l1m0amat4db2mo0bilien9n0c1dustries8finiti5o2g1k1stitute6urance4e4t0ernational10uit4vestments10o1piranga7q1r0ish4s0maili5t0anbul7t0au2v3jaguar4va3cb2e0ep2tzt3welry6io2ll2m0p2nj2o0bs1urg4t1y2p0morgan6rs3uegos4niper7kaufen5ddi3e0rryhotels6properties14fh2g1h1i0a1ds2m1ndle4tchen5wi3m1n1oeln3matsu5sher5p0mg2n2r0d1ed3uokgroup8w1y0oto4z2la0caixa5mborghini8er3nd0rover6xess5salle5t0ino3robe5w0yer5b1c1ds2ease3clerc5frak4gal2o2xus4gbt3i0dl2fe0insurance9style7ghting6ke2lly3mited4o2ncoln4k2ve1ing5k1lc1p2oan0s3cker3us3l1ndon4tte1o3ve3pl0financial11r1s1t0d0a3u0ndbeck6xe1ury5v1y2ma0drid4if1son4keup4n0agement7go3p1rket0ing3s4riott5shalls7ttel5ba2c0kinsey7d1e0d0ia3et2lbourne7me1orial6n0u2rckmsd7g1h1iami3crosoft7l1ni1t2t0subishi9k1l0b1s2m0a2n1o0bi0le4da2e1i1m1nash3ey2ster5rmon3tgage6scow4to0rcycles9v0ie4p1q1r1s0d2t0n1r2u0seum3ic4v1w1x1y1z2na0b1goya4me2vy3ba2c1e0c1t0bank4flix4work5ustar5w0s2xt0direct7us4f0l2g0o2hk2i0co2ke1on3nja3ssan1y5l1o0kia3rton4w0ruz3tv4p1r0a1w2tt2u1yc2z2obi1server7ffice5kinawa6layan0group9lo3m0ega4ne1g1l0ine5oo2pen3racle3nge4g0anic5igins6saka4tsuka4t2vh3pa0ge2nasonic7ris2s1tners4s1y3y2ccw3e0t2f0izer5g1h0armacy6d1ilips5one2to0graphy6s4ysio5ics1tet2ures6d1n0g1k2oneer5zza4k1l0ace2y0station9umbing5s3m1n0c2ohl2ker3litie5rn2st3r0axi3ess3ime3o0d0uctions8f1gressive8mo2perties3y5tection8u0dential9s1t1ub2w0c2y2qa1pon3uebec3st5racing4dio4e0ad1lestate6tor2y4cipes5d0stone5umbrella9hab3ise0n3t2liance6n0t0als5pair3ort3ublican8st0aurant8view0s5xroth6ich0ardli6oh3l1o1p2o0cks3deo3gers4om3s0vp3u0gby3hr2n2w0e2yukyu6sa0arland6fe0ty4kura4le1on3msclub4ung5ndvik0coromant12ofi4p1rl2s1ve2xo3b0i1s2c0b1haeffler7midt4olarships8ol3ule3warz5ience5ot3d1e0arch3t2cure1ity6ek2lect4ner3rvices6ven3w1x0y3fr2g1h0angrila6rp3ell3ia1ksha5oes2p0ping5uji3w3i0lk2na1gles5te3j1k0i0n2y0pe4l0ing4m0art3ile4n0cf3o0ccer3ial4ftbank4ware6hu2lar2utions7ng1y2y2pa0ce3ort2t3r0l2s1t0ada2ples4r1tebank4farm7c0group6ockholm6rage3e3ream4udio2y3yle4u0cks3pplies3y2ort5rf1gery5zuki5v1watch4iss4x1y0dney4stems6z2tab1ipei4lk2obao4rget4tamotors6r2too4x0i3c0i2d0k2eam2ch0nology8l1masek5nnis4va3f1g1h0d1eater2re6iaa2ckets5enda4ps2res2ol4j0maxx4x2k0maxx5l1m0all4n1o0day3kyo3ols3p1ray3shiba5tal3urs3wn2yota3s3r0ade1ing4ining5vel0ers0insurance16ust3v2t1ube2i1nes3shu4v0s2w1z2ua1bank3s2g1k1nicom3versity8o2ol2ps2s1y1z2va0cations7na1guard7c1e0gas3ntures6risign5mögensberater2ung14sicherung10t2g1i0ajes4deo3g1king4llas4n1p1rgin4sa1ion4va1o3laanderen9n1odka3lvo3te1ing3o2yage5u2wales2mart4ter4ng0gou5tch0es6eather0channel12bcam3er2site5d0ding5ibo2r3f1hoswho6ien2ki2lliamhill9n0dows4e1ners6me2olterskluwer11odside6rk0s2ld3w2s1tc1f3xbox3erox4ihuan4n2xx2yz3yachts4hoo3maxun5ndex5e1odobashi7ga2kohama6u0tube6t1un3za0ppos4ra3ero3ip2m1one3uerich6w2",Zo="ελ1υ2бг1ел3дети4ею2католик6ом3мкд2он1сква6онлайн5рг3рус2ф2сайт3рб3укр3қаз3հայ3ישראל5קום3ابوظبي5رامكو5لاردن4بحرين5جزائر5سعودية6عليان5مغرب5مارات5یران5بارت2زار4يتك3ھارت5تونس4سودان3رية5شبكة4عراق2ب2مان4فلسطين6قطر3كاثوليك6وم3مصر2ليسيا5وريتانيا7قع4همراه5پاکستان7ڀارت4कॉम3नेट3भारत0म्3ोत5संगठन5বাংলা5ভারত2ৰত4ਭਾਰਤ4ભારત4ଭାରତ4இந்தியா6லங்கை6சிங்கப்பூர்11భారత్5ಭಾರತ4ഭാരതം5ලංකා4คอม3ไทย3ລາວ3გე2みんな3アマゾン4クラウド4グーグル4コム2ストア3セール3ファッション6ポイント4世界2中信1国1國1文网3亚马逊3企业2佛山2信息2健康2八卦2公司1益2台湾1灣2商城1店1标2嘉里0大酒店5在线2大拿2天主教3娱乐2家電2广东2微博2慈善2我爱你3手机2招聘2政务1府2新加坡2闻2时尚2書籍2机构2淡马锡3游戏2澳門2点看2移动2组织机构4网址1店1站1络2联通2谷歌2购物2通販2集团2電訊盈科4飞利浦3食品2餐厅2香格里拉3港2닷넷1컴2삼성2한국2",As="numeric",Ls="ascii",Ts="alpha",Ee="asciinumeric",Se="alphanumeric",Is="domain",Yn="emoji",el="scheme",tl="slashscheme",as="whitespace";function sl(e,t){return e in t||(t[e]=[]),t[e]}function se(e,t,s){t[As]&&(t[Ee]=!0,t[Se]=!0),t[Ls]&&(t[Ee]=!0,t[Ts]=!0),t[Ee]&&(t[Se]=!0),t[Ts]&&(t[Se]=!0),t[Se]&&(t[Is]=!0),t[Yn]&&(t[Is]=!0);for(const i in t){const n=sl(i,s);n.indexOf(e)<0&&n.push(e)}}function il(e,t){const s={};for(const i in t)t[i].indexOf(e)>=0&&(s[i]=!0);return s}function D(e=null){this.j={},this.jr=[],this.jd=null,this.t=e}D.groups={};D.prototype={accepts(){return!!this.t},go(e){const t=this,s=t.j[e];if(s)return s;for(let i=0;i<t.jr.length;i++){const n=t.jr[i][0],r=t.jr[i][1];if(r&&n.test(e))return r}return t.jd},has(e,t=!1){return t?e in this.j:!!this.go(e)},ta(e,t,s,i){for(let n=0;n<e.length;n++)this.tt(e[n],t,s,i)},tr(e,t,s,i){i=i||D.groups;let n;return t&&t.j?n=t:(n=new D(t),s&&i&&se(t,s,i)),this.jr.push([e,n]),n},ts(e,t,s,i){let n=this;const r=e.length;if(!r)return n;for(let a=0;a<r-1;a++)n=n.tt(e[a]);return n.tt(e[r-1],t,s,i)},tt(e,t,s,i){i=i||D.groups;const n=this;if(t&&t.j)return n.j[e]=t,t;const r=t;let a,o=n.go(e);if(o?(a=new D,Object.assign(a.j,o.j),a.jr.push.apply(a.jr,o.jr),a.jd=o.jd,a.t=o.t):a=new D,r){if(i)if(a.t&&typeof a.t=="string"){const l=Object.assign(il(a.t,i),s);se(r,l,i)}else s&&se(r,s,i);a.t=r}return n.j[e]=a,a}};var R=(e,t,s,i,n)=>e.ta(t,s,i,n),M=(e,t,s,i,n)=>e.tr(t,s,i,n),xi=(e,t,s,i,n)=>e.ts(t,s,i,n),_=(e,t,s,i,n)=>e.tt(t,s,i,n),j="WORD",Ds="UWORD",Xn="ASCIINUMERICAL",Zn="ALPHANUMERICAL",Ne="LOCALHOST",Ps="TLD",Os="UTLD",st="SCHEME",le="SLASH_SCHEME",Ks="NUM",ks="WS",Ys="NL",xe="OPENBRACE",Ue="CLOSEBRACE",ht="OPENBRACKET",ut="CLOSEBRACKET",ft="OPENPAREN",pt="CLOSEPAREN",gt="OPENANGLEBRACKET",mt="CLOSEANGLEBRACKET",yt="FULLWIDTHLEFTPAREN",_t="FULLWIDTHRIGHTPAREN",wt="LEFTCORNERBRACKET",bt="RIGHTCORNERBRACKET",vt="LEFTWHITECORNERBRACKET",Ct="RIGHTWHITECORNERBRACKET",St="FULLWIDTHLESSTHAN",Rt="FULLWIDTHGREATERTHAN",Et="AMPERSAND",xt="APOSTROPHE",Ut="ASTERISK",G="AT",Mt="BACKSLASH",At="BACKTICK",Lt="CARET",J="COLON",Xs="COMMA",Tt="DOLLAR",F="DOT",It="EQUALS",Zs="EXCLAMATION",k="HYPHEN",Me="PERCENT",Dt="PIPE",Pt="PLUS",Ot="POUND",Ae="QUERY",ei="QUOTE",er="FULLWIDTHMIDDLEDOT",ti="SEMI",q="SLASH",Le="TILDE",kt="UNDERSCORE",tr="EMOJI",Nt="SYM",sr=Object.freeze({__proto__:null,ALPHANUMERICAL:Zn,AMPERSAND:Et,APOSTROPHE:xt,ASCIINUMERICAL:Xn,ASTERISK:Ut,AT:G,BACKSLASH:Mt,BACKTICK:At,CARET:Lt,CLOSEANGLEBRACKET:mt,CLOSEBRACE:Ue,CLOSEBRACKET:ut,CLOSEPAREN:pt,COLON:J,COMMA:Xs,DOLLAR:Tt,DOT:F,EMOJI:tr,EQUALS:It,EXCLAMATION:Zs,FULLWIDTHGREATERTHAN:Rt,FULLWIDTHLEFTPAREN:yt,FULLWIDTHLESSTHAN:St,FULLWIDTHMIDDLEDOT:er,FULLWIDTHRIGHTPAREN:_t,HYPHEN:k,LEFTCORNERBRACKET:wt,LEFTWHITECORNERBRACKET:vt,LOCALHOST:Ne,NL:Ys,NUM:Ks,OPENANGLEBRACKET:gt,OPENBRACE:xe,OPENBRACKET:ht,OPENPAREN:ft,PERCENT:Me,PIPE:Dt,PLUS:Pt,POUND:Ot,QUERY:Ae,QUOTE:ei,RIGHTCORNERBRACKET:bt,RIGHTWHITECORNERBRACKET:Ct,SCHEME:st,SEMI:ti,SLASH:q,SLASH_SCHEME:le,SYM:Nt,TILDE:Le,TLD:Ps,UNDERSCORE:kt,UTLD:Os,UWORD:Ds,WORD:j,WS:ks}),V=/[a-z]/,be=new RegExp("\\p{L}","u"),os=new RegExp("\\p{Emoji}","u"),H=/\d/,ls=/\s/,Ui="\r",cs=`
`,nl="️",rl="‍",ds="￼",Qe=null,Ge=null;function al(e=[]){const t={};D.groups=t;const s=new D;Qe==null&&(Qe=Mi(Xo)),Ge==null&&(Ge=Mi(Zo)),_(s,"'",xt),_(s,"{",xe),_(s,"}",Ue),_(s,"[",ht),_(s,"]",ut),_(s,"(",ft),_(s,")",pt),_(s,"<",gt),_(s,">",mt),_(s,"（",yt),_(s,"）",_t),_(s,"「",wt),_(s,"」",bt),_(s,"『",vt),_(s,"』",Ct),_(s,"＜",St),_(s,"＞",Rt),_(s,"&",Et),_(s,"*",Ut),_(s,"@",G),_(s,"`",At),_(s,"^",Lt),_(s,":",J),_(s,",",Xs),_(s,"$",Tt),_(s,".",F),_(s,"=",It),_(s,"!",Zs),_(s,"-",k),_(s,"%",Me),_(s,"|",Dt),_(s,"+",Pt),_(s,"#",Ot),_(s,"?",Ae),_(s,'"',ei),_(s,"/",q),_(s,";",ti),_(s,"~",Le),_(s,"_",kt),_(s,"\\",Mt),_(s,"・",er);const i=M(s,H,Ks,{[As]:!0});M(i,H,i);const n=M(i,V,Xn,{[Ee]:!0}),r=M(i,be,Zn,{[Se]:!0}),a=M(s,V,j,{[Ls]:!0});M(a,H,n),M(a,V,a),M(n,H,n),M(n,V,n);const o=M(s,be,Ds,{[Ts]:!0});M(o,V),M(o,H,r),M(o,be,o),M(r,H,r),M(r,V),M(r,be,r);const l=_(s,cs,Ys,{[as]:!0}),d=_(s,Ui,ks,{[as]:!0}),c=M(s,ls,ks,{[as]:!0});_(s,ds,c),_(d,cs,l),_(d,ds,c),M(d,ls,c),_(c,Ui),_(c,cs),M(c,ls,c),_(c,ds,c);const h=M(s,os,tr,{[Yn]:!0});_(h,"#"),M(h,os,h),_(h,nl,h);const f=_(h,rl);_(f,"#"),M(f,os,h);const m=[[V,a],[H,n]],u=[[V,null],[be,o],[H,r]];for(let p=0;p<Qe.length;p++)Q(s,Qe[p],Ps,j,m);for(let p=0;p<Ge.length;p++)Q(s,Ge[p],Os,Ds,u);se(Ps,{tld:!0,ascii:!0},t),se(Os,{utld:!0,alpha:!0},t),Q(s,"file",st,j,m),Q(s,"mailto",st,j,m),Q(s,"http",le,j,m),Q(s,"https",le,j,m),Q(s,"ftp",le,j,m),Q(s,"ftps",le,j,m),se(st,{scheme:!0,ascii:!0},t),se(le,{slashscheme:!0,ascii:!0},t),e=e.sort((p,y)=>p[0]>y[0]?1:-1);for(let p=0;p<e.length;p++){const y=e[p][0],w=e[p][1]?{[el]:!0}:{[tl]:!0};y.indexOf("-")>=0?w[Is]=!0:V.test(y)?H.test(y)?w[Ee]=!0:w[Ls]=!0:w[As]=!0,xi(s,y,y,w)}return xi(s,"localhost",Ne,{ascii:!0}),s.jd=new D(Nt),{start:s,tokens:Object.assign({groups:t},sr)}}function ir(e,t){const s=ol(t.replace(/[A-Z]/g,o=>o.toLowerCase())),i=s.length,n=[];let r=0,a=0;for(;a<i;){let o=e,l=null,d=0,c=null,h=-1,f=-1;for(;a<i&&(l=o.go(s[a]));)o=l,o.accepts()?(h=0,f=0,c=o):h>=0&&(h+=s[a].length,f++),d+=s[a].length,r+=s[a].length,a++;r-=h,a-=f,d-=h,n.push({t:c.t,v:t.slice(r-d,r),s:r-d,e:r})}return n}function ol(e){const t=[],s=e.length;let i=0;for(;i<s;){let n=e.charCodeAt(i),r,a=n<55296||n>56319||i+1===s||(r=e.charCodeAt(i+1))<56320||r>57343?e[i]:e.slice(i,i+2);t.push(a),i+=a.length}return t}function Q(e,t,s,i,n){let r;const a=t.length;for(let o=0;o<a-1;o++){const l=t[o];e.j[l]?r=e.j[l]:(r=new D(i),r.jr=n.slice(),e.j[l]=r),e=r}return r=new D(s),r.jr=n.slice(),e.j[t[a-1]]=r,r}function Mi(e){const t=[],s=[];let i=0,n="0123456789";for(;i<e.length;){let r=0;for(;n.indexOf(e[i+r])>=0;)r++;if(r>0){t.push(s.join(""));for(let a=parseInt(e.substring(i,i+r),10);a>0;a--)s.pop();i+=r}else s.push(e[i]),i++}return t}var Fe={defaultProtocol:"http",events:null,format:Ai,formatHref:Ai,nl2br:!1,tagName:"a",target:null,rel:null,validate:!0,truncate:1/0,className:null,attributes:null,ignoreTags:[],render:null};function si(e,t=null){let s=Object.assign({},Fe);e&&(s=Object.assign(s,e instanceof si?e.o:e));const i=s.ignoreTags,n=[];for(let r=0;r<i.length;r++)n.push(i[r].toUpperCase());this.o=s,t&&(this.defaultRender=t),this.ignoreTags=n}si.prototype={o:Fe,ignoreTags:[],defaultRender(e){return e},check(e){return this.get("validate",e.toString(),e)},get(e,t,s){const i=t!=null;let n=this.o[e];return n&&(typeof n=="object"?(n=s.t in n?n[s.t]:Fe[e],typeof n=="function"&&i&&(n=n(t,s))):typeof n=="function"&&i&&(n=n(t,s.t,s)),n)},getObj(e,t,s){let i=this.o[e];return typeof i=="function"&&t!=null&&(i=i(t,s.t,s)),i},render(e){const t=e.render(this);return(this.get("render",null,e)||this.defaultRender)(t,e.t,e)}};function Ai(e){return e}function nr(e,t){this.t="token",this.v=e,this.tk=t}nr.prototype={isLink:!1,toString(){return this.v},toHref(e){return this.toString()},toFormattedString(e){const t=this.toString(),s=e.get("truncate",t,this),i=e.get("format",t,this);return s&&i.length>s?i.substring(0,s)+"…":i},toFormattedHref(e){return e.get("formatHref",this.toHref(e.get("defaultProtocol")),this)},startIndex(){return this.tk[0].s},endIndex(){return this.tk[this.tk.length-1].e},toObject(e=Fe.defaultProtocol){return{type:this.t,value:this.toString(),isLink:this.isLink,href:this.toHref(e),start:this.startIndex(),end:this.endIndex()}},toFormattedObject(e){return{type:this.t,value:this.toFormattedString(e),isLink:this.isLink,href:this.toFormattedHref(e),start:this.startIndex(),end:this.endIndex()}},validate(e){return e.get("validate",this.toString(),this)},render(e){const t=this,s=this.toHref(e.get("defaultProtocol")),i=e.get("formatHref",s,this),n=e.get("tagName",s,t),r=this.toFormattedString(e),a={},o=e.get("className",s,t),l=e.get("target",s,t),d=e.get("rel",s,t),c=e.getObj("attributes",s,t),h=e.getObj("events",s,t);return a.href=i,o&&(a.class=o),l&&(a.target=l),d&&(a.rel=d),c&&Object.assign(a,c),{tagName:n,attributes:a,content:r,eventListeners:h}}};function Qt(e,t){class s extends nr{constructor(n,r){super(n,r),this.t=e}}for(const i in t)s.prototype[i]=t[i];return s.t=e,s}var Li=Qt("email",{isLink:!0,toHref(){return"mailto:"+this.toString()}}),Ti=Qt("text"),ll=Qt("nl"),Je=Qt("url",{isLink:!0,toHref(e=Fe.defaultProtocol){return this.hasProtocol()?this.v:`${e}://${this.v}`},hasProtocol(){const e=this.tk;return e.length>=2&&e[0].t!==Ne&&e[1].t===J}}),O=e=>new D(e);function cl({groups:e}){const t=e.domain.concat([Et,Ut,G,Mt,At,Lt,Tt,It,k,Ks,Me,Dt,Pt,Ot,q,Nt,Le,kt]),s=[xt,J,Xs,F,Zs,Me,Ae,ei,ti,gt,mt,xe,Ue,ut,ht,ft,pt,yt,_t,wt,bt,vt,Ct,St,Rt],i=[Et,xt,Ut,Mt,At,Lt,Tt,It,k,xe,Ue,Me,Dt,Pt,Ot,Ae,q,Nt,Le,kt],n=O(),r=_(n,Le);R(r,i,r),R(r,e.domain,r);const a=O(),o=O(),l=O();R(n,e.domain,a),R(n,e.scheme,o),R(n,e.slashscheme,l),R(a,i,r),R(a,e.domain,a);const d=_(a,G);_(r,G,d),_(o,G,d),_(l,G,d);const c=_(r,F);R(c,i,r),R(c,e.domain,r);const h=O();R(d,e.domain,h),R(h,e.domain,h);const f=_(h,F);R(f,e.domain,h);const m=O(Li);R(f,e.tld,m),R(f,e.utld,m),_(d,Ne,m);const u=_(h,k);_(u,k,u),R(u,e.domain,h),R(m,e.domain,h),_(m,F,f),_(m,k,u);const p=_(m,J);R(p,e.numeric,Li);const y=_(a,k),b=_(a,F);_(y,k,y),R(y,e.domain,a),R(b,i,r),R(b,e.domain,a);const w=O(Je);R(b,e.tld,w),R(b,e.utld,w),R(w,e.domain,a),R(w,i,r),_(w,F,b),_(w,k,y),_(w,G,d);const v=_(w,J),C=O(Je);R(v,e.numeric,C);const S=O(Je),U=O();R(S,t,S),R(S,s,U),R(U,t,S),R(U,s,U),_(w,q,S),_(C,q,S);const Y=_(o,J),_r=_(l,J),wr=_(_r,q),Jt=_(wr,q);R(o,e.domain,a),_(o,F,b),_(o,k,y),R(l,e.domain,a),_(l,F,b),_(l,k,y),R(Y,e.domain,S),_(Y,q,S),_(Y,Ae,S),R(Jt,e.domain,S),R(Jt,t,S),_(Jt,q,S);const li=[[xe,Ue],[ht,ut],[ft,pt],[gt,mt],[yt,_t],[wt,bt],[vt,Ct],[St,Rt]];for(let Kt=0;Kt<li.length;Kt++){const[ci,Yt]=li[Kt],Ve=_(S,ci);_(U,ci,Ve),_(Ve,Yt,S);const oe=O(Je);R(Ve,t,oe);const ye=O();R(Ve,s),R(oe,t,oe),R(oe,s,ye),R(ye,t,oe),R(ye,s,ye),_(oe,Yt,S),_(ye,Yt,S)}return _(n,Ne,w),_(n,Ys,ll),{start:n,tokens:sr}}function dl(e,t,s){let i=s.length,n=0,r=[],a=[];for(;n<i;){let o=e,l=null,d=null,c=0,h=null,f=-1;for(;n<i&&!(l=o.go(s[n].t));)a.push(s[n++]);for(;n<i&&(d=l||o.go(s[n].t));)l=null,o=d,o.accepts()?(f=0,h=o):f>=0&&f++,n++,c++;if(f<0)n-=c,n<i&&(a.push(s[n]),n++);else{a.length>0&&(r.push(hs(Ti,t,a)),a=[]),n-=f,c-=f;const m=h.t,u=s.slice(n-c,n);r.push(hs(m,t,u))}}return a.length>0&&r.push(hs(Ti,t,a)),r}function hs(e,t,s){const i=s[0].s,n=s[s.length-1].e,r=t.slice(i,n);return new e(r,s)}var T={scanner:null,parser:null,tokenQueue:[],pluginQueue:[],customSchemes:[],initialized:!1};function hl(){T.scanner=al(T.customSchemes);for(let e=0;e<T.tokenQueue.length;e++)T.tokenQueue[e][1]({scanner:T.scanner});T.parser=cl(T.scanner.tokens);for(let e=0;e<T.pluginQueue.length;e++)T.pluginQueue[e][1]({scanner:T.scanner,parser:T.parser});return T.initialized=!0,T}function rr(e){return T.initialized||hl(),dl(T.parser.start,e,ir(T.scanner.start,e))}rr.scan=ir;function ul(e,t=null,s=null){if(t&&typeof t=="object"){if(s)throw Error(`linkifyjs: Invalid link type ${t}; must be a string`);s=t,t=null}const i=new si(s),n=rr(e),r=[];for(let a=0;a<n.length;a++){const o=n[a];o.isLink&&(!t||o.t===t)&&i.check(o)&&r.push(o.toFormattedObject(i))}return r}var fl={debounceURLEnrichmentMs:1500,enabled:!1,findURLFn:e=>ul(e,"url",{defaultProtocol:"https"}).reduce((t,s)=>{try{const i=new URL(s.href);s.isLink&&/^[a-zA-Z0-9-.]+\.[a-zA-Z]{2,}$/.test(i.hostname)&&t.push(s.href)}catch{}return t},[])},pl={acceptedFiles:[],fileUploadFilter:()=>!0,maxNumberOfFilesPerMessage:no},gl={enabled:!0,publishTypingEvents:!0},ml={enabled:!0,getDeviceId:()=>P()},yl={attachments:pl,drafts:{enabled:!1},linkPreviews:fl,location:ml,text:gl},Ii=e=>e?{message:{},custom:{}}:{message:{},custom:{}},_l=class{constructor({composer:e,message:t}){this.isMessageDataEqual=(s,i)=>JSON.stringify(s.message)===JSON.stringify(i?.message),this.initState=({message:s}={})=>{this.state.next(Ii({composer:this.composer}))},this.composer=e,this.state=new x(Ii({}))}get customMessageData(){return this.state.getLatestValue().message}get customComposerData(){return this.state.getLatestValue().custom}setMessageData(e){this.state.partialNext({message:{...this.state.getLatestValue().message,...e}})}setCustomData(e){this.state.partialNext({custom:{...this.state.getLatestValue().custom,...e}})}},wl=e=>new Map(e.map(t=>[t.og_scrape_url,t])),Di=({message:e})=>e?{previews:e.attachments?.reduce((t,s)=>(s.og_scrape_url&&t.set(s.og_scrape_url,{...s,status:"loaded"}),t),new Map)??new Map}:{previews:new Map},re=class X{constructor({composer:t,message:s}){this.shouldDiscardEnrichQueries=!1,this.initState=({message:i}={})=>{this.state.next(Di({message:this.enabled?i:void 0}))},this._findAndEnrichUrls=async i=>{if(!this.enabled)return;const n=this.config.findURLFn(i);if(this.shouldDiscardEnrichQueries=!n.length,this.shouldDiscardEnrichQueries){this.state.next({previews:new Map});return}const r=new Map(Array.from(this.previews).filter(([o])=>n.includes(o)||n.includes(o+"/"))),a=n.filter(o=>{const l=this.previews;return!(l.get(o)||l.get(o+"/"))}).map(o=>({og_scrape_url:o.trim(),status:"loading"}));a.length&&(this.state.partialNext({previews:new Map([...r,...wl(a)])}),await Promise.all(a.map(async o=>{try{const{duration:l,...d}=await this.client.enrichURL(o.og_scrape_url);if(this.shouldDiscardEnrichQueries)return;this.previews.has(o.og_scrape_url)&&this.updatePreview(o.og_scrape_url,{status:"loaded",...d})}catch{this.previews.has(o.og_scrape_url)&&this.updatePreview(o.og_scrape_url,{status:"failed"})}return o})))},this.cancelURLEnrichment=()=>{this.findAndEnrichUrls.cancel(),this.findAndEnrichUrls.flush()},this.clearPreviews=()=>{const i=this.previews,n=new Map;i.forEach((r,a)=>{X.previewIsDismissed(r)&&n.set(a,r)}),this.state.partialNext({previews:n})},this.updatePreview=(i,n)=>{if(!i)return;const r=this.previews.get(i),a=n.status??this.previews.get(i)?.status??"pending";let o=n;if(r){const l=Jn(r,n);if(!l.diff||Object.keys(l.diff).length===0)return;o=l.result}this.state.partialNext({previews:new Map(this.previews).set(i,{...o,og_scrape_url:i,status:a})})},this.dismissPreview=i=>{const n=this.previews.get(i);n&&(this.onLinkPreviewDismissed?.(n),this.updatePreview(i,{status:"dismissed"}))},this.composer=t,this.state=new x(Di({message:this.enabled?s:void 0})),this.findAndEnrichUrls=ke(this._findAndEnrichUrls.bind(this),this.config.debounceURLEnrichmentMs)}get client(){return this.composer.client}get channel(){return this.composer.channel}get previews(){return this.state.getLatestValue().previews}get loadingPreviews(){return Array.from(this.previews.values()).filter(t=>X.previewIsLoading(t))}get loadedPreviews(){return Array.from(this.previews.values()).filter(t=>X.previewIsLoaded(t))}get dismissedPreviews(){return Array.from(this.previews.values()).filter(t=>X.previewIsDismissed(t))}get failedPreviews(){return Array.from(this.previews.values()).filter(t=>X.previewIsFailed(t))}get pendingPreviews(){return Array.from(this.previews.values()).filter(t=>X.previewIsPending(t))}get config(){return this.composer.config.linkPreviews}get debounceURLEnrichmentMs(){return this.config.debounceURLEnrichmentMs}set debounceURLEnrichmentMs(t){this.cancelURLEnrichment(),this.findAndEnrichUrls=ke(this._findAndEnrichUrls.bind(this),this.config.debounceURLEnrichmentMs),this.composer.updateConfig({linkPreviews:{debounceURLEnrichmentMs:t}})}get enabled(){return!!this.channel.getConfig()?.url_enrichment&&this.composer.config.linkPreviews.enabled}set enabled(t){t!==this.enabled&&this.composer.updateConfig({linkPreviews:{enabled:t}})}get findURLFn(){return this.config.findURLFn}set findURLFn(t){this.composer.updateConfig({linkPreviews:{findURLFn:t}})}get onLinkPreviewDismissed(){return this.config.onLinkPreviewDismissed}set onLinkPreviewDismissed(t){this.composer.updateConfig({linkPreviews:{onLinkPreviewDismissed:t}})}};re.previewIsLoading=e=>e.status==="loading";re.previewIsLoaded=e=>e.status==="loaded";re.previewIsDismissed=e=>e.status==="dismissed";re.previewIsFailed=e=>e.status==="failed";re.previewIsPending=e=>e.status==="pending";re.getPreviewData=e=>{const{status:t,...s}=e;return s};var ii=re,bl=60*1e3,Pi=({message:e})=>({location:e?.shared_location??null}),vl=class{constructor({composer:e,message:t}){this.initState=({message:s}={})=>{this.state.next(Pi({message:s}))},this.setData=s=>{this.config.enabled&&(!s.latitude||!s.longitude||this.state.partialNext({location:{...s,message_id:this.composer.id,created_by_device_id:this.deviceId}}))},this.composer=e,this.state=new x(Pi({message:t})),this._deviceId=this.config.getDeviceId()}get config(){return this.composer.config.location}get deviceId(){return this._deviceId}get location(){return this.state.getLatestValue().location}get validLocation(){const{durationMs:e,...t}=this.location??{};return t?.created_by_device_id&&t.message_id&&t.latitude&&t.longitude&&(typeof e>"u"||e>=bl)?{...t,end_at:e&&new Date(Date.now()+e).toISOString()}:null}},ni=/^([2-9]|10)$/,Cl=100,Oi=e=>!e.trim(),Ns={enforce_unique_vote:()=>({max_votes_allowed:void 0}),max_votes_allowed:({data:e,value:t})=>e.enforce_unique_vote&&t?{max_votes_allowed:"Enforce unique vote is enabled"}:!t.match(/^[0-9]+$/)&&t?{max_votes_allowed:"Only numbers are allowed"}:t?.length>1&&!t.match(ni)?{max_votes_allowed:"Type a number from 2 to 10"}:{max_votes_allowed:void 0},options:({value:e})=>{const t={},s=new Set;return e.forEach(i=>{s.has(i.text)&&i.text.length?t[i.id]="Option already exists":s.add(i.text)}),Object.keys(t).length>0?{options:t}:{options:void 0}}},Sl={name:({currentError:e,value:t})=>t&&e?{name:void 0}:{name:typeof e=="string"?e:void 0}},Rl={max_votes_allowed:({value:e})=>e&&!e.match(ni)?{max_votes_allowed:"Type a number from 2 to 10"}:{max_votes_allowed:void 0},name:({value:e})=>Oi(e)?{name:"Question is required"}:{name:void 0},options:e=>{const s=Ns.options?.(e)?.options??{};return e.value.forEach((i,n)=>{const r=n===e.value.length-1;Oi(i.text)&&!r&&(s[i.id]="Option is empty")}),Object.keys(s).length>0?{options:s}:{options:void 0}}},El=e=>!Array.isArray(e)&&typeof e?.index=="number"&&typeof e?.text=="string",xl={enforce_unique_vote:({value:e})=>({enforce_unique_vote:e,max_votes_allowed:""}),options:({value:e,data:t})=>{if(Array.isArray(e))return{options:e.map(c=>({id:c.id,text:c.text.trim()}))};const{index:s,text:i}=e,n=t.options||[],r=n&&n.slice(s+1).length>0&&!i,a=n.slice(0,s),o=n.slice(s+1),l=[...a,...r?[]:[{...n[s],text:i}],...o];return n.length<Cl&&!l.some(c=>!c.text.trim())&&l.push({id:P(),text:""}),{options:l}}},Ul=({processors:e,validators:t}={})=>{const s=({state:i,validators:n,processors:r})=>{const{previousState:a,targetFields:o}=i;let l;if(!r&&El(o.options)){const c=[...a.data.options],h=a.data.options[o.options.index];h&&(h.text=o.options.text,c.splice(o.options.index,1,h)),l={...o,options:c}}else r?l=Object.entries(o).reduce((c,[h,f])=>{const m=r[h];return c={...c,...m?m({data:a.data,value:f}):{[h]:f}},c},{}):l=o;const d=Object.keys(o).reduce((c,h)=>{const f=n[h];if(f){const m=f({currentError:a.errors[h],data:a.data,value:l[h]});c={...c,...m}}return c},{});return{newData:l,newErrors:d}};return{id:"stream-io/poll-composer-state-processing",handlers:{handleFieldChange:({state:i,next:n,forward:r})=>{if(!i.targetFields)return r();const{previousState:a,injectedFieldErrors:o}=i,{newData:l,newErrors:d}=s({processors:{...xl,...e?.handleFieldChange},state:i,validators:{...Ns,...Sl,...t?.handleFieldChange}});return n({...i,nextState:{...a,data:{...a.data,...l},errors:{...a.errors,...d,...o}}})},handleFieldBlur:({state:i,next:n,forward:r})=>{if(!i.targetFields)return r();const{previousState:a}=i,{newData:o,newErrors:l}=s({processors:e?.handleFieldBlur,state:i,validators:{...Ns,...Rl,...t?.handleFieldBlur}});return n({...i,nextState:{...a,data:{...a.data,...o},errors:{...a.errors,...l,...i.injectedFieldErrors}}})}}}},Ml=e=>({id:"stream-io/poll-composer-composition",handlers:{compose:({discard:t,forward:s})=>e.pollComposer.canCreatePoll?s():t()}}),Al=class extends ne{constructor({composer:e}){super(),this.use([Ml(e)])}},Ll=class extends ne{constructor(){super(),this.use([Ul()])}},Tl=class extends Error{constructor(e,{code:t,status:s,response:i}){super(e),this.name="ErrorFromResponse",this.code=t,this.response=i,this.status=s}toJSON(){const e=[["status",this.status],["code",this.code]],t=[];for(const[s,i]of e)typeof i<"u"&&i!==null&&t.push(`${s}: ${i}`);return{message:`(${t.join(", ")}) - ${this.message}`,stack:this.stack,name:this.name,code:this.code,status:this.status}}},Il=(e=>(e.anonymous="anonymous",e.public="public",e))(Il||{}),Dl=class{constructor({composer:e}){this.initState=()=>{this.state.next(this.initialState)},this.updateFields=async(t,s)=>{const{state:i,status:n}=await this.stateMiddlewareExecutor.execute({eventName:"handleFieldChange",initialValue:{nextState:{...this.state.getLatestValue()},previousState:{...this.state.getLatestValue()},targetFields:t,injectedFieldErrors:s}});n!=="discard"&&this.state.next(i.nextState)},this.handleFieldBlur=async t=>{const s=await this.stateMiddlewareExecutor.execute({eventName:"handleFieldBlur",initialValue:{nextState:{...this.state.getLatestValue()},previousState:{...this.state.getLatestValue()},targetFields:{[t]:this.state.getLatestValue().data[t]}}});s.status!=="discard"&&this.state.next(s.state.nextState)},this.compose=async()=>{const{data:t,errors:s}=this.state.getLatestValue(),i=await this.compositionMiddlewareExecutor.execute({eventName:"compose",initialValue:{data:{...t,max_votes_allowed:t.max_votes_allowed?parseInt(t.max_votes_allowed):void 0,options:t.options?.filter(n=>n.text.trim()).map(n=>({text:n.text}))},errors:s}});if(i.status!=="discard")return i.state},this.composer=e,this.state=new x(this.initialState),this.compositionMiddlewareExecutor=new Al({composer:e}),this.stateMiddlewareExecutor=new Ll}get initialState(){return{data:{allow_answers:!1,allow_user_suggested_options:!1,description:"",enforce_unique_vote:!0,id:P(),max_votes_allowed:"",name:"",options:[{id:P(),text:""}],user_id:this.composer.client.user?.id,voting_visibility:"public"},errors:{}}}get allow_answers(){return this.state.getLatestValue().data.allow_answers}get allow_user_suggested_options(){return this.state.getLatestValue().data.allow_user_suggested_options}get description(){return this.state.getLatestValue().data.description}get enforce_unique_vote(){return this.state.getLatestValue().data.enforce_unique_vote}get id(){return this.state.getLatestValue().data.id}get max_votes_allowed(){return this.state.getLatestValue().data.max_votes_allowed}get name(){return this.state.getLatestValue().data.name}get options(){return this.state.getLatestValue().data.options}get user_id(){return this.state.getLatestValue().data.user_id}get voting_visibility(){return this.state.getLatestValue().data.voting_visibility}get canCreatePoll(){const{data:e,errors:t}=this.state.getLatestValue(),s=e.options.filter(a=>!!a.text.trim()).length>0,i=!!e.name,n=parseInt(e.max_votes_allowed?.match(ni)?.[0]||""),r=e.max_votes_allowed===""||!!n&&(2<=n||n<=10);return s&&i&&r&&Object.values(t).filter(a=>!!a).length===0}},ar=e=>{const{localMetadata:t,...s}=e;return s},Pl=e=>({id:"stream-io/message-composer-middleware/attachments",handlers:{compose:({state:t,next:s,discard:i,forward:n})=>{const{attachmentManager:r}=e;if(!r)return n();if(r.uploadsInProgressCount>0)return e.client.notifications.addWarning({message:"Wait until all attachments have uploaded",origin:{emitter:"MessageComposer",context:{composer:e}}}),i();const a=(t.message.attachments??[]).concat(r.successfulUploads.map(ar));return a.length?s({...t,localMessage:{...t.localMessage,attachments:a},message:{...t.message,attachments:a}}):n()}}}),Ol=e=>({id:"stream-io/message-composer-middleware/draft-attachments",handlers:{compose:({state:t,next:s,forward:i})=>{const{attachmentManager:n}=e;if(!n)return i();const r=n.successfulUploads,a=r.length?(t.draft.attachments??[]).concat(r.map(ar)):void 0;return s({...t,draft:{...t.draft,attachments:a}})}}}),kl=e=>({id:"stream-io/message-composer-middleware/data-cleanup",handlers:{compose:({state:t,next:s})=>{const i={type:e.editedMessage?.type??"regular"},n=e.editedMessage?An(e.editedMessage):void 0;return s({...t,localMessage:I({...e.editedMessage,...t.localMessage,...i}),message:{...n,...t.message,...i},sendOptions:e.editedMessage&&t.sendOptions?.skip_enrich_url?{skip_enrich_url:t.sendOptions?.skip_enrich_url}:t.sendOptions})}}}),Nl=e=>({id:"stream-io/message-composer-middleware/custom-data",handlers:{compose:({state:t,next:s,forward:i})=>{const n=e.customDataManager.customMessageData;return n?s({...t,localMessage:{...t.localMessage,...n},message:{...t.message,...n}}):i()}}}),Fl=e=>({id:"stream-io/message-composer-middleware/draft-custom-data",handlers:{compose:({state:t,next:s,forward:i})=>{const n=e.customDataManager.customMessageData;return n?s({...t,draft:{...t.draft,...n}}):i()}}}),ql=e=>({id:"stream-io/message-composer-middleware/data-validation",handlers:{compose:async({state:t,discard:s,forward:i})=>{const{maxLengthOnSend:n}=e.config.text??{},r=t.message.text??"",a=typeof n=="number"&&r.length>n;return e.compositionIsEmpty||a?await s():await i()}}}),Bl=e=>({id:"stream-io/message-composer-middleware/draft-data-validation",handlers:{compose:async({state:t,discard:s,forward:i})=>{const n=!dr(t.draft.text??"")||t.draft.attachments?.length||t.draft.poll_id||t.draft.quoted_message_id;return e.lastChangeOriginIsLocal&&n?await i():await s()}}}),$l=e=>({id:"stream-io/message-composer-middleware/link-previews",handlers:{compose:({state:t,next:s,forward:i})=>{const{linkPreviewsManager:n}=e;if(!n)return i();n.cancelURLEnrichment();const r=n.loadingPreviews.length>0,a=n.dismissedPreviews.length>0,o=n.loadingPreviews.length>0?[]:n.loadedPreviews.map(h=>ii.getPreviewData(h)),l=(t.message.attachments??[]).concat(o);if(!l.length)return i();const d={...t.sendOptions};return(!r&&o.length>0||a)&&(d.skip_enrich_url=!0),s({...t,message:{...t.message,attachments:l},localMessage:{...t.localMessage,attachments:l},sendOptions:d})}}}),Vl=e=>({id:"stream-io/message-composer-middleware/draft-link-previews",handlers:{compose:({state:t,next:s,forward:i})=>{const{linkPreviewsManager:n}=e;if(!n)return i();n.cancelURLEnrichment();const r=n.loadedPreviews.map(a=>ii.getPreviewData(a));return r.length?s({...t,draft:{...t.draft,attachments:(t.draft.attachments??[]).concat(r)}}):i()}}}),Hl=e=>({id:"stream-io/message-composer-middleware/text-composition",handlers:{compose:({state:t,next:s,forward:i})=>{if(!e.textComposer)return i();const{mentionedUsers:n,text:r}=e.textComposer,a=Array.from(new Set(n.filter(({id:o,name:l})=>r.includes(`@${o}`)||r.includes(`@${l}`))));return!r&&a.length===0?i():s({...t,localMessage:{...t.localMessage,mentioned_users:a,text:r},message:{...t.message,mentioned_users:a.map(o=>o.id),text:r}})}}}),jl=e=>({id:"stream-io/message-composer-middleware/draft-text-composition",handlers:{compose:({state:t,next:s,forward:i})=>{if(!e.textComposer)return i();const{maxLengthOnSend:n}=e.config.text??{},{mentionedUsers:r,text:a}=e.textComposer,o=r.length?Array.from(new Set(r.filter(({id:d,name:c})=>a.includes(`@${d}`)||a.includes(`@${c}`)))):void 0,l=typeof n=="number"&&a.length>n?a.slice(0,n):a;return s({...t,draft:{...t.draft,mentioned_users:o?.map(d=>d.id),text:l}})}}}),Wl=e=>({id:"stream-io/message-composer-middleware/own-state",handlers:{compose:({state:t,next:s})=>{const i={};return e.quotedMessage&&(i.quoted_message_id=e.quotedMessage.id),e.pollId&&(i.poll_id=e.pollId),e.showReplyInChannel&&(i.show_in_channel=!0),s({...t,localMessage:{...t.localMessage,...i,quoted_message:e.quotedMessage??void 0},message:{...t.message,...i}})}}}),zl=e=>({id:"stream-io/message-composer-middleware/draft-own-state",handlers:{compose:({state:t,next:s})=>{const i={};return e.quotedMessage&&(i.quoted_message_id=e.quotedMessage.id),e.pollId&&(i.poll_id=e.pollId),e.showReplyInChannel&&(i.show_in_channel=!0),s({...t,draft:{...t.draft,...i}})}}}),Ql=e=>({id:"stream-io/message-composer-middleware/user-data-injection",handlers:{compose:({state:t,next:s,forward:i})=>{if(!e.client.user)return i();const{channel_mutes:n,devices:r,mutes:a,...o}=e.client.user;return s({...t,localMessage:{...t.localMessage,user:o,user_id:o.id}})}}}),Gl={attachments:[],mentioned_users:[],parent_id:void 0,quoted_message:void 0,text:""},Jl=e=>({id:"stream-io/message-composer-middleware/poll-only",handlers:{compose:({state:t,complete:s,forward:i})=>{const n=e.pollId,r=!!e.editedMessage,a=!!e.threadId;return!n||a||r?i():s({...t,localMessage:{...t.localMessage,...Gl,poll_id:n},message:{id:t.localMessage.id,poll_id:n}})}}}),Kl=e=>({id:"stream-io/message-composer-middleware/shared-location",handlers:{compose:({state:t,next:s,forward:i})=>{const{locationComposer:n}=e,r=n.validLocation;if(!n||!r||!e.client.user)return i();const a=new Date().toISOString();return s({...t,localMessage:{...t.localMessage,shared_location:{...r,channel_cid:e.channel.cid,created_at:a,updated_at:a,user_id:e.client.user.id}},message:{...t.message,shared_location:r}})}}}),Yl=class extends ne{constructor({composer:e}){super(),this.use([Ql(e),Jl(e),Hl(e),Pl(e),$l(e),Kl(e),Wl(e),Nl(e),ql(e),kl(e)])}},Xl=class extends ne{constructor({composer:e}){super(),this.use([jl(e),Ol(e),Vl(e),zl(e),Fl(e),Bl(e)])}},ri={debounceMs:300,pageSize:10},or=class{constructor(e){this.activate=()=>{this.isActive||this.state.partialNext({isActive:!0})},this.deactivate=()=>{this.isActive&&this.state.partialNext({isActive:!1})},this.canExecuteQuery=s=>{const i=typeof s<"u",n=s??this.searchQuery;return!!(this.isActive&&!this.isLoading&&(this.hasNext||i)&&n)};const{pageSize:t}={...ri,...e};this.pageSize=t,this.state=new x(this.initialState)}get lastQueryError(){return this.state.getLatestValue().lastQueryError}get hasNext(){return this.state.getLatestValue().hasNext}get hasResults(){return Array.isArray(this.state.getLatestValue().items)}get isActive(){return this.state.getLatestValue().isActive}get isLoading(){return this.state.getLatestValue().isLoading}get initialState(){return{hasNext:!0,isActive:!1,isLoading:!1,items:void 0,lastQueryError:void 0,next:void 0,offset:0,searchQuery:""}}get items(){return this.state.getLatestValue().items}get next(){return this.state.getLatestValue().next}get offset(){return this.state.getLatestValue().offset}get searchQuery(){return this.state.getLatestValue().searchQuery}getStateBeforeFirstQuery(e){return{...this.initialState,isActive:this.isActive,isLoading:!0,searchQuery:e}}getStateAfterQuery(e,t){return{...this.state.getLatestValue(),lastQueryError:void 0,...e,isLoading:!1,items:t?e.items:[...this.items??[],...e.items||[]]}}prepareStateForQuery(e){const t=typeof e<"u",s=e??this.searchQuery;return t?this.state.next(this.getStateBeforeFirstQuery(e??"")):this.state.partialNext({isLoading:!0}),{searchString:s,hasNewSearchQuery:t}}updatePaginationStateFromQuery(e){const{items:t,next:s}=e,i={};return s||s===null?(i.next=s,i.hasNext=!!s):(i.offset=(this.offset??0)+t.length,i.hasNext=t.length===this.pageSize),i}resetState(){this.state.next(this.initialState)}resetStateAndActivate(){this.resetState(),this.activate()}},Gt=class extends or{constructor(e){const{debounceMs:t}={...ri,...e};super(e),this.setDebounceOptions=({debounceMs:s})=>{this.searchDebounced=ke(this.executeQuery.bind(this),s)},this.search=s=>this.searchDebounced(s),this.setDebounceOptions({debounceMs:t})}async executeQuery(e){if(!this.canExecuteQuery(e))return;const{hasNewSearchQuery:t,searchString:s}=this.prepareStateForQuery(e);let i={};try{const n=await this.query(s);if(!n)return;const{items:r}=n;i=this.updatePaginationStateFromQuery(n),i.items=await this.filterQueryResults(r)}catch(n){i.lastQueryError=n}finally{this.state.next(this.getStateAfterQuery(i,t))}}cancelScheduledQuery(){this.searchDebounced.cancel()}},Zl=class extends or{constructor(e){const{debounceMs:t}={...ri,...e};super(e),this.setDebounceOptions=({debounceMs:s})=>{this.searchDebounced=ke(this.executeQuery.bind(this),s)},this.search=s=>this.searchDebounced(s),this.setDebounceOptions({debounceMs:t})}executeQuery(e){if(!this.canExecuteQuery(e))return;const{hasNewSearchQuery:t,searchString:s}=this.prepareStateForQuery(e);let i={};try{const n=this.query(s);if(!n)return;const{items:r}=n;i=this.updatePaginationStateFromQuery(n),i.items=this.filterQueryResults(r)}catch(n){i.lastQueryError=n}finally{this.state.next(this.getStateAfterQuery(i,t))}}cancelScheduledQuery(){this.searchDebounced.cancel()}},Dd=class{constructor({config:e,sources:t}={}){this.addSource=s=>{this.state.partialNext({sources:[...this.sources,s]})},this.getSource=s=>this.sources.find(i=>i.type===s),this.removeSource=s=>{const i=this.sources.filter(n=>n.type!==s);i.length!==this.sources.length&&this.state.partialNext({sources:i})},this.activateSource=s=>{const i=this.getSource(s);!i||i.isActive||(this.config.keepSingleActiveSource&&this.sources.forEach(n=>{n.type!==s&&n.deactivate()}),i.activate(),this.state.partialNext({sources:[...this.sources]}))},this.deactivateSource=s=>{const i=this.getSource(s);i?.isActive&&this.activeSources.length!==1&&(i.deactivate(),this.state.partialNext({sources:[...this.sources]}))},this.activate=()=>{this.activeSources.length||(this.config.keepSingleActiveSource?this.sources.slice(0,1):this.sources).forEach(i=>i.activate()),!this.isActive&&this.state.partialNext({isActive:!0})},this.search=async s=>{const i=this.activeSources;this.state.partialNext({searchQuery:s}),await Promise.all(i.map(n=>n.search(s)))},this.cancelSearchQueries=()=>{this.activeSources.forEach(s=>s.cancelScheduledQuery())},this.clear=()=>{this.cancelSearchQueries(),this.sources.forEach(s=>s.state.next({...s.initialState,isActive:s.isActive})),this.state.next(s=>({...s,isActive:!0,queriesInProgress:[],searchQuery:""}))},this.exit=()=>{this.cancelSearchQueries(),this.sources.forEach(s=>s.state.next({...s.initialState,isActive:s.isActive})),this.state.next(s=>({...s,isActive:!1,queriesInProgress:[],searchQuery:""}))},this.state=new x({isActive:!1,searchQuery:"",sources:t??[]}),this._internalState=new x({}),this.config={keepSingleActiveSource:!0,...e}}get hasNext(){return this.sources.some(e=>e.hasNext)}get sources(){return this.state.getLatestValue().sources}get activeSources(){return this.state.getLatestValue().sources.filter(e=>e.isActive)}get isActive(){return this.state.getLatestValue().isActive}get searchQuery(){return this.state.getLatestValue().searchQuery}get searchSourceTypes(){return this.sources.map(e=>e.type)}},ec={debounceMs:300,pageSize:10},tc=class{constructor(e){this._isCursorPagination=!1,this.setDebounceOptions=({debounceMs:i})=>{this._executeQueryDebounced=ke(this.executeQuery.bind(this),i)},this.canExecuteQuery=i=>!this.isLoading&&i==="next"&&this.hasNext||i==="prev"&&this.hasPrev,this.next=()=>this.executeQuery({direction:"next"}),this.prev=()=>this.executeQuery({direction:"prev"}),this.nextDebounced=()=>{this._executeQueryDebounced({direction:"next"})},this.prevDebounced=()=>{this._executeQueryDebounced({direction:"prev"})};const{debounceMs:t,pageSize:s}={...ec,...e};this.pageSize=s,this.state=new x(this.initialState),this.setDebounceOptions({debounceMs:t})}get lastQueryError(){return this.state.getLatestValue().lastQueryError}get hasNext(){return this.state.getLatestValue().hasNext}get hasPrev(){return this.state.getLatestValue().hasPrev}get hasResults(){return Array.isArray(this.state.getLatestValue().items)}get isLoading(){return this.state.getLatestValue().isLoading}get initialState(){return{hasNext:!0,hasPrev:!0,isLoading:!1,items:void 0,lastQueryError:void 0,cursor:void 0,offset:0}}get items(){return this.state.getLatestValue().items}get cursor(){return this.state.getLatestValue().cursor}get offset(){return this.state.getLatestValue().offset}getStateBeforeFirstQuery(){return{...this.initialState,isLoading:!0}}getStateAfterQuery(e,t){return{...this.state.getLatestValue(),lastQueryError:void 0,...e,isLoading:!1,items:t?e.items:[...this.items??[],...e.items||[]]}}async executeQuery({direction:e}){if(!this.canExecuteQuery(e))return;const t=typeof this.items>"u";t?this.state.next(this.getStateBeforeFirstQuery()):this.state.partialNext({isLoading:!0});const s={};try{const i=await this.query({direction:e});if(!i)return;const{items:n,next:r,prev:a}=i;t&&(r||a)&&(this._isCursorPagination=!0),this._isCursorPagination?(s.cursor={next:r||null,prev:a||null},s.hasNext=!!r,s.hasPrev=!!a):(s.offset=(this.offset??0)+n.length,s.hasNext=n.length===this.pageSize),s.items=await this.filterQueryResults(n)}catch(i){s.lastQueryError=i}finally{this.state.next(this.getStateAfterQuery(s,t))}}cancelScheduledQuery(){this._executeQueryDebounced.cancel()}resetState(){this.state.next(this.initialState)}},Te=class{constructor(e){this.context=new x(e?.initialContext??{}),this.filterConfig=new x(e?.initialFilterConfig??{})}updateFilterConfig(e){this.filterConfig.partialNext(e)}enableFilter(e){const t=this.filterConfig.getLatestValue();t[e]&&this.filterConfig.partialNext({[e]:{...t[e],enabled:!0}})}disableFilter(e){const t=this.filterConfig.getLatestValue();t[e]&&this.filterConfig.partialNext({[e]:{...t[e],enabled:!1}})}updateContext(e){this.context.partialNext(e)}buildFilters(e){const t={...e?.baseFilters??{}},s=this.filterConfig.getLatestValue();for(const i in s){const n=s[i];if(!n?.enabled)continue;const r=n.generate({...this.context.getLatestValue(),...e?.context??{}});r&&Object.assign(t,r)}return t}},sc=class extends tc{constructor(e,t){super(t),this.query=async({direction:s})=>{const i=this.cursor?.[s],{reminders:n,next:r,prev:a}=await this.client.queryReminders({filter:this.filters,sort:this.sort,limit:this.pageSize,[s]:i});return{items:n,next:r,prev:a}},this.filterQueryResults=s=>s,this.client=e}get filters(){return this._filters}get sort(){return this._sort}set filters(e){this._filters=e,this.resetState()}set sort(e){this._sort=e,this.resetState()}},Pd=class extends Gt{constructor(e,t,s={}){super(t),this.type="users",this.client=e,this.filterBuilder=new Te({initialFilterConfig:{$or:{enabled:!0,generate:({searchQuery:i})=>i?{$or:[{id:{$autocomplete:i}},{name:{$autocomplete:i}}]}:null}},...s})}async query(e){const t=this.filterBuilder.buildFilters({baseFilters:this.filters,context:{searchQuery:e}}),s={id:1,...this.sort},i={...this.searchOptions,limit:this.pageSize,offset:this.offset},{users:n}=await this.client.queryUsers(t,s,i);return{items:n}}filterQueryResults(e){return e.filter(t=>t.id!==this.client.user?.id)}},Od=class extends Gt{constructor(e,t,s={}){super(t),this.type="channels",this.client=e,this.filterBuilder=new Te({...s,initialFilterConfig:{name:{enabled:!0,generate:({searchQuery:i})=>i?{name:{$autocomplete:i}}:null},...s.initialFilterConfig}})}async query(e){const t=this.filterBuilder.buildFilters({baseFilters:{...this.client.userID?{members:{$in:[this.client.userID]}}:{},...this.filters},context:{searchQuery:e}}),s=this.sort??{},i={...this.searchOptions,limit:this.pageSize,offset:this.offset};return{items:await this.client.queryChannels(t,s,i)}}filterQueryResults(e){return e}},kd=class extends Gt{constructor(e,t,s){super(t),this.type="messages",this.client=e,this.messageSearchChannelFilterBuilder=new Te(s?.messageSearchChannel),this.messageSearchFilterBuilder=new Te({...s?.messageSearch,initialFilterConfig:{text:{enabled:!0,generate:({searchQuery:i})=>i?{text:i}:null},...s?.messageSearch?.initialFilterConfig}}),this.channelQueryFilterBuilder=new Te({...s?.channelQuery,initialFilterConfig:{cid:{enabled:!0,generate:({cids:i})=>i?{cid:{$in:i}}:null},...s?.channelQuery?.initialFilterConfig}})}async query(e){if(!this.client.userID||!e||this.next===null)return{items:[]};const t=this.messageSearchChannelFilterBuilder.buildFilters({baseFilters:{...this.client.userID?{members:{$in:[this.client.userID]}}:{},...this.messageSearchChannelFilters},context:{searchQuery:e}}),s=this.messageSearchFilterBuilder.buildFilters({baseFilters:{type:"regular",...this.messageSearchFilters},context:{searchQuery:e}}),i={created_at:-1,...this.messageSearchSort},n={limit:this.pageSize,next:this.next,sort:i},{next:r,results:a}=await this.client.search(t,s,n),o=a.map(({message:d})=>d),l=Array.from(o.reduce((d,c)=>(c.cid&&!this.client.activeChannels[c.cid]&&d.add(c.cid),d),new Set));if(l.length>0){const d=this.channelQueryFilterBuilder.buildFilters({baseFilters:this.channelQueryFilters,context:{cids:l}});await this.client.queryChannels(d,{last_message_at:-1,...this.channelQuerySort},this.channelQueryOptions)}return{items:o,next:r}}filterQueryResults(e){return e}},lr=({trigger:e,text:t,isCommand:s=!1,acceptTrailingSpaces:i=!0})=>{const n=`[^\\s${e}]*`,r=t.match(new RegExp(s?`^[${e}]${n}$`:i?`(?!^|\\W)?[${e}]${n}\\s?${n}$`:`(?!^|\\W)?[${e}]${n}$`,"g"));return r&&r[r.length-1].trim()},ic=e=>{const t=e.match(/^\/(\S+)\s+.*/);return t&&t[1]},cr=({insertText:e,selection:t,text:s,trigger:i})=>{const n=s.slice(0,t.end),r=s.slice(t.end),a=n.lastIndexOf(i);return{text:n.slice(0,a)+e+r,selection:{start:a+e.length,end:a+e.length}}};function nc(e){return e.replace(/[-[\]{}()*+?.,/\\^$|#]/g,"\\$&")}var rc=({displayName:e,searchToken:t})=>({tokenizedDisplayName:{token:t,parts:t?e.split(new RegExp(`(${nc(t)})`,"gi")).filter(Boolean):[e]}}),ac=class extends Zl{constructor(e,t){super(t),this.type="commands",this.canExecuteQuery=s=>{const i=typeof s<"u";return this.isActive&&!this.isLoading&&(this.hasNext||i)},this.channel=e}getStateBeforeFirstQuery(e){const t=super.getStateBeforeFirstQuery(e),{items:s}=this.state.getLatestValue();return{...t,items:s}}query(e){const i=(this.channel.getConfig()?.commands||[]).filter(n=>!!(n.name&&n.name.toLowerCase().indexOf(e.toLowerCase())!==-1));return i.sort((n,r)=>{let a=n.name?.toLowerCase(),o=r.name?.toLowerCase();if(a?.indexOf(e)===0&&(a=`0${a}`),o?.indexOf(e)===0&&(o=`0${o}`),a!=null&&o!=null){if(a<o)return-1;if(a>o)return 1}return 0}),{items:i.map(n=>({...n,id:n.name})),next:null}}filterQueryResults(e){return e}},oc={minChars:1,trigger:"/"},lc=(e,t)=>{const s=he(oc,{});let i=new ac(e);return i.activate(),{id:"stream-io/text-composer/commands-middleware",handlers:{onChange:({state:n,next:r,complete:a,forward:o})=>{if(!n.selection)return o();const l=n.text.slice(0,n.selection.end),d=ic(l);if(d){const m=i?.query(d).items[0];if(m)return r({...n,command:m,suggestions:void 0})}const c=lr({trigger:s.trigger,text:l,acceptTrailingSpaces:!1,isCommand:!0});if(c&&c.length===s.minChars&&i.resetStateAndActivate(),!c||c.length<s.minChars){const m=n.suggestions?.trigger===s.trigger,u={...n};return m&&delete u.suggestions,r(u)}return a({...n,command:null,suggestions:{query:c.slice(1),searchSource:i,trigger:s.trigger}})},onSuggestionItemSelect:({state:n,next:r,forward:a})=>{const{selectedSuggestion:o}=n.change??{};return!o||n.suggestions?.trigger!==s.trigger?a():(i.resetStateAndActivate(),r({...n,...cr({insertText:`/${o.name} `,selection:n.selection,text:n.text,trigger:s.trigger}),command:o,suggestions:void 0}))}}}},ki={a:"á|à|ã|â|À|Á|Ã|Â",c:"ç|Ç",e:"é|è|ê|É|È|Ê",i:"í|ì|î|Í|Ì|Î",n:"ñ|Ñ",o:"ó|ò|ô|ő|õ|Ó|Ò|Ô|Õ",u:"ú|ù|û|ü|Ú|Ù|Û|Ü"},us=e=>e?Object.keys(ki).reduce((t,s)=>t.replace(new RegExp(ki[s],"g"),s),e):"",Ni=(e,t)=>{if(e.length===0)return t.length;if(t.length===0)return e.length;const s=[];let i;for(i=0;i<=t.length;i++)s[i]=[i];let n;for(n=0;n<=e.length;n++)s[0][n]=n;for(i=1;i<=t.length;i++)for(n=1;n<=e.length;n++)t.charAt(i-1)===e.charAt(n-1)?s[i][n]=s[i-1][n-1]:s[i][n]=Math.min(s[i-1][n-1]+1,Math.min(s[i][n-1]+1,s[i-1][n]+1));return s[t.length][e.length]},cc=class extends Gt{constructor(e,t){const{mentionAllAppUsers:s,textComposerText:i,transliterate:n,...r}=t||{};super(r),this.type="mentions",this.canExecuteQuery=a=>{const o=typeof a<"u";return this.isActive&&!this.isLoading&&(o||this.hasNext)},this.transliterate=a=>a,this.getMembersAndWatchers=()=>{const a=Object.values(this.channel.state.members??{}).map(({user:c})=>c),o=Object.values(this.channel.state.watchers??{}),l=[...a,...o],d={};return l.forEach(c=>{c&&!d[c.id]&&(d[c.id]=c)}),Object.values(d)},this.searchMembersLocally=a=>{const{textComposerText:o}=this.config;return o?this.getMembersAndWatchers().filter(l=>{if(l.id===this.client.userID)return!1;if(!a)return!0;const d=this.transliterate(us(l.id)).toLowerCase(),c=this.transliterate(us(l.name)).toLowerCase(),h=this.transliterate(us(a)).toLowerCase(),f=3,m=o.slice(-4).includes("@");if(c){const p=Ni(h,c);if(c.includes(h)||p<=f&&m)return!0}const u=Ni(h,d);return d.includes(h)||u<=f&&m}).sort((l,d)=>{if(!this.memberSort)return(l.name||"").localeCompare(d.name||"");for(const[c,h]of Object.entries(this.memberSort)){const f=l[c],m=d[c];if(f!==m)return h===1?String(f||"").localeCompare(String(m||"")):String(m||"").localeCompare(String(f||""))}return 0}):[]},this.prepareQueryUsersParams=a=>({filters:{$or:[{id:{$autocomplete:a}},{name:{$autocomplete:a}}],...this.userFilters},sort:this.userSort??[{name:1},{id:1}],options:{...this.searchOptions,limit:this.pageSize,offset:this.offset}}),this.prepareQueryMembersParams=a=>{let l=[{user_id:1}];return this.memberSort?Array.isArray(this.memberSort)?l=this.memberSort[0]:Object.keys(this.memberSort).length===1&&(l=this.memberSort):l=[{user_id:1}],{filters:this.memberFilters??{name:{$autocomplete:a}},sort:l,options:{...this.searchOptions,limit:this.pageSize,offset:this.offset}}},this.queryUsers=async a=>{const{filters:o,sort:l,options:d}=this.prepareQueryUsersParams(a),{users:c}=await this.client.queryUsers(o,l,d);return c},this.queryMembers=async a=>{const{filters:o,sort:l,options:d}=this.prepareQueryMembersParams(a);return(await this.channel.queryMembers(o,l,d)).members.map(h=>h.user)},this.filterMutes=a=>{const{textComposerText:o}=this.config;if(!o)return[];const{mutedUsers:l}=this.client;return o.includes("/unmute")&&!l.length?[]:l.length?o.includes("/unmute")?a.filter(d=>l.some(c=>c.target.id===d.id)):a.filter(d=>l.every(c=>c.target.id!==d.id)):a},this.client=e.getClient(),this.channel=e,this.config={mentionAllAppUsers:s,textComposerText:i},n&&(this.transliterate=n)}get allMembersLoadedWithInitialChannelQuery(){return Object.keys(this.channel.state.members||{}).length<ro}getStateBeforeFirstQuery(e){const t=super.getStateBeforeFirstQuery(e),{items:s}=this.state.getLatestValue();return{...t,items:s}}async query(e){let t;const s=this.allMembersLoadedWithInitialChannelQuery||!e;return this.config.mentionAllAppUsers?t=await this.queryUsers(e):s?t=this.searchMembersLocally(e):t=await this.queryMembers(e),{items:t.map(i=>({...i,...rc({displayName:i.name||i.id,searchToken:this.searchQuery})}))}}filterQueryResults(e){return this.filterMutes(e)}},dc={minChars:1,trigger:"@"},hc=e=>{const{tokenizedDisplayName:t,...s}=e;return s},uc=(e,t)=>{const s=he(dc,{});let i;return i=new cc(e),i.activate(),{id:"stream-io/text-composer/mentions-middleware",handlers:{onChange:({state:n,next:r,complete:a,forward:o})=>{if(!n.selection)return o();const l=lr({trigger:s.trigger,text:n.text.slice(0,n.selection.end)});if(l&&l.length===s.minChars&&i.resetStateAndActivate(),!l||l.length<s.minChars){const h=n.suggestions?.trigger===s.trigger,f={...n};return h&&delete f.suggestions,r(f)}return i.config.textComposerText=n.text,a({...n,suggestions:{query:l.slice(1),searchSource:i,trigger:s.trigger}})},onSuggestionItemSelect:({state:n,complete:r,forward:a})=>{const{selectedSuggestion:o}=n.change??{};return!o||n.suggestions?.trigger!==s.trigger?a():(i.resetStateAndActivate(),r({...n,...cr({insertText:`@${o.name||o.id} `,selection:n.selection,text:n.text,trigger:s.trigger}),mentionedUsers:n.mentionedUsers.concat(hc(o)),suggestions:void 0}))}}}},fc=e=>({id:"stream-io/text-composer/pre-validation-middleware",handlers:{onChange:({state:t,next:s,forward:i})=>{const{maxLengthOnEdit:n}=e.config.text??{};return typeof n=="number"&&t.text.length>n?(t.text=t.text.slice(0,n),s({...t,text:t.text})):i()},onSuggestionItemSelect:({forward:t})=>t()}}),pc=class extends ne{constructor({composer:e}){super(),this.use([fc(e),uc(e.channel),lc(e.channel)])}async execute({eventName:e,initialValue:t}){const s=await this.executeMiddlewareChain({eventName:e,initialValue:t}),{query:i,searchSource:n}=s.state.suggestions??{};return n?.search(i)?.catch(console.error),s}},dr=e=>{const t=e.trim();return t===""||t===">"||t==="``````"||t==="``"||t==="**"||t==="____"||t==="__"||t==="****"},Fi=({composer:e,message:t})=>{if(!t){const i=e.config.text.defaultValue??"";return{command:null,mentionedUsers:[],text:i,selection:{start:i.length,end:i.length}}}const s=t.text??"";return{mentionedUsers:(t.mentioned_users??[]).map(i=>typeof i=="string"?{id:i}:i),text:s,selection:{start:s.length,end:s.length}}},gc=class{constructor({composer:e,message:t}){this.initState=({message:s}={})=>{this.state.next(Fi({composer:this.composer,message:s}))},this.upsertMentionedUser=s=>{const i=[...this.mentionedUsers],n=i.findIndex(r=>r.id===s.id);n>=0?(i.splice(n,1,s),this.state.partialNext({mentionedUsers:i})):(i.push(s),this.state.partialNext({mentionedUsers:i}))},this.getMentionedUser=s=>this.state.getLatestValue().mentionedUsers.find(i=>i.id===s),this.removeMentionedUser=s=>{const i=this.mentionedUsers.findIndex(r=>r.id===s);if(i===-1)return;const n=[...this.mentionedUsers];n.splice(i,1),this.state.partialNext({mentionedUsers:n})},this.setCommand=s=>{s?.name!==this.command?.name&&this.state.partialNext({command:s})},this.setText=s=>{!this.enabled||s===this.text||this.state.partialNext({text:s})},this.setSelection=s=>{const i=s.start!==this.selection.start||s.end!==this.selection.end;!this.enabled||!i||this.state.partialNext({selection:s})},this.insertText=async({text:s,selection:i})=>{if(!this.enabled)return;const n=i??this.selection,{maxLengthOnEdit:r}=this.composer.config.text??{},a=this.text,o=[a.slice(0,n.start),s,a.slice(n.end)].join(""),l=o.slice(0,typeof r=="number"?r:o.length),d=a.slice(0,n.start).length+s.length,c=d>=l.length?l.length:a.slice(0,d).length;await this.handleChange({text:l,selection:{start:c,end:c}})},this.wrapSelection=({head:s="",selection:i,tail:n=""})=>{if(!this.enabled)return;const r=i??this.selection,a=this.text.slice(0,r.start),o=this.text.slice(r.start,r.end),l=this.text.slice(r.end),d={start:a.length+s.length,end:a.length+s.length+o.length};this.state.partialNext({text:[a,s,o,n,l].join(""),selection:d})},this.setSuggestions=s=>{this.state.partialNext({suggestions:s})},this.closeSuggestions=()=>{const{suggestions:s}=this.state.getLatestValue();s&&this.state.partialNext({suggestions:void 0})},this.handleChange=async({text:s,selection:i})=>{if(!this.enabled)return;const n=await this.middlewareExecutor.execute({eventName:"onChange",initialValue:{...this.state.getLatestValue(),text:s,selection:i}});n.status!=="discard"&&(this.state.next(n.state),this.config.publishTypingEvents&&s&&xn(this.channel.keystroke(this.composer.threadId??void 0),"start typing event"))},this.handleSelect=async s=>{if(!this.enabled)return;const i=await this.middlewareExecutor.execute({eventName:"onSuggestionItemSelect",initialValue:{...this.state.getLatestValue(),change:{selectedSuggestion:s}}});i?.status!=="discard"&&this.state.next(i.state)},this.composer=e,this.state=new x(Fi({composer:e,message:t})),this.middlewareExecutor=new pc({composer:e})}get channel(){return this.composer.channel}get config(){return this.composer.config.text}get enabled(){return this.composer.config.text.enabled}set enabled(e){e!==this.enabled&&this.composer.updateConfig({text:{enabled:e}})}get defaultValue(){return this.composer.config.text.defaultValue}set defaultValue(e){e!==this.defaultValue&&this.composer.updateConfig({text:{defaultValue:e}})}get maxLengthOnEdit(){return this.composer.config.text.maxLengthOnEdit}set maxLengthOnEdit(e){e!==this.maxLengthOnEdit&&this.composer.updateConfig({text:{maxLengthOnEdit:e}})}get maxLengthOnSend(){return this.composer.config.text.maxLengthOnSend}set maxLengthOnSend(e){e!==this.maxLengthOnSend&&this.composer.updateConfig({text:{maxLengthOnSend:e}})}get publishTypingEvents(){return this.composer.config.text.publishTypingEvents}set publishTypingEvents(e){e!==this.publishTypingEvents&&this.composer.updateConfig({text:{publishTypingEvents:e}})}get command(){return this.state.getLatestValue().command}get mentionedUsers(){return this.state.getLatestValue().mentionedUsers}get selection(){return this.state.getLatestValue().selection}get suggestions(){return this.state.getLatestValue().suggestions}get text(){return this.state.getLatestValue().text}get textIsEmpty(){return dr(this.text)}setMentionedUsers(e){this.state.partialNext({mentionedUsers:e})}clearCommand(){this.state.partialNext({command:null})}},Fs=class qs{constructor(){this.unsubscribeFunctions=new Set,this.refCount=0}get hasSubscriptions(){return this.unsubscribeFunctions.size>0}addUnsubscribeFunction(t){this.unsubscribeFunctions.add(t)}incrementRefCount(){return++this.refCount}unregisterSubscriptions(){return this.refCount>1?(this.refCount--,qs.symbol):(this.unsubscribeFunctions.forEach(t=>t()),this.unsubscribeFunctions.clear(),this.refCount=0,qs.symbol)}};Fs.symbol=Symbol(Fs.name);var ae=Fs,fs=50,mc=[{created_at:-1}],yc=1e3,_c={active_participant_count:!0,channel:!0,channel_cid:!0,created_at:!0,created_by:!0,created_by_user_id:!0,deleted_at:!0,draft:!0,last_message_at:!0,latest_replies:!0,parent_message:!0,parent_message_id:!0,participant_count:!0,read:!0,reply_count:!0,thread_participants:!0,title:!0,updated_at:!0},qi=e=>{const t={};for(const s in e){if(_c[s])continue;const i=s;t[i]=e[i]}return t},Ie=class extends ae{constructor({client:e,threadData:t}){super(),this.failedRepliesMap=new Map,this.activate=()=>{this.state.partialNext({active:!0})},this.deactivate=()=>{this.state.partialNext({active:!1})},this.reload=async()=>{if(!this.state.getLatestValue().isLoading){this.state.partialNext({isLoading:!0});try{const n=await this.client.getThread(this.id,{watch:!0});this.hydrateState(n)}finally{this.state.partialNext({isLoading:!1})}}},this.hydrateState=n=>{if(n===this)return;if(n.id!==this.id)throw new Error("Cannot hydrate thread's state using thread with different threadId");const{createdAt:r,custom:a,title:o,deletedAt:l,parentMessage:d,participants:c,read:h,replyCount:f,replies:m,updatedAt:u}=n.state.getLatestValue(),p=Array.from(this.failedRepliesMap.values());this.state.partialNext({title:o,createdAt:r,custom:a,deletedAt:l,parentMessage:d,participants:c,read:h,replyCount:f,replies:p.length?m.concat(p):m,updatedAt:u,isStateStale:!1})},this.registerSubscriptions=()=>{this.hasSubscriptions||(this.addUnsubscribeFunction(this.subscribeThreadUpdated()),this.addUnsubscribeFunction(this.subscribeMarkActiveThreadRead()),this.addUnsubscribeFunction(this.subscribeReloadActiveStaleThread()),this.addUnsubscribeFunction(this.subscribeMarkThreadStale()),this.addUnsubscribeFunction(this.subscribeNewReplies()),this.addUnsubscribeFunction(this.subscribeRepliesRead()),this.addUnsubscribeFunction(this.subscribeMessageDeleted()),this.addUnsubscribeFunction(this.subscribeMessageUpdated()))},this.subscribeThreadUpdated=()=>this.client.on("thread.updated",n=>{if(!n.thread||n.thread.parent_message_id!==this.id)return;const r=n.thread;this.state.partialNext({title:r.title,updatedAt:new Date(r.updated_at),deletedAt:r.deleted_at?new Date(r.deleted_at):null,custom:qi(r)})}).unsubscribe,this.subscribeMarkActiveThreadRead=()=>this.state.subscribeWithSelector(n=>({active:n.active,unreadMessageCount:Bi(this.client.userID)(n)}),({active:n,unreadMessageCount:r})=>{!n||!r||this.throttledMarkAsRead()}),this.subscribeReloadActiveStaleThread=()=>this.state.subscribeWithSelector(n=>({active:n.active,isStateStale:n.isStateStale}),({active:n,isStateStale:r})=>{n&&r&&this.reload()}),this.subscribeMarkThreadStale=()=>this.client.on("user.watching.stop",n=>{const{channel:r}=this.state.getLatestValue();!this.client.userID||this.client.userID!==n.user?.id||n.channel?.cid!==r.cid||this.state.partialNext({isStateStale:!0})}).unsubscribe,this.subscribeNewReplies=()=>this.client.on("message.new",n=>{if(!this.client.userID||n.message?.parent_id!==this.id)return;const r=n.message.user?.id===this.client.userID,{active:a,read:o}=this.state.getLatestValue();this.upsertReplyLocally({message:n.message,timestampChanged:r}),a&&this.throttledMarkAsRead();const l={};for(const d of Object.keys(o)){const c=o[d];if(c){let h=c;d===n.user?.id?h={...h,lastReadAt:n.created_at?new Date(n.created_at):new Date,user:n.user,unreadMessageCount:0}:a&&d===this.client.userID||(h={...h,unreadMessageCount:c.unreadMessageCount+1}),l[d]=h}}this.state.partialNext({read:l})}).unsubscribe,this.subscribeRepliesRead=()=>this.client.on("message.read",n=>{if(!n.user||!n.created_at||!n.thread||n.thread.parent_message_id!==this.id)return;const r=n.user.id,a=n.created_at,o=n.user;this.state.next(l=>({...l,read:{...l.read,[r]:{lastReadAt:new Date(a),user:o,lastReadMessageId:n.last_read_message_id,unreadMessageCount:0}}}))}).unsubscribe,this.subscribeMessageDeleted=()=>this.client.on("message.deleted",n=>{n.message&&(n.message.parent_id===this.id&&(n.hard_delete?this.deleteReplyLocally({message:n.message}):this.upsertReplyLocally({message:n.message})),n.message.id===this.id&&this.updateParentMessageLocally({message:n.message}))}).unsubscribe,this.subscribeMessageUpdated=()=>{const r=["message.updated","reaction.new","reaction.deleted","reaction.updated"].map(a=>this.client.on(a,o=>{o.message&&this.updateParentMessageOrReplyLocally(o.message)}).unsubscribe);return()=>r.forEach(a=>a())},this.unregisterSubscriptions=()=>{const n=super.unregisterSubscriptions();return this.state.partialNext({isStateStale:!0}),n},this.deleteReplyLocally=({message:n})=>{const{replies:r}=this.state.getLatestValue(),a=Ln({needle:I(n),sortedArray:r,sortDirection:"ascending",selectValueToCompare:l=>l.created_at.getTime(),selectKey:l=>l.id});if(r[a]?.id!==n.id)return;const o=[...r];o.splice(a,1),this.state.partialNext({replies:o})},this.upsertReplyLocally=({message:n,timestampChanged:r=!1})=>{if(n.parent_id!==this.id)throw new Error("Reply does not belong to this thread");const a=I(n);n.status==="failed"?this.failedRepliesMap.set(a.id,a):this.failedRepliesMap.has(n.id)&&this.failedRepliesMap.delete(n.id),this.state.next(o=>({...o,replies:Tn(o.replies,a,r)}))},this.updateParentMessageLocally=({message:n})=>{if(n.id!==this.id)throw new Error("Message does not belong to this thread");this.state.next(r=>{const a=I(n);return{...r,deletedAt:a.deleted_at,parentMessage:a,replyCount:n.reply_count??r.replyCount}})},this.updateParentMessageOrReplyLocally=n=>{n.parent_id===this.id&&this.upsertReplyLocally({message:n}),!n.parent_id&&n.id===this.id&&this.updateParentMessageLocally({message:n})},this.markAsRead=async({force:n=!1}={})=>this.ownUnreadCount===0&&!n?null:await this.channel.markRead({thread_id:this.id}),this.throttledMarkAsRead=In(()=>this.markAsRead(),yc,{trailing:!0}),this.queryReplies=({limit:n=fs,sort:r=mc,...a}={})=>this.channel.getReplies(this.id,{limit:n,...a},r),this.loadNextPage=({limit:n=fs}={})=>this.loadPage(n),this.loadPrevPage=({limit:n=fs}={})=>this.loadPage(-n),this.loadPage=async n=>{const{pagination:r}=this.state.getLatestValue(),[a,o,l]=n>0?["isLoadingNext","nextCursor","push"]:["isLoadingPrev","prevCursor","unshift"];if(r[a]||r[o]===null)return;const d={[n>0?"id_gt":"id_lt"]:r[o]},c=Math.abs(n);this.state.partialNext({pagination:{...r,[a]:!0}});try{const h=await this.queryReplies({...d,limit:c}),f=h.messages.map(I),m=f.at(n>0?-1:0)?.id??null;this.state.next(u=>{let p=u.replies;return f.length>0&&(p=[...u.replies],p[l](...f)),{...u,replies:p,pagination:{...u.pagination,[o]:h.messages.length<c?null:m,[a]:!1}}})}catch(h){this.client.logger("error",h.message),this.state.next(f=>({...f,pagination:{...f.pagination,[a]:!1}}))}};const s=e.channel(t.channel.type,t.channel.id,{name:t.channel.name});s._hydrateMembers({members:t.channel.members??[],overrideCurrentState:!1});const i=e.userID?[{user:{id:e.userID},unread_messages:0,last_read:new Date().toISOString()}]:[];this.state=new x({active:!1,isLoading:!1,isStateStale:!1,channel:s,createdAt:new Date(t.created_at),deletedAt:t.deleted_at?new Date(t.deleted_at):null,pagination:bc(t),parentMessage:I(t.parent_message),participants:t.thread_participants,read:wc(!t.read||t.read.length===0?i:t.read),replies:t.latest_replies.map(I),replyCount:t.reply_count??0,updatedAt:t.updated_at?new Date(t.updated_at):null,title:t.title,custom:qi(t)}),this.id=t.parent_message_id,this.client=e,this.messageComposer=new Ft({client:e,composition:t.draft,compositionContext:this})}get channel(){return this.state.getLatestValue().channel}get hasStaleState(){return this.state.getLatestValue().isStateStale}get ownUnreadCount(){return Bi(this.client.userID)(this.state.getLatestValue())}},wc=e=>e.reduce((t,s)=>(t[s.user.id]={user:s.user,lastReadMessageId:s.last_read_message_id,unreadMessageCount:s.unread_messages??0,lastReadAt:new Date(s.last_read)},t),{}),bc=e=>({nextCursor:null,prevCursor:e.latest_replies.length===e.reply_count?null:e.latest_replies.at(0)?.id??null,isLoadingNext:!1,isLoadingPrev:!1}),Bi=e=>t=>e&&t.read[e]?.unreadMessageCount||0,De=e=>!!e?.message,vc=e=>{let t=null,s=new Date().getTime();return De(e)?s=t=new Date(e.created_at).getTime():e&&kn(e)&&(s=new Date(e.updated_at).getTime()),{lastChange:{draftUpdate:t,stateUpdate:s}}},$i=e=>{if(!e)return{draftId:null,id:Ft.generateId(),pollId:null,quotedMessage:null,showReplyInChannel:!1};const t=e.quoted_message;let s,i=null,n=Ft.generateId();return De(e)?(s=e.message,i=e.message.id):(s=e,n=e.id),{draftId:i,id:n,pollId:s.poll_id??null,quotedMessage:t?I(t):null,showReplyInChannel:!1}},hr=class it extends ae{constructor({composition:t,config:s,compositionContext:i,client:n}){if(super(),this.refreshId=()=>{this.state.partialNext({id:it.generateId()})},this.initState=({composition:o}={})=>{this.editingAuditState.partialNext(this.initEditingAuditState(o));const l=typeof o>"u"?o:De(o)?o.message:I(o);this.attachmentManager.initState({message:l}),this.linkPreviewsManager.initState({message:l}),this.locationComposer.initState({message:l}),this.textComposer.initState({message:l}),this.pollComposer.initState(),this.customDataManager.initState({message:l}),this.state.next($i(o)),o&&!De(o)&&l&&kn(l)&&(this.editedMessage=l)},this.initStateFromChannelResponse=o=>{this.channel.cid===o.channel.cid&&(o.draft?this.initState({composition:o.draft}):this.state.getLatestValue().draftId&&(this.clear(),this.client.offlineDb?.executeQuerySafely(l=>l.deleteDraft({cid:this.channel.cid,parent_id:void 0}),{method:"deleteDraft"})))},this.initEditingAuditState=o=>vc(o),this.registerDraftEventSubscriptions=()=>{const o=this.subscribeDraftUpdated(),l=this.subscribeDraftDeleted();return()=>{o(),l()}},this.registerSubscriptions=()=>(this.hasSubscriptions||(this.addUnsubscribeFunction(this.subscribeMessageComposerSetupStateChange()),this.addUnsubscribeFunction(this.subscribeMessageUpdated()),this.addUnsubscribeFunction(this.subscribeMessageDeleted()),this.addUnsubscribeFunction(this.subscribeTextComposerStateChanged()),this.addUnsubscribeFunction(this.subscribeAttachmentManagerStateChanged()),this.addUnsubscribeFunction(this.subscribeLinkPreviewsManagerStateChanged()),this.addUnsubscribeFunction(this.subscribeLocationComposerStateChanged()),this.addUnsubscribeFunction(this.subscribePollComposerStateChanged()),this.addUnsubscribeFunction(this.subscribeCustomDataManagerStateChanged()),this.addUnsubscribeFunction(this.subscribeMessageComposerStateChanged()),this.addUnsubscribeFunction(this.subscribeMessageComposerConfigStateChanged())),this.incrementRefCount(),()=>this.unregisterSubscriptions()),this.subscribeMessageUpdated=()=>{const l=["message.updated","reaction.new","reaction.deleted","reaction.updated"].map(d=>this.client.on(d,c=>{c.message&&(c.message.id===this.id&&this.initState({composition:c.message}),this.quotedMessage?.id&&c.message.id===this.quotedMessage.id&&this.setQuotedMessage(I(c.message)))}).unsubscribe);return()=>l.forEach(d=>d())},this.subscribeMessageComposerSetupStateChange=()=>{let o=null;const l=this.client._messageComposerSetupState.subscribeWithSelector(({setupFunction:d})=>({setup:d}),({setup:d})=>{o?.(),o=d?.({composer:this})??null});return()=>{o?.(),l()}},this.subscribeMessageDeleted=()=>this.client.on("message.deleted",o=>{o.message&&(o.message.id===this.id?this.clear():this.quotedMessage&&o.message.id===this.quotedMessage.id&&this.setQuotedMessage(null))}).unsubscribe,this.subscribeDraftUpdated=()=>this.client.on("draft.updated",o=>{const l=o.draft;!l||(l.parent_id??null)!==(this.threadId??null)||l.channel_cid!==this.channel.cid||this.initState({composition:l})}).unsubscribe,this.subscribeDraftDeleted=()=>this.client.on("draft.deleted",o=>{const l=o.draft;!l||(l.parent_id??null)!==(this.threadId??null)||l.channel_cid!==this.channel.cid||(this.logDraftUpdateTimestamp(),!this.compositionIsEmpty&&this.clear())}).unsubscribe,this.subscribeTextComposerStateChanged=()=>this.textComposer.state.subscribeWithSelector(({text:o})=>[o],([o],l)=>{if(!(typeof l>"u")){if(this.logStateUpdateTimestamp(),this.compositionIsEmpty){this.deleteDraft();return}this.linkPreviewsManager.enabled&&(o?this.linkPreviewsManager.findAndEnrichUrls(o):this.linkPreviewsManager.clearPreviews())}}),this.subscribeAttachmentManagerStateChanged=()=>this.attachmentManager.state.subscribe((o,l)=>{if(!(typeof l>"u")&&(this.logStateUpdateTimestamp(),this.compositionIsEmpty)){this.deleteDraft();return}}),this.subscribeLocationComposerStateChanged=()=>this.locationComposer.state.subscribe((o,l)=>{if(!(typeof l>"u")&&(this.logStateUpdateTimestamp(),this.compositionIsEmpty)){this.deleteDraft();return}}),this.subscribeLinkPreviewsManagerStateChanged=()=>this.linkPreviewsManager.state.subscribe((o,l)=>{if(!(typeof l>"u")&&(this.logStateUpdateTimestamp(),this.compositionIsEmpty)){this.deleteDraft();return}}),this.subscribePollComposerStateChanged=()=>this.pollComposer.state.subscribe((o,l)=>{if(!(typeof l>"u")&&(this.logStateUpdateTimestamp(),this.compositionIsEmpty)){this.deleteDraft();return}}),this.subscribeCustomDataManagerStateChanged=()=>this.customDataManager.state.subscribe((o,l)=>{typeof l<"u"&&!this.customDataManager.isMessageDataEqual(o,l)&&this.logStateUpdateTimestamp()}),this.subscribeMessageComposerStateChanged=()=>this.state.subscribe((o,l)=>{typeof l>"u"||(this.logStateUpdateTimestamp(),this.compositionIsEmpty&&this.deleteDraft())}),this.subscribeMessageComposerConfigStateChanged=()=>{let o;const l=this.configState.subscribeWithSelector(d=>({textDefaultValue:d.text.defaultValue,draftsEnabled:d.drafts.enabled}),({textDefaultValue:d,draftsEnabled:c})=>{this.textComposer.text===""&&d&&this.textComposer.insertText({text:d,selection:{start:0,end:0}}),c&&!o?o=this.registerDraftEventSubscriptions():!c&&o&&(o(),o=null)});return()=>{o?.(),l()}},this.setQuotedMessage=o=>{this.state.partialNext({quotedMessage:o})},this.toggleShowReplyInChannel=()=>{this.state.partialNext({showReplyInChannel:!this.showReplyInChannel})},this.clear=()=>{this.setQuotedMessage(null),this.initState()},this.restore=()=>{const{editedMessage:o}=this;if(o){this.initState({composition:o});return}this.clear()},this.compose=async()=>{const o=this.editedMessage?.created_at??new Date,d=await this.compositionMiddlewareExecutor.execute({eventName:"compose",initialValue:{message:{id:this.id,parent_id:this.threadId??void 0,type:"regular"},localMessage:{attachments:[],created_at:o,deleted_at:null,error:void 0,id:this.id,mentioned_users:[],parent_id:this.threadId??void 0,pinned_at:this.editedMessage?.pinned_at||null,reaction_groups:null,status:this.editedMessage?this.editedMessage.status:"sending",text:"",type:"regular",updated_at:o},sendOptions:{}}});if(d.status!=="discard")return d.state},this.composeDraft=async()=>{const{state:o,status:l}=await this.draftCompositionMiddlewareExecutor.execute({eventName:"compose",initialValue:{draft:{id:this.id,parent_id:this.threadId??void 0,text:""}}});if(l!=="discard")return o},this.createDraft=async()=>{if(this.editedMessage||!this.config.drafts.enabled)return;const o=await this.composeDraft();if(!o)return;const{draft:l}=o;if(this.state.partialNext({draftId:l.id}),this.client.offlineDb)try{const d={channel_cid:this.channel.cid,created_at:new Date().toISOString(),message:l,parent_id:l.parent_id,quoted_message:this.quotedMessage?So(this.quotedMessage):void 0};await this.client.offlineDb.upsertDraft({draft:d})}catch(d){this.client.logger("error","offlineDb:upsertDraft",{tags:["channel","offlineDb"],error:d})}this.logDraftUpdateTimestamp(),await this.channel.createDraft(l)},this.deleteDraft=async()=>{if(this.editedMessage||!this.config.drafts.enabled||!this.draftId)return;this.state.partialNext({draftId:null});const o=this.threadId??void 0;if(this.client.offlineDb)try{await this.client.offlineDb.deleteDraft({cid:this.channel.cid,parent_id:o})}catch(l){this.client.logger("error","offlineDb:deleteDraft",{tags:["channel","offlineDb"],error:l})}this.logDraftUpdateTimestamp(),await this.channel.deleteDraft({parent_id:o})},this.getDraft=async()=>{if(this.editedMessage||!this.config.drafts.enabled||!this.client.userID)return;const o=await this.client.offlineDb?.getDraft({cid:this.channel.cid,userId:this.client.userID,parent_id:this.threadId??void 0});o&&this.initState({composition:o});try{const l=await this.channel.getDraft({parent_id:this.threadId??void 0}),{draft:d}=l;if(!d)return;this.client.offlineDb?.executeQuerySafely(c=>c.upsertDraft({draft:d}),{method:"upsertDraft"}),this.initState({composition:d})}catch{this.client.notifications.add({message:"Failed to get the draft",origin:{emitter:"MessageComposer",context:{composer:this}}})}},this.createPoll=async()=>{const o=await this.pollComposer.compose();if(!(!o||!o.data.id))try{const l=await this.client.polls.createPoll(o.data);this.state.partialNext({pollId:l?.id})}catch(l){throw this.client.notifications.addError({message:"Failed to create the poll",origin:{emitter:"MessageComposer",context:{composer:this}},options:{type:"api:poll:create:failed",metadata:{reason:l.message},originalError:l instanceof Error?l:void 0}}),l}},this.sendLocation=async()=>{const o=this.locationComposer.validLocation;if(!(this.threadId||!o))try{await this.channel.sendSharedLocation(o),this.refreshId(),this.locationComposer.initState()}catch(l){throw this.client.notifications.addError({message:"Failed to share the location",origin:{emitter:"MessageComposer",context:{composer:this}},options:{type:"api:location:create:failed",metadata:{reason:l.message},originalError:l instanceof Error?l:void 0}}),l}},this.compositionContext=i,i instanceof ue)this.channel=i;else if(i instanceof Ie)this.channel=i.channel;else if(i.cid){const[o,l]=i.cid.split(":");this.channel=n.channel(o,l)}else throw new Error("MessageComposer requires composition context pointing to channel (channel or context.cid)");const r=(o,l,d)=>typeof o=="object"?void 0:o===!1&&d==="enabled"?!1:["string","number","bigint","boolean","symbol"].includes(typeof l)?l:o;this.configState=new x(he(he(yl,s??{}),{location:{enabled:this.channel.getConfig()?.shared_locations}},r));let a;De(t)?a=t.message:t&&(a=I(t),this.editedMessage=a),this.attachmentManager=new Yo({composer:this,message:a}),this.linkPreviewsManager=new ii({composer:this,message:a}),this.locationComposer=new vl({composer:this,message:a}),this.textComposer=new gc({composer:this,message:a}),this.pollComposer=new Dl({composer:this}),this.customDataManager=new _l({composer:this,message:a}),this.editingAuditState=new x(this.initEditingAuditState(t)),this.state=new x($i(t)),this.compositionMiddlewareExecutor=new Yl({composer:this}),this.draftCompositionMiddlewareExecutor=new Xl({composer:this})}static evaluateContextType(t){return t instanceof ue?"channel":t instanceof Ie?"thread":typeof t.legacyThreadId=="string"?"legacy_thread":"message"}static constructTag(t){return`${this.evaluateContextType(t)}_${t.id}`}get config(){return this.configState.getLatestValue()}updateConfig(t){this.configState.partialNext(he(this.config,t))}get contextType(){return it.evaluateContextType(this.compositionContext)}get tag(){return it.constructTag(this.compositionContext)}get threadId(){return this.compositionContext instanceof ue?null:this.compositionContext instanceof Ie?this.compositionContext.id:typeof this.compositionContext.legacyThreadId=="string"?this.compositionContext.legacyThreadId:typeof this.compositionContext.parent_id=="string"?this.compositionContext.parent_id:null}get client(){return this.channel.getClient()}get id(){return this.state.getLatestValue().id}get draftId(){return this.state.getLatestValue().draftId}get lastChange(){return this.editingAuditState.getLatestValue().lastChange}get quotedMessage(){return this.state.getLatestValue().quotedMessage}get pollId(){return this.state.getLatestValue().pollId}get showReplyInChannel(){return this.state.getLatestValue().showReplyInChannel}get hasSendableData(){return this.client.offlineDb?!this.compositionIsEmpty:!!(!this.attachmentManager.uploadsInProgressCount&&(!this.textComposer.textIsEmpty||this.attachmentManager.successfulUploadsCount>0)||this.pollId||this.locationComposer.validLocation)}get compositionIsEmpty(){return!this.quotedMessage&&this.textComposer.textIsEmpty&&!this.attachmentManager.attachments.length&&!this.pollId&&!this.locationComposer.validLocation}get lastChangeOriginIsLocal(){const s=this.lastChange.draftUpdate===null&&!this.editedMessage,i=!!this.editedMessage?.updated_at&&new Date(this.editedMessage.updated_at).getTime()<this.lastChange.stateUpdate,n=!!this.lastChange.draftUpdate&&this.lastChange.draftUpdate<this.lastChange.stateUpdate;return i||n||s}logStateUpdateTimestamp(){this.editingAuditState.partialNext({lastChange:{...this.lastChange,stateUpdate:new Date().getTime()}})}logDraftUpdateTimestamp(){if(!this.config.drafts.enabled)return;const t=new Date().getTime();this.editingAuditState.partialNext({lastChange:{draftUpdate:t,stateUpdate:t}})}};hr.generateId=P;var Ft=hr,ue=class{constructor(e,t,s,i){this.create=async a=>{const o={...a,watch:!1,state:!1,presence:!1};return await this.query(o,"latest")},this._callChannelListeners=a=>{const o=this,l=[];o.listeners.all&&l.push(...o.listeners.all),o.listeners[a.type]&&l.push(...o.listeners[a.type]);for(const d of l)typeof d!="string"&&d(a)},this._channelURL=()=>{if(!this.id)throw new Error("channel id is not defined");return`${this.getClient().baseURL}/channels/${encodeURIComponent(this.type)}/${encodeURIComponent(this.id)}`};const n=/^[\w_-]+$/,r=/^[\w!_-]+$/;if(!n.test(t))throw new Error(`Invalid chat type ${t}, letters, numbers and "_-" are allowed`);if(typeof s=="string"&&!r.test(s))throw new Error(`Invalid chat id ${s}, letters, numbers and "!-_" are allowed`);this._client=e,this.type=t,this.id=s,this.data=i,this._data={...i},this.cid=`${t}:${s}`,this.listeners={},this.state=new Do(this),this.initialized=!1,this.offlineMode=!1,this.lastTypingEvent=null,this.isTyping=!1,this.disconnected=!1,this.messageComposer=new Ft({client:this._client,compositionContext:this})}getClient(){if(this.disconnected===!0)throw Error("You can't use a channel after client.disconnect() was called");return this._client}getConfig(){return this.getClient().configs[this.cid]}async _sendMessage(e,t){return await this.getClient().post(this._channelURL()+"/message",{message:e,...t})}async sendMessage(e,t){try{const s=this.getClient().offlineDb;if(s){const i=e.id;if(i)return await s.queueTask({task:{channelId:this.id,channelType:this.type,messageId:i,payload:[e,t],type:"send-message"}})}}catch(s){this._client.logger("error","offlineDb:send-message",{tags:["channel","offlineDb"],error:s})}return await this._sendMessage(e,t)}sendFile(e,t,s,i){return this.getClient().sendFile(`${this._channelURL()}/file`,e,t,s,i)}sendImage(e,t,s,i){return this.getClient().sendFile(`${this._channelURL()}/image`,e,t,s,i)}deleteFile(e){return this.getClient().delete(`${this._channelURL()}/file`,{url:e})}deleteImage(e){return this.getClient().delete(`${this._channelURL()}/image`,{url:e})}async sendEvent(e){return this._checkInitialized(),await this.getClient().post(this._channelURL()+"/event",{event:e})}async search(e,t={}){if(t.offset&&t.next)throw Error("Cannot specify offset with next");const s={filter_conditions:{cid:this.cid},...t,sort:t.sort?L(t.sort):void 0};if(typeof e=="string")s.query=e;else if(typeof e=="object")s.message_filter_conditions=e;else throw Error(`Invalid type ${typeof e} for query parameter`);return await this.getClient().wsPromise,await this.getClient().get(this.getClient().baseURL+"/search",{payload:s})}async queryMembers(e,t=[],s={}){let i;const n=this.type;let r;return this.id?i=this.id:this.data?.members&&Array.isArray(this.data.members)&&(r=this.data.members),await this.getClient().get(this.getClient().baseURL+"/members",{payload:{type:n,id:i,members:r,sort:L(t),filter_conditions:e,...s}})}async updateMemberPartial(e,t){const s=new URL(`${this._channelURL()}/member`);return t?.userId&&s.searchParams.append("user_id",t.userId),await this.getClient().patch(s.toString(),e)}async partialUpdateMember(e,t){if(!e)throw Error("Please specify the user id");return await this.getClient().patch(this._channelURL()+`/member/${encodeURIComponent(e)}`,t)}async sendReaction(e,t,s){if(!e)throw Error("Message id is missing");if(!t||Object.keys(t).length===0)throw Error("Reaction object is missing");try{const i=this.getClient().offlineDb;if(i)return await i.queueTask({task:{channelId:this.id,channelType:this.type,messageId:e,payload:[e,t,s],type:"send-reaction"}})}catch(i){this._client.logger("error","offlineDb:send-reaction",{tags:["channel","offlineDb"],error:i})}return this._sendReaction(e,t,s)}async _sendReaction(e,t,s){if(!e)throw Error("Message id is missing");if(!t||Object.keys(t).length===0)throw Error("Reaction object is missing");return await this.getClient().post(this.getClient().baseURL+`/messages/${encodeURIComponent(e)}/reaction`,{reaction:t,...s})}async deleteReaction(e,t,s){if(this._checkInitialized(),!t||!e)throw Error("Deleting a reaction requires specifying both the message and reaction type");try{const i=this.getClient().offlineDb;if(i){const n=this.state.messages.find(({id:a})=>a===e),r={created_at:"",updated_at:"",message_id:e,type:t,user_id:this.getClient().userID??s};return n&&await i.deleteReaction({message:n,reaction:r}),await i.queueTask({task:{channelId:this.id,channelType:this.type,messageId:e,payload:[e,t],type:"delete-reaction"}})}}catch(i){this._client.logger("error","offlineDb:delete-reaction",{tags:["channel","offlineDb"],error:i})}return await this._deleteReaction(e,t,s)}async _deleteReaction(e,t,s){if(this._checkInitialized(),!t||!e)throw Error("Deleting a reaction requires specifying both the message and reaction type");const i=this.getClient().baseURL+`/messages/${encodeURIComponent(e)}/reaction/${encodeURIComponent(t)}`;return s?await this.getClient().delete(i,{user_id:s}):await this.getClient().delete(i,{})}async update(e={},t,s){return["config","cid","created_by","id","member_count","type","created_at","updated_at","last_message_at","own_capabilities"].forEach(n=>{delete e[n]}),await this._update({message:t,data:e,...s})}async updatePartial(e){const t=await this.getClient().patch(this._channelURL(),e),s=[...t.channel.own_capabilities||[]].sort().join()!==[...Array.isArray(this.data?.own_capabilities)?this.data?.own_capabilities:[]].sort().join();return this.data=t.channel,s&&this.getClient().dispatchEvent({type:"capabilities.changed",cid:this.cid,own_capabilities:t.channel.own_capabilities}),t}async enableSlowMode(e){const t=await this.getClient().post(this._channelURL(),{cooldown:e});return this.data=t.channel,t}async disableSlowMode(){const e=await this.getClient().post(this._channelURL(),{cooldown:0});return this.data=e.channel,e}async sendSharedLocation(e,t){const s=await this.sendMessage({id:e.message_id,shared_location:e,user:t?{id:t}:void 0});return e.end_at&&this.getClient().dispatchEvent({message:s.message,type:"live_location_sharing.started"}),s}async stopLiveLocationSharing(e){const t=await this.getClient().updateLocation({...e,end_at:new Date().toISOString()});this.getClient().dispatchEvent({live_location:t,type:"live_location_sharing.stopped"})}async delete(e={}){return await this.getClient().delete(this._channelURL(),{...e})}async truncate(e={}){return await this.getClient().post(this._channelURL()+"/truncate",e)}async acceptInvite(e={}){return await this._update({accept_invite:!0,...e})}async rejectInvite(e={}){return await this._update({reject_invite:!0,...e})}async addMembers(e,t,s={}){return await this._update({add_members:e,message:t,...s})}async addModerators(e,t,s={}){return await this._update({add_moderators:e,message:t,...s})}async assignRoles(e,t,s={}){return await this._update({assign_roles:e,message:t,...s})}async inviteMembers(e,t,s={}){return await this._update({invites:e,message:t,...s})}async removeMembers(e,t,s={}){return await this._update({remove_members:e,message:t,...s})}async demoteModerators(e,t,s={}){return await this._update({demote_moderators:e,message:t,...s})}async _update(e){const t=await this.getClient().post(this._channelURL(),e);return this.data=t.channel,t}async mute(e={}){return await this.getClient().post(this.getClient().baseURL+"/moderation/mute/channel",{channel_cid:this.cid,...e})}async unmute(e={}){return await this.getClient().post(this.getClient().baseURL+"/moderation/unmute/channel",{channel_cid:this.cid,...e})}async archive(e={}){const t=this.getClient(),s=e.user_id||t.userID;if(!s)throw Error("A user_id is required for archiving a channel");return(await this.partialUpdateMember(s,{set:{archived:!0}})).channel_member}async unarchive(e={}){const t=this.getClient(),s=e.user_id||t.userID;if(!s)throw Error("A user_id is required for unarchiving a channel");return(await this.partialUpdateMember(s,{set:{archived:!1}})).channel_member}async pin(e={}){const t=this.getClient(),s=e.user_id||t.userID;if(!s)throw new Error("A user_id is required for pinning a channel");return(await this.partialUpdateMember(s,{set:{pinned:!0}})).channel_member}async unpin(e={}){const t=this.getClient(),s=e.user_id||t.userID;if(!s)throw new Error("A user_id is required for unpinning a channel");return(await this.partialUpdateMember(s,{set:{pinned:!1}})).channel_member}muteStatus(){return this._checkInitialized(),this.getClient()._muteStatus(this.cid)}sendAction(e,t){if(this._checkInitialized(),!e)throw Error("Message id is missing");return this.getClient().post(this.getClient().baseURL+`/messages/${encodeURIComponent(e)}/action`,{message_id:e,form_data:t,id:this.id,type:this.type})}async keystroke(e,t){if(!this._isTypingIndicatorsEnabled())return;const s=new Date,i=this.lastTypingEvent&&s.getTime()-this.lastTypingEvent.getTime();this.lastKeyStroke=s,this.isTyping=!0,(i===null||i>2e3)&&(this.lastTypingEvent=new Date,await this.sendEvent({type:"typing.start",parent_id:e,...t||{}}))}async updateAIState(e,t,s={}){await this.sendEvent({...s,type:"ai_indicator.update",message_id:e,ai_state:t})}async clearAIIndicator(){await this.sendEvent({type:"ai_indicator.clear"})}async stopAIResponse(){await this.sendEvent({type:"ai_indicator.stop"})}async stopTyping(e,t){this._isTypingIndicatorsEnabled()&&(this.lastTypingEvent=null,this.isTyping=!1,await this.sendEvent({type:"typing.stop",parent_id:e,...t||{}}))}_isTypingIndicatorsEnabled(){return!this.getConfig()?.typing_events||!this.getClient().wsConnection?.isHealthy?!1:this.getClient().user?.privacy_settings?.typing_indicators?.enabled??!0}lastMessage(){let e=this.state.latestMessages.length-5;e<0&&(e=0);const t=this.state.latestMessages.length+1,s=this.state.latestMessages.slice(e,t);return s.sort((i,n)=>n.created_at.getTime()-i.created_at.getTime()),s[0]}async markRead(e={}){return this._checkInitialized(),!this.getConfig()?.read_events&&!this.getClient()._isUsingServerAuth()?Promise.resolve(null):await this.getClient().post(this._channelURL()+"/read",{...e})}async markUnread(e){return this._checkInitialized(),!this.getConfig()?.read_events&&!this.getClient()._isUsingServerAuth()?Promise.resolve(null):await this.getClient().post(this._channelURL()+"/unread",{...e})}clean(){this.lastKeyStroke&&new Date().getTime()-this.lastKeyStroke.getTime()>1e3&&this.isTyping&&xn(this.stopTyping(),"stop typing event"),this.state.clean()}async watch(e){const t={state:!0,watch:!0,presence:!1};await this.getClient().wsPromise,this.getClient()._hasConnectionID()||(t.watch=!1);const s={...t,...e},i=await this.query(s,"latest");return this.initialized=!0,this.data=i.channel,this._client.logger("info",`channel:watch() - started watching channel ${this.cid}`,{tags:["channel"],channel:this}),i}async stopWatching(){const e=await this.getClient().post(this._channelURL()+"/stop-watching",{});return this._client.logger("info",`channel:watch() - stopped watching channel ${this.cid}`,{tags:["channel"],channel:this}),e}async getReplies(e,t,s){const i=s?L(s):void 0,n=await this.getClient().get(this.getClient().baseURL+`/messages/${encodeURIComponent(e)}/replies`,{sort:i,...t});return n.messages&&this.state.addMessagesSorted(n.messages),n}async getPinnedMessages(e,t=[]){return await this.getClient().get(this._channelURL()+"/pinned_messages",{payload:{...e,sort:L(t)}})}getReactions(e,t){return this.getClient().get(this.getClient().baseURL+`/messages/${encodeURIComponent(e)}/reactions`,{...t})}getMessagesById(e){return this.getClient().get(this._channelURL()+"/messages",{ids:e.join(",")})}lastRead(){const{userID:e}=this.getClient();if(e)return this.state.read[e]?this.state.read[e].last_read:null}_countMessageAsUnread(e){return!(e.shadowed||e.silent||e.parent_id&&!e.show_in_channel||e.user?.id===this.getClient().userID||e.user?.id&&this.getClient().userMuteStatus(e.user.id)||Array.isArray(this.data?.own_capabilities)&&!this.data?.own_capabilities.includes("read-events")||this.muteStatus().muted)}countUnread(e){if(!e)return this.state.unreadCount;let t=0;for(let s=0;s<this.state.latestMessages.length;s+=1){const i=this.state.latestMessages[s];i.created_at>e&&this._countMessageAsUnread(i)&&t++}return t}countUnreadMentions(){const e=this.lastRead(),t=this.getClient().userID;let s=0;for(let i=0;i<this.state.latestMessages.length;i+=1){const n=this.state.latestMessages[i];this._countMessageAsUnread(n)&&(!e||n.created_at>e)&&n.mentioned_users?.some(r=>r.id===t)&&s++}return s}async query(e={},t="current"){await this.getClient().wsPromise;const s=e.created_by?.id??e.created_by_id??this._data?.created_by?.id??this._data?.created_by_id;this.getClient()._isUsingServerAuth()&&typeof s!="string"&&this.getClient().logger("warn","Either `created_by` (with `id` property) or `created_by_id` are missing from both `Channel._data` and `options` parameter");let i=`${this.getClient().baseURL}/channels/${encodeURIComponent(this.type)}`;this.id&&(i+=`/${encodeURIComponent(this.id)}`);const n=await this.getClient().post(i+"/query",{data:this._data,state:!0,...e});if(!this.id){this.id=n.channel.id,this.cid=n.channel.cid;const o=Gs(this.type,n.members.map(l=>l.user_id||l.user?.id||""));o&&o in this.getClient().activeChannels&&delete this.getClient().activeChannels[o],!(this.cid in this.getClient().activeChannels)&&this.getClient()._cacheEnabled()&&(this.getClient().activeChannels[this.cid]=this)}this.getClient()._addChannelConfig(n.channel);const{messageSet:r}=this._initializeState(n,t);r.pagination={...r.pagination,...Dn({parentSet:r,messagePaginationOptions:e?.messages,requestedPageSize:e?.messages?.limit??so,returnedPage:n.messages,logger:this.getClient().logger})},this.getClient().polls.hydratePollCache(n.messages,!0),this.getClient().reminders.hydrateState(n.messages),this.messageComposer.initStateFromChannelResponse(n);const a=[...n.channel.own_capabilities||[]].sort().join()!==[...this.data&&Array.isArray(this.data?.own_capabilities)?this.data.own_capabilities:[]].sort().join();return this.data=n.channel,this.offlineMode=!1,a&&this.getClient().dispatchEvent({type:"capabilities.changed",cid:this.cid,own_capabilities:n.channel.own_capabilities}),this.getClient().dispatchEvent({type:"channels.queried",queriedChannels:{channels:[n],isLatestMessageSet:r.isLatest}}),this.getClient().offlineDb?.executeQuerySafely(o=>o.upsertChannels?.({channels:[n],isLatestMessagesSet:r.isLatest}),{method:"upsertChannels"}),n}async banUser(e,t){return this._checkInitialized(),await this.getClient().banUser(e,{...t,type:this.type,id:this.id})}async hide(e=null,t=!1){return this._checkInitialized(),await this.getClient().post(`${this._channelURL()}/hide`,{user_id:e,clear_history:t})}async show(e=null){return this._checkInitialized(),await this.getClient().post(`${this._channelURL()}/show`,{user_id:e})}async unbanUser(e){return this._checkInitialized(),await this.getClient().unbanUser(e,{type:this.type,id:this.id})}async shadowBan(e,t){return this._checkInitialized(),await this.getClient().shadowBan(e,{...t,type:this.type,id:this.id})}async removeShadowBan(e){return this._checkInitialized(),await this.getClient().removeShadowBan(e,{type:this.type,id:this.id})}async vote(e,t,s){return await this.getClient().castPollVote(e,t,s)}async removeVote(e,t,s){return await this.getClient().removePollVote(e,t,s)}async _createDraft(e){return await this.getClient().post(this._channelURL()+"/draft",{message:e})}async createDraft(e){try{const t=this.getClient().offlineDb;if(t)return await t.queueTask({task:{channelId:this.id,channelType:this.type,threadId:e.parent_id,payload:[e],type:"create-draft"}})}catch(t){this._client.logger("error","offlineDb:create-draft",{tags:["channel","offlineDb"],error:t})}return this._createDraft(e)}async _deleteDraft({parent_id:e}={}){return await this.getClient().delete(this._channelURL()+"/draft",{parent_id:e})}async deleteDraft(e={}){const{parent_id:t}=e;try{const s=this.getClient().offlineDb;if(s)return await s.queueTask({task:{channelId:this.id,channelType:this.type,threadId:t,payload:[e],type:"delete-draft"}})}catch(s){this._client.logger("error","offlineDb:delete-draft",{tags:["channel","offlineDb"],error:s})}return this._deleteDraft(e)}async getDraft({parent_id:e}={}){return await this.getClient().get(this._channelURL()+"/draft",{parent_id:e})}on(e,t){const s=t?e:"all",i=t||e;return s in this.listeners||(this.listeners[s]=[]),this._client.logger("info",`Attaching listener for ${s} event on channel ${this.cid}`,{tags:["event","channel"],channel:this}),this.listeners[s].push(i),{unsubscribe:()=>{this._client.logger("info",`Removing listener for ${s} event from channel ${this.cid}`,{tags:["event","channel"],channel:this}),this.listeners[s]=this.listeners[s].filter(n=>n!==i)}}}off(e,t){const s=t?e:"all",i=t||e;s in this.listeners||(this.listeners[s]=[]),this._client.logger("info",`Removing listener for ${s} event from channel ${this.cid}`,{tags:["event","channel"],channel:this}),this.listeners[s]=this.listeners[s].filter(n=>n!==i)}_handleChannelEvent(e){const t=this;this._client.logger("info",`channel:_handleChannelEvent - Received event of type { ${e.type} } on ${this.cid}`,{tags:["event","channel"],channel:this});const s=t.state;switch(e.type){case"typing.start":e.user?.id&&(s.typing[e.user.id]=e);break;case"typing.stop":e.user?.id&&delete s.typing[e.user.id];break;case"message.read":e.user?.id&&e.created_at&&(s.read[e.user.id]={last_read:new Date(e.created_at),last_read_message_id:e.last_read_message_id,user:e.user,unread_messages:0},e.user?.id===this.getClient().user?.id&&(s.unreadCount=0));break;case"user.watching.start":case"user.updated":e.user?.id&&(s.watchers[e.user.id]=e.user);break;case"user.watching.stop":e.user?.id&&delete s.watchers[e.user.id];break;case"message.deleted":e.message&&(this._extendEventWithOwnReactions(e),e.hard_delete?s.removeMessage(e.message):s.addMessageSorted(e.message,!1,!1),s.removeQuotedMessageReferences(e.message),e.message.pinned&&s.removePinnedMessage(e.message));break;case"user.messages.deleted":e.user&&this.state.deleteUserMessages(e.user,!!e.hard_delete,new Date(e.created_at??Date.now()));break;case"message.new":if(e.message){const i=e.user?.id===this.getClient().user?.id,n=e.message.parent_id&&!e.message.show_in_channel;if((this.state.isUpToDate||n)&&s.addMessageSorted(e.message,i),e.message.pinned&&s.addPinnedMessage(e.message),i||n)break;if(e.user?.id)for(const a in s.read)a===e.user.id?s.read[e.user.id]={last_read:new Date(e.created_at),user:e.user,unread_messages:0}:s.read[a].unread_messages+=1;this._countMessageAsUnread(e.message)&&(s.unreadCount=s.unreadCount+1)}break;case"message.updated":case"message.undeleted":e.message&&(this._extendEventWithOwnReactions(e),s.addMessageSorted(e.message,!1,!1),s._updateQuotedMessageReferences({message:e.message}),e.message.pinned?s.addPinnedMessage(e.message):s.removePinnedMessage(e.message));break;case"channel.truncated":if(e.channel?.truncated_at){const i=+new Date(e.channel.truncated_at);s.messageSets.forEach((n,r)=>{n.messages.forEach(({created_at:a,id:o})=>{i>+a&&s.removeMessage({id:o,messageSetIndex:r})})}),s.pinnedMessages.forEach(({id:n,created_at:r})=>{i>+r&&s.removePinnedMessage({id:n})}),s.unreadCount=this.countUnread(new Date(e.channel.truncated_at))}else s.clearMessages(),s.unreadCount=0;e.message&&(s.addMessageSorted(e.message),e.message.pinned&&s.addPinnedMessage(e.message));break;case"member.added":case"member.updated":{const i={...e.member};i.pinned_at===null&&delete i.pinned_at,i.archived_at===null&&delete i.archived_at,i?.user&&(s.members={...s.members,[i.user.id]:i},t.data?.member_count&&e.type==="member.added"&&(t.data.member_count+=1));const n=this.getClient().userID;typeof n=="string"&&typeof i?.user?.id=="string"&&i.user.id===n&&(s.membership=i);break}case"member.removed":if(e.user?.id){const i={...s.members};delete i[e.user.id],s.members=i,t.data?.member_count&&(t.data.member_count=Math.max(t.data.member_count-1,0))}break;case"notification.mark_unread":{if(!(e.user?.id===this.getClient().user?.id&&e.user))break;const n=e.unread_messages??0;s.read[e.user.id]={first_unread_message_id:e.first_unread_message_id,last_read:new Date(e.last_read_at),last_read_message_id:e.last_read_message_id,user:e.user,unread_messages:n},s.unreadCount=n;break}case"channel.updated":if(e.channel){e.channel?.frozen!==void 0&&e.channel.frozen!==t.data?.frozen&&this.query({state:!1,messages:{limit:0},watchers:{limit:0}});const n={...e.channel,hidden:e.channel?.hidden??t.data?.hidden,own_capabilities:e.channel?.own_capabilities??t.data?.own_capabilities};t.data=n}break;case"reaction.new":if(e.message&&e.reaction){const{message:i,reaction:n}=e;e.message=s.addReaction(n,i)}break;case"reaction.deleted":if(e.message&&e.reaction){const{message:i,reaction:n}=e;e.message=s.removeReaction(n,i)}break;case"reaction.updated":if(e.message&&e.reaction){const{message:i,reaction:n}=e;e.message=s.addReaction(n,i,!0)}break;case"channel.hidden":t.data={...t.data,hidden:!0},e.clear_history&&s.clearMessages();break;case"channel.visible":t.data={...t.data,hidden:!1},this.getClient().offlineDb?.handleChannelVisibilityEvent({event:e});break;case"user.banned":if(!e.user?.id)break;s.members[e.user.id]={...s.members[e.user.id]||{},shadow_banned:!!e.shadow,banned:!e.shadow,user:{...s.members[e.user.id]?.user||{},...e.user}};break;case"user.unbanned":if(!e.user?.id)break;s.members[e.user.id]={...s.members[e.user.id]||{},shadow_banned:!1,banned:!1,user:{...s.members[e.user.id]?.user||{},...e.user}};break}e.watcher_count!==void 0&&(t.state.watcher_count=e.watcher_count)}_checkInitialized(){if(!this.initialized&&!this.offlineMode&&!this.getClient()._isUsingServerAuth())throw Error(`Channel ${this.cid} hasn't been initialized yet. Make sure to call .watch() and wait for it to resolve`)}_initializeState(e,t="latest"){const{state:s,user:i,userID:n}=this.getClient();if(e.members){this._hydrateMembers({members:e.members});for(const o of e.members)o.user&&s.updateUserReference(o.user,this.cid)}this.state.membership=e.membership||{};const r=e.messages||[];this.state.messages||this.state.initMessages();const{messageSet:a}=this.state.addMessagesSorted(r,!1,!0,!0,t);if(this.state.pinnedMessages||(this.state.pinnedMessages=[]),this.state.addPinnedMessages(e.pinned_messages||[]),e.pending_messages&&(this.state.pending_messages=e.pending_messages),e.watcher_count!==void 0&&(this.state.watcher_count=e.watcher_count),e.watchers)for(const o of e.watchers)o&&(s.updateUserReference(o,this.cid),this.state.watchers[o.id]=o);if(n!=null){const o=this.state.last_message_at||new Date;i&&(this.state.read[i.id]={user:i,last_read:o,unread_messages:0})}if(e.read)for(const o of e.read)this.state.read[o.user.id]={last_read:new Date(o.last_read),last_read_message_id:o.last_read_message_id,unread_messages:o.unread_messages??0,user:o.user},o.user.id===i?.id&&(this.state.unreadCount=this.state.read[o.user.id].unread_messages);return{messageSet:a}}_extendEventWithOwnReactions(e){if(!e.message)return;const t=this.state.findMessage(e.message.id,e.message.parent_id);t&&(e.message.own_reactions=t.own_reactions)}_hydrateMembers({members:e,overrideCurrentState:t=!0}){const s=e.reduce((i,n)=>(n.user&&(i[n.user.id]=n),i),{});t?this.state.members=s:!t&&e.length&&(this.state.members={...this.state.members,...s})}_disconnect(){this._client.logger("info",`channel:disconnect() - Disconnecting the channel ${this.cid}`,{tags:["connection","channel"],channel:this}),this.disconnected=!0,this.state.setIsUpToDate(!1)}},Vi=class{constructor({client:e}){this.client=e,this.users={},this.userChannelReferences={}}updateUsers(e){for(const t of e)this.updateUser(t)}updateUser(e){e!=null&&this.client._cacheEnabled()&&(this.users[e.id]=e)}updateUserReference(e,t){e==null||!this.client._cacheEnabled()||(this.updateUser(e),this.userChannelReferences[e.id]||(this.userChannelReferences[e.id]={}),this.userChannelReferences[e.id][t]=!0)}deleteAllChannelReference(e){for(const t in this.userChannelReferences)delete this.userChannelReferences[t][e]}},ce=null;typeof WebSocket<"u"?ce=WebSocket:typeof MozWebSocket<"u"?ce=MozWebSocket:typeof global<"u"?ce=global.WebSocket||global.MozWebSocket:typeof window<"u"?ce=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(ce=self.WebSocket||self.MozWebSocket);var Cc=ce,Sc=class{constructor(){this.connectionStartTimestamp=null,this.wsTotalFailures=0,this.wsConsecutiveFailures=0,this.instanceClientId=de()}},Bs=async(e,t)=>{for(let i=0;i<3;i++){try{await Oe.post(`https://chat-insights.getstream.io/insights/${e}`,t)}catch{await K((i+1)*3e3);continue}break}};function Rc(e,t){return{...t,...ur(e)}}function ur(e){const{client:t}=e;return{ready_state:e.ws?.readyState,url:e._buildUrl(),api_key:t.key,start_ts:t.insightMetrics.connectionStartTimestamp,end_ts:new Date().getTime(),auth_type:t.getAuthType(),token:t.tokenManager.token,user_id:t.userID,user_details:t._user,device:t.options.device,client_id:e.connectionID,ws_details:e.ws,ws_consecutive_failures:t.insightMetrics.wsConsecutiveFailures,ws_total_failures:t.insightMetrics.wsTotalFailures,request_id:e.requestID,online:typeof navigator<"u"?navigator?.onLine:null,user_agent:typeof navigator<"u"?navigator?.userAgent:null,instance_client_id:t.insightMetrics.instanceClientId}}function Ec(e){return ur(e)}var xc=e=>e.code!==void 0,Uc=e=>e.error!==void 0,Mc=class{constructor({client:e}){this._buildUrl=()=>{const t=this.client._buildWSPayload(this.requestID),s=this.client.tokenManager.getToken(),i=this.client.options.wsUrlParams,n=new URLSearchParams(i);return n.set("json",t),n.set("api_key",this.client.key),n.set("authorization",`${s}`),n.set("stream-auth-type",this.client.getAuthType()),n.set("X-Stream-Client",this.client.getUserAgent()),`${this.client.wsBaseURL}/connect?${n.toString()}`},this.onlineStatusChanged=t=>{t.type==="offline"?(this._log("onlineStatusChanged() - Status changing to offline"),this._setHealth(!1)):t.type==="online"&&(this._log(`onlineStatusChanged() - Status changing to online. isHealthy: ${this.isHealthy}`),this.isHealthy||this._reconnect({interval:10}))},this.onopen=t=>{this.wsID===t&&this._log("onopen() - onopen callback",{wsID:t})},this.onmessage=(t,s)=>{if(this.wsID!==t)return;this._log("onmessage() - onmessage callback",{event:s,wsID:t});const i=typeof s.data=="string"?JSON.parse(s.data):null;if(!this.isResolved&&i){if(this.isResolved=!0,i.error){this.rejectPromise?.(this._errorFromWSEvent(i,!1));return}this.resolvePromise?.(i),this._setHealth(!0)}this.lastEvent=new Date,i&&i.type==="health.check"&&this.scheduleNextPing(),this.client.handleEvent(s),this.scheduleConnectionCheck()},this.onclose=(t,s)=>{if(this.wsID===t)if(this._log("onclose() - onclose callback - "+s.code,{event:s,wsID:t}),s.code===Ce.WS_CLOSED_SUCCESS){const i=new Error(`WS connection reject with error ${s.reason}`);i.reason=s.reason,i.code=s.code,i.wasClean=s.wasClean,i.target=s.target,this.rejectPromise?.(i),this._log(`onclose() - WS connection reject with error ${s.reason}`,{event:s})}else this.consecutiveFailures+=1,this.totalFailures+=1,this._setHealth(!1),this.isConnecting=!1,this.rejectPromise?.(this._errorFromWSEvent(s)),this._log("onclose() - WS connection closed. Calling reconnect ...",{event:s}),this._reconnect()},this.onerror=(t,s)=>{this.wsID===t&&(this.consecutiveFailures+=1,this.totalFailures+=1,this._setHealth(!1),this.isConnecting=!1,this.rejectPromise?.(this._errorFromWSEvent(s)),this._log("onerror() - WS connection resulted into error",{event:s}),this._reconnect())},this._setHealth=t=>{if(t!==this.isHealthy){if(this.isHealthy=t,this.isHealthy){this.client.dispatchEvent({type:"connection.changed",online:this.isHealthy});return}setTimeout(()=>{this.isHealthy||this.client.dispatchEvent({type:"connection.changed",online:this.isHealthy})},5e3)}},this._errorFromWSEvent=(t,s=!0)=>{let i,n,r;xc(t)&&(i=t.code,n="unknown",r=t.reason),Uc(t)&&(i=t.error.code,n=t.error.StatusCode,r=t.error.message),this._log(`_errorFromWSEvent() - WS failed with code ${i}`,{event:t},"warn");const a=new Error(`WS failed with code ${i} and reason - ${r}`);return a.code=i,a.StatusCode=n,a.isWSFailure=s,a},this._setupConnectionPromise=()=>{this.isResolved=!1,this.connectionOpen=new Promise((t,s)=>{this.resolvePromise=t,this.rejectPromise=s})},this.scheduleNextPing=()=>{this.healthCheckTimeoutRef&&clearTimeout(this.healthCheckTimeoutRef),this.healthCheckTimeoutRef=setTimeout(()=>{const t=[{type:"health.check",client_id:this.client.clientID}];try{this.ws?.send(JSON.stringify(t))}catch{}},this.pingInterval)},this.scheduleConnectionCheck=()=>{this.connectionCheckTimeoutRef&&clearTimeout(this.connectionCheckTimeoutRef),this.connectionCheckTimeoutRef=setTimeout(()=>{const t=new Date;this.lastEvent&&t.getTime()-this.lastEvent.getTime()>this.connectionCheckTimeout&&(this._log("scheduleConnectionCheck - going to reconnect"),this._setHealth(!1),this._reconnect())},this.connectionCheckTimeout)},this.client=e,this.consecutiveFailures=0,this.totalFailures=0,this.isConnecting=!1,this.isDisconnected=!1,this.isResolved=!1,this.isHealthy=!1,this.wsID=1,this.lastEvent=null,this.pingInterval=25*1e3,this.connectionCheckTimeout=this.pingInterval+10*1e3,Un(this.onlineStatusChanged)}_log(e,t={},s="info"){this.client.logger(s,"connection:"+e,{tags:["connection"],...t})}setClient(e){this.client=e}async connect(e=15e3){if(this.isConnecting)throw Error("You've called connect twice, can only attempt 1 connection at the time");this.isDisconnected=!1;try{const t=await this._connect();this.consecutiveFailures=0,this._log(`connect() - Established ws connection with healthcheck: ${t}`)}catch(t){this.isHealthy=!1,this.consecutiveFailures+=1;const s=t;if(s.code===Ce.TOKEN_EXPIRED&&!this.client.tokenManager.isStatic())this._log("connect() - WS failure due to expired token, so going to try to reload token and reconnect"),this._reconnect({refreshToken:!0});else if(!s.isWSFailure)throw new Error(JSON.stringify({code:s.code,StatusCode:s.StatusCode,message:s.message,isWSFailure:s.isWSFailure}))}return await this._waitForHealthy(e)}_waitForHealthy(e=15e3){return Promise.race([(async()=>{for(let s=0;s<=e;s+=50)try{return await this.connectionOpen}catch(i){if(s===e)throw new Error(JSON.stringify({code:i.code,StatusCode:i.StatusCode,message:i.message,isWSFailure:i.isWSFailure}));await K(50)}})(),(async()=>{throw await K(e),this.isConnecting=!1,new Error(JSON.stringify({code:"",StatusCode:"",message:"initial WS connection could not be established",isWSFailure:!0}))})()])}disconnect(e){this._log(`disconnect() - Closing the websocket connection for wsID ${this.wsID}`),this.wsID+=1,this.isConnecting=!1,this.isDisconnected=!0,this.healthCheckTimeoutRef&&clearInterval(this.healthCheckTimeoutRef),this.connectionCheckTimeoutRef&&clearInterval(this.connectionCheckTimeoutRef),Mn(this.onlineStatusChanged),this.isHealthy=!1,this.ws&&this.ws.removeAllListeners&&this.ws.removeAllListeners();let t;const{ws:s}=this;return s&&s.close&&s.readyState===s.OPEN?(t=new Promise(i=>{const n=r=>{this._log(`disconnect() - resolving isClosedPromise ${r?"with":"without"} close frame`,{event:r}),i()};s.onclose=n,setTimeout(n,e??1e3)}),this._log("disconnect() - Manually closed connection by calling client.disconnect()"),s.close(Ce.WS_CLOSED_SUCCESS,"Manually closed connection by calling client.disconnect()")):(this._log("disconnect() - ws connection doesn't exist or it is already closed."),t=Promise.resolve()),delete this.ws,t}async _connect(){if(this.isConnecting||this.isDisconnected&&this.client.options.enableWSFallback)return;this.isConnecting=!0,this.requestID=de(),this.client.insightMetrics.connectionStartTimestamp=new Date().getTime();let e=!1;try{this._log("_connect() - waiting for token"),await this.client.tokenManager.tokenReady(),e=!0}catch{}try{e||(this._log("_connect() - tokenProvider failed before, so going to retry"),await this.client.tokenManager.loadToken()),this._setupConnectionPromise();const t=this._buildUrl();this._log(`_connect() - Connecting to ${t}`,{wsURL:t,requestID:this.requestID}),this.ws=new Cc(t),this.ws.onopen=this.onopen.bind(this,this.wsID),this.ws.onclose=this.onclose.bind(this,this.wsID),this.ws.onerror=this.onerror.bind(this,this.wsID),this.ws.onmessage=this.onmessage.bind(this,this.wsID);const s=await this.connectionOpen;if(this.isConnecting=!1,s)return this.connectionID=s.connection_id,this.client.insightMetrics.wsConsecutiveFailures>0&&this.client.options.enableInsights&&(Bs("ws_success_after_failure",Ec(this)),this.client.insightMetrics.wsConsecutiveFailures=0),s}catch(t){if(this.isConnecting=!1,this._log("_connect() - Error - ",t),this.client.options.enableInsights){this.client.insightMetrics.wsConsecutiveFailures++,this.client.insightMetrics.wsTotalFailures++;const s=Rc(this,bo(t));Bs?.("ws_fatal",s)}throw t}}async _reconnect(e={}){if(this._log("_reconnect() - Initiating the reconnect"),this.isConnecting||this.isHealthy){this._log("_reconnect() - Abort (1) since already connecting or healthy");return}let t=e.interval;if(t||(t=lt(this.consecutiveFailures)),await K(t),this.isConnecting||this.isHealthy){this._log("_reconnect() - Abort (2) since already connecting or healthy");return}if(this.isDisconnected&&this.client.options.enableWSFallback){this._log("_reconnect() - Abort (3) since disconnect() is called");return}this._log("_reconnect() - Destroying current WS connection"),this._destroyCurrentWSConnection(),e.refreshToken&&await this.client.tokenManager.loadToken();try{await this._connect(),this._log("_reconnect() - Waiting for recoverCallBack"),await this.client.recoverState(),this._log("_reconnect() - Finished recoverCallBack"),this.consecutiveFailures=0}catch(s){if(this.isHealthy=!1,this.consecutiveFailures+=1,s.code===Ce.TOKEN_EXPIRED&&!this.client.tokenManager.isStatic())return this._log("_reconnect() - WS failure due to expired token, so going to try to reload token and reconnect"),this._reconnect({refreshToken:!0});s.isWSFailure&&(this._log("_reconnect() - WS failure, so going to try to reconnect"),this._reconnect())}this._log("_reconnect() - == END ==")}_destroyCurrentWSConnection(){this.wsID+=1;try{this?.ws?.removeAllListeners(),this?.ws?.close()}catch{}}},nt=Be(Mr()),Hi=Be(Ar());function fr(e,t,s={},i={}){if(typeof t!="string")throw new TypeError("userId should be a string");const n={user_id:t,...s};if(nt.default==null||nt.default.sign==null)throw Error("Unable to find jwt crypto, if you are getting this error is probably because you are trying to generate tokens on browser or React Native (or other environment where crypto functions are not available). Please Note: token should only be generated server-side.");const r=Object.assign({algorithm:"HS256",noTimestamp:!0},i);return n.iat&&(r.noTimestamp=!1),nt.default.sign(n,e,r)}function ji(e,t={}){const s={server:!0},i=Object.assign({algorithm:"HS256",noTimestamp:!0},t);return nt.default.sign(s,e,i)}function Ac(e){const t=e.split(".");if(t.length!==3)return"";const s=t[1],i=Dr(s);return JSON.parse(i).user_id}function Lc(e){return["eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9",Ir(JSON.stringify({user_id:e})),"devtoken"].join(".")}function Tc(e,t,s){const i=Buffer.from(t,"utf8"),n=Hi.default.createHmac("sha256",i).update(e).digest("hex");try{return Hi.default.timingSafeEqual(Buffer.from(n),Buffer.from(s))}catch{return!1}}var Ic=class{constructor(e){this.setTokenOrProvider=async(t,s)=>{this.validateToken(t,s),this.user=s,Rs(t)&&(this.tokenProvider=t,this.type="provider"),typeof t=="string"&&(this.token=t,this.type="static"),!t&&this.user&&this.secret&&(this.token=fr(this.secret,s.id,{},{}),this.type="static"),await this.loadToken()},this.reset=()=>{this.token=void 0,this.tokenProvider=void 0,this.type="static",this.user=void 0,this.loadTokenPromise=null},this.validateToken=(t,s)=>{if(!(s&&s.anon&&!t)){if(!this.secret&&!t)throw new Error("User token can not be empty");if(t&&typeof t!="string"&&!Rs(t))throw new Error("user token should either be a string or a function");if(typeof t=="string"){if(s.anon&&t==="")return;const i=Ac(t);if(t!=null&&(i==null||i===""||i!==s.id))throw new Error("userToken does not have a user_id or is not matching with user.id")}}},this.tokenReady=()=>this.loadTokenPromise,this.loadToken=()=>(this.loadTokenPromise=new Promise(async(t,s)=>{if(this.type==="static")return t(this.token);if(this.tokenProvider&&typeof this.tokenProvider!="string"){try{this.token=await this.tokenProvider()}catch(i){return s(new Error(`Call to tokenProvider failed with message: ${i}`,{cause:i}))}t(this.token)}}),this.loadTokenPromise),this.getToken=()=>{if(this.token)return this.token;if(this.user&&this.user.anon&&!this.token)return this.token;if(this.secret)return ji(this.secret);throw new Error("Both secret and user tokens are not set. Either client.connectUser wasn't called or client.disconnect was called")},this.isStatic=()=>this.type==="static",this.loadTokenPromise=null,e&&(this.secret=e),this.type="static",this.secret&&(this.token=ji(this.secret))}},Dc={"-1":{name:"InternalSystemError",retryable:!0},2:{name:"AccessKeyError",retryable:!1},3:{name:"AuthenticationFailedError",retryable:!0},4:{name:"InputError",retryable:!1},6:{name:"DuplicateUsernameError",retryable:!1},9:{name:"RateLimitError",retryable:!0},16:{name:"DoesNotExistError",retryable:!1},17:{name:"NotAllowedError",retryable:!1},18:{name:"EventNotSupportedError",retryable:!1},19:{name:"ChannelFeatureNotSupportedError",retryable:!1},20:{name:"MessageTooLongError",retryable:!1},21:{name:"MultipleNestingLevelError",retryable:!1},22:{name:"PayloadTooBigError",retryable:!1},23:{name:"RequestTimeoutError",retryable:!0},24:{name:"MaxHeaderSizeExceededError",retryable:!1},40:{name:"AuthErrorTokenExpired",retryable:!1},41:{name:"AuthErrorTokenNotValidYet",retryable:!1},42:{name:"AuthErrorTokenUsedBeforeIssuedAt",retryable:!1},43:{name:"AuthErrorTokenSignatureInvalid",retryable:!1},44:{name:"CustomCommandEndpointMissingError",retryable:!1},45:{name:"CustomCommandEndpointCallError",retryable:!0},46:{name:"ConnectionIDNotFoundError",retryable:!1},60:{name:"CoolDownError",retryable:!0},69:{name:"ErrWrongRegion",retryable:!1},70:{name:"ErrQueryChannelPermissions",retryable:!1},71:{name:"ErrTooManyConnections",retryable:!0},99:{name:"AppSuspendedError",retryable:!1}};function Pc(e){return e.code!==void 0}function Wi(e){if(!e.code)return!1;const t=Dc[`${e.code}`];return t?t.retryable:!1}function Oc(e){return e.code===46}function kc(e){if(typeof e.isWSFailure=="boolean")return e.isWSFailure;try{return JSON.parse(e.message).isWSFailure}catch{return!1}}function Nc(e){return!e.status||e.status<200||300<=e.status}var Fc=class{constructor({client:e}){this._onlineStatusChanged=t=>{if(this._log(`_onlineStatusChanged() - ${t.type}`),t.type==="offline"){this._setState("CLOSED"),this.cancelToken?.cancel("disconnect() is called"),this.cancelToken=void 0;return}t.type==="online"&&this.state==="CLOSED"&&this.connect(!0)},this._req=async(t,s,i)=>{!this.cancelToken&&!t.close&&(this.cancelToken=Oe.CancelToken.source());try{const n=await this.client.doAxiosRequest("get",this.client.baseURL.replace(":3030",":8900")+"/longpoll",void 0,{config:{...s,cancelToken:this.cancelToken?.token},params:t});return this.consecutiveFailures=0,n}catch(n){if(this.consecutiveFailures+=1,i&&Wi(n))return this._log("_req() - Retryable error, retrying request"),await K(lt(this.consecutiveFailures)),this._req(t,s,i);throw n}},this._poll=async()=>{for(;this.state==="CONNECTED";)try{const t=await this._req({},{timeout:3e4},!0);if(t.events?.length)for(let s=0;s<t.events.length;s++)this.client.dispatchEvent(t.events[s])}catch(t){if(Oe.isCancel(t)){this._log("_poll() - axios canceled request");return}if(Oc(t)){this._log("_poll() - ConnectionID error, connecting without ID..."),this._setState("DISCONNECTED"),this.connect(!0);return}if(Pc(t)&&!Wi(t)){this._setState("CLOSED");return}await K(lt(this.consecutiveFailures))}},this.connect=async(t=!1)=>{if(this.state==="CONNECTING"){this._log("connect() - connecting already in progress",{reconnect:t},"warn");return}if(this.state==="CONNECTED"){this._log("connect() - already connected and polling",{reconnect:t},"warn");return}this._setState("CONNECTING"),this.connectionID=void 0;try{const{event:s}=await this._req({json:this.client._buildWSPayload()},{timeout:8e3},t);return this._setState("CONNECTED"),this.connectionID=s.connection_id,this.client.dispatchEvent(s),this._poll(),t&&this.client.recoverState(),s}catch(s){throw this._setState("CLOSED"),s}},this.isHealthy=()=>!!this.connectionID&&this.state==="CONNECTED",this.disconnect=async(t=2e3)=>{Mn(this._onlineStatusChanged),this._setState("DISCONNECTED"),this.cancelToken?.cancel("disconnect() is called"),this.cancelToken=void 0;const s=this.connectionID;this.connectionID=void 0;try{await this._req({close:!0,connection_id:s},{timeout:t},!1),this._log("disconnect() - Closed connectionID")}catch(i){this._log("disconnect() - Failed",{err:i},"error")}},this.client=e,this.state="INIT",this.consecutiveFailures=0,Un(this._onlineStatusChanged)}_log(e,t={},s="info"){this.client.logger(s,"WSConnectionFallback:"+e,{tags:["connection_fallback","connection"],...t})}_setState(e){this._log(`_setState() - ${e}`),this.state==="CONNECTING"&&e==="CONNECTED"&&this.client.dispatchEvent({type:"connection.changed",online:!0}),(e==="CLOSED"||e==="DISCONNECTED")&&this.client.dispatchEvent({type:"connection.changed",online:!1}),this.state=e}},zi=class{constructor(e,t,s,i){this.client=e,this.type=t,this.id=s,this.data=i}create(){const e={name:this.data?.name,filter:this.data?.filter,description:this.data?.description,all_sender_channels:this.data?.all_sender_channels,all_users:this.data?.all_users};return this.client.createSegment(this.type,this.id,e)}verifySegmentId(){if(!this.id)throw new Error("Segment id is missing. Either create the segment using segment.create() or set the id during instantiation - const segment = client.segment(id)")}get(){return this.verifySegmentId(),this.client.getSegment(this.id)}update(e){return this.verifySegmentId(),this.client.updateSegment(this.id,e)}addTargets(e){return this.verifySegmentId(),this.client.addSegmentTargets(this.id,e)}removeTargets(e){return this.verifySegmentId(),this.client.removeSegmentTargets(this.id,e)}delete(){return this.verifySegmentId(),this.client.deleteSegment(this.id)}targetExists(e){return this.verifySegmentId(),this.client.segmentTargetExists(this.id,e)}queryTargets(e={},t=[],s={}){return this.verifySegmentId(),this.client.querySegmentTargets(this.id,e,t,s)}},Ke={user:"stream:user",message:"stream:chat:v1:message",userprofile:"stream:v1:user_profile"},qc=class{constructor(e){this.client=e}flagUser(e,t,s={}){return this.flag(Ke.user,e,"",t,s)}flagMessage(e,t,s={}){return this.flag(Ke.message,e,"",t,s)}async flag(e,t,s,i,n={}){return await this.client.post(this.client.baseURL+"/api/v2/moderation/flag",{entity_type:e,entity_id:t,entity_creator_id:s,reason:i,...n})}async muteUser(e,t={}){return await this.client.post(this.client.baseURL+"/api/v2/moderation/mute",{target_ids:[e],...t})}async unmuteUser(e,t){return await this.client.post(this.client.baseURL+"/api/v2/moderation/unmute",{target_ids:[e],...t})}async getUserModerationReport(e,t={}){return await this.client.get(this.client.baseURL+"/api/v2/moderation/user_report",{user_id:e,...t})}async queryReviewQueue(e={},t=[],s={}){return await this.client.post(this.client.baseURL+"/api/v2/moderation/review_queue",{filter:e,sort:L(t),...s})}async upsertConfig(e){return await this.client.post(this.client.baseURL+"/api/v2/moderation/config",e)}async getConfig(e,t){return await this.client.get(this.client.baseURL+"/api/v2/moderation/config/"+e,t)}async deleteConfig(e,t){return await this.client.delete(this.client.baseURL+"/api/v2/moderation/config/"+e,t)}async queryConfigs(e,t,s={}){return await this.client.post(this.client.baseURL+"/api/v2/moderation/configs",{filter:e,sort:t,...s})}async submitAction(e,t,s={}){return await this.client.post(this.client.baseURL+"/api/v2/moderation/submit_action",{action_type:e,item_id:t,...s})}async check(e,t,s,i,n,r){return await this.client.post(this.client.baseURL+"/api/v2/moderation/check",{entity_type:e,entity_id:t,entity_creator_id:s,moderation_payload:i,config_key:n,options:r})}async checkUserProfile(e,t){if(!t.username&&!t.image)throw new Error("Either username or image must be provided");const s={};return t.username&&(s.texts=[t.username]),t.image&&(s.images=[t.image]),await this.check(Ke.userprofile,e,e,s,"user_profile:default",{force_sync:!0,test_mode:!0})}async addCustomFlags(e,t,s,i,n){return await this.client.post(this.client.baseURL+"/api/v2/moderation/custom_check",{entity_type:e,entity_id:t,entity_creator_id:s,moderation_payload:i,flags:n})}async addCustomMessageFlags(e,t){return await this.addCustomFlags(Ke.message,e,"",{},t)}},Bc=1e3,Qi=25,Gi={active:!1,isThreadOrderStale:!1,threads:[],unreadThreadCount:0,unseenThreadIds:[],lastConnectionDropAt:null,pagination:{isLoading:!1,isLoadingNext:!1,nextCursor:null},ready:!1},$c=class extends ae{constructor({client:e}){super(),this.resetState=()=>{this.state.next(Gi)},this.activate=()=>{this.state.partialNext({active:!0})},this.deactivate=()=>{this.state.partialNext({active:!1})},this.registerSubscriptions=()=>{this.hasSubscriptions||(this.addUnsubscribeFunction(this.subscribeUnreadThreadsCountChange()),this.addUnsubscribeFunction(this.subscribeManageThreadSubscriptions()),this.addUnsubscribeFunction(this.subscribeReloadOnActivation()),this.addUnsubscribeFunction(this.subscribeNewReplies()),this.addUnsubscribeFunction(this.subscribeRecoverAfterConnectionDrop()),this.addUnsubscribeFunction(this.subscribeChannelDeleted()))},this.subscribeUnreadThreadsCountChange=()=>{const{unread_threads:t=0}=this.client.user??{};this.state.partialNext({unreadThreadCount:t});const s=["health.check","notification.mark_read","notification.thread_message_new","notification.channel_deleted"].map(i=>this.client.on(i,n=>{const{unread_threads:r}=n.me??n;typeof r=="number"&&this.state.partialNext({unreadThreadCount:r})}).unsubscribe);return()=>s.forEach(i=>i())},this.subscribeChannelDeleted=()=>this.client.on("notification.channel_deleted",t=>{const{cid:s}=t,{threads:i}=this.state.getLatestValue(),n=i.filter(r=>r.channel.cid!==s);this.state.partialNext({threads:n})}).unsubscribe,this.subscribeManageThreadSubscriptions=()=>this.state.subscribeWithSelector(t=>({threads:t.threads}),({threads:t},s)=>{const{threads:i=[]}=s??{},n=i.filter(r=>r!==this.threadsById[r.id]);t.forEach(r=>r.registerSubscriptions()),n.forEach(r=>r.unregisterSubscriptions())}),this.subscribeReloadOnActivation=()=>this.state.subscribeWithSelector(t=>({active:t.active}),({active:t})=>{t&&this.reload()}),this.subscribeNewReplies=()=>this.client.on("notification.thread_message_new",t=>{const s=t.message?.parent_id;if(!s)return;const{unseenThreadIds:i,ready:n}=this.state.getLatestValue();n&&(this.threadsById[s]?this.state.partialNext({isThreadOrderStale:!0}):i.includes(s)||this.state.partialNext({unseenThreadIds:i.concat(s)}))}).unsubscribe,this.subscribeRecoverAfterConnectionDrop=()=>{const t=this.client.on("connection.changed",n=>{n.online===!1&&this.state.next(r=>r.lastConnectionDropAt?r:{...r,lastConnectionDropAt:new Date})}).unsubscribe,s=In(()=>{const{lastConnectionDropAt:n}=this.state.getLatestValue();n&&this.reload({force:!0})},Bc,{trailing:!0}),i=this.client.on("connection.recovered",s).unsubscribe;return()=>{t(),i()}},this.unregisterSubscriptions=()=>(this.state.getLatestValue().threads.forEach(t=>t.unregisterSubscriptions()),super.unregisterSubscriptions()),this.reload=async({force:t=!1}={})=>{const{threads:s,unseenThreadIds:i,isThreadOrderStale:n,pagination:r,ready:a}=this.state.getLatestValue();if(r.isLoading||!t&&a&&!i.length&&!n)return;const o=s.length+i.length;try{this.state.next(c=>({...c,pagination:{...c.pagination,isLoading:!0}}));const l=await this.queryThreads({limit:Math.min(o,Qi)||Qi}),d=[];for(const c of l.threads){const h=this.threadsById[c.id];h?(d.push(h),h.hasStaleState&&h.hydrateState(c)):d.push(c)}this.state.next(c=>({...c,threads:d,unseenThreadIds:[],isThreadOrderStale:!1,pagination:{...c.pagination,isLoading:!1,nextCursor:l.next??null},ready:!0}))}catch(l){this.client.logger("error",l.message),this.state.next(d=>({...d,pagination:{...d.pagination,isLoading:!1}}))}},this.queryThreads=(t={})=>this.client.queryThreads({limit:25,participant_limit:10,reply_limit:10,watch:!0,...t}),this.loadNextPage=async(t={})=>{const{pagination:s}=this.state.getLatestValue();if(!(s.isLoadingNext||!s.nextCursor))try{this.state.partialNext({pagination:{...s,isLoadingNext:!0}});const i=await this.queryThreads({...t,next:s.nextCursor});this.state.next(n=>({...n,threads:i.threads.length?n.threads.concat(i.threads):n.threads,pagination:{...n.pagination,nextCursor:i.next??null,isLoadingNext:!1}}))}catch(i){this.client.logger("error",i.message),this.state.next(n=>({...n,pagination:{...n.pagination,isLoadingNext:!1}}))}},this.client=e,this.state=new x(Gi),this.threadsByIdGetterCache={threads:[],threadsById:{}}}get threadsById(){const{threads:e}=this.state.getLatestValue();if(e===this.threadsByIdGetterCache.threads)return this.threadsByIdGetterCache.threadsById;const t=e.reduce((s,i)=>(s[i.id]=i,s),{});return this.threadsByIdGetterCache.threads=e,this.threadsByIdGetterCache.threadsById=t,t}},Vc=e=>e.type==="poll.updated",Hc=e=>e.type==="poll.closed",jc=e=>e.type==="poll.vote_casted",Wc=e=>e.type==="poll.vote_changed",zc=e=>e.type==="poll.vote_removed",Z=e=>!!e?.answer_text,Qc=class{constructor({client:e,poll:t}){this.getInitialStateFromPollResponse=s=>{const{own_votes:i,id:n,...r}=s,{ownAnswer:a,ownVotes:o}=i?.reduce((l,d)=>(Z(d)?l.ownAnswer=d:l.ownVotes.push(d),l),{ownVotes:[]})??{ownVotes:[]};return{...r,lastActivityAt:new Date,maxVotedOptionIds:ve(r.vote_counts_by_option),ownAnswer:a,ownVotesByOptionId:Gc(o)}},this.upsertOfflineDb=()=>{this.client.offlineDb?.executeQuerySafely(s=>s.upsertPoll({poll:Kc(this)}),{method:"upsertPoll"})},this.reinitializeState=s=>{this.state.partialNext(this.getInitialStateFromPollResponse(s))},this.handlePollUpdated=s=>{if(s.poll?.id&&s.poll.id!==this.id||!Vc(s))return;const{id:i,...n}=Jc(s.poll);this.state.partialNext({...n,lastActivityAt:new Date(s.created_at)}),this.upsertOfflineDb()},this.handlePollClosed=s=>{s.poll?.id&&s.poll.id!==this.id||Hc(s)&&(this.state.partialNext({is_closed:!0,lastActivityAt:new Date(s.created_at)}),this.upsertOfflineDb())},this.handleVoteCasted=s=>{if(s.poll?.id&&s.poll.id!==this.id||!jc(s))return;const i=this.data,n=s.poll_vote.user_id===this.client.userID;let r=[...i.latest_answers],a=i.ownAnswer;const o=i.ownVotesByOptionId;let l=i.maxVotedOptionIds;n&&(Z(s.poll_vote)?a=s.poll_vote:s.poll_vote.option_id&&(o[s.poll_vote.option_id]=s.poll_vote)),Z(s.poll_vote)?r=[s.poll_vote,...r]:l=ve(s.poll.vote_counts_by_option);const d=ps(s.poll);this.state.partialNext({...d,latest_answers:r,lastActivityAt:new Date(s.created_at),ownAnswer:a,ownVotesByOptionId:o,maxVotedOptionIds:l}),this.upsertOfflineDb()},this.handleVoteChanged=s=>{if(s.poll?.id&&s.poll.id!==this.id||!Wc(s))return;const i=this.data,n=s.poll_vote.user_id===this.client.userID;let r=[...i.latest_answers],a=i.ownAnswer,o=i.ownVotesByOptionId,l=i.maxVotedOptionIds;n?Z(s.poll_vote)?(r=[s.poll_vote,...r.filter(c=>c.id!==s.poll_vote.id)],a=s.poll_vote):s.poll_vote.option_id&&(s.poll.enforce_unique_vote?o={[s.poll_vote.option_id]:s.poll_vote}:(o=Object.entries(o).reduce((c,[h,f])=>(h!==s.poll_vote.option_id&&f.id===s.poll_vote.id||(c[h]=f),c),{}),o[s.poll_vote.option_id]=s.poll_vote),a?.id===s.poll_vote.id&&(a=void 0),l=ve(s.poll.vote_counts_by_option)):Z(s.poll_vote)?r=[s.poll_vote,...r]:l=ve(s.poll.vote_counts_by_option);const d=ps(s.poll);this.state.partialNext({...d,latest_answers:r,lastActivityAt:new Date(s.created_at),ownAnswer:a,ownVotesByOptionId:o,maxVotedOptionIds:l}),this.upsertOfflineDb()},this.handleVoteRemoved=s=>{if(s.poll?.id&&s.poll.id!==this.id||!zc(s))return;const i=this.data,n=s.poll_vote.user_id===this.client.userID;let r=[...i.latest_answers],a=i.ownAnswer;const o={...i.ownVotesByOptionId};let l=i.maxVotedOptionIds;Z(s.poll_vote)?(r=r.filter(c=>c.id!==s.poll_vote.id),n&&(a=void 0)):(l=ve(s.poll.vote_counts_by_option),n&&s.poll_vote.option_id&&delete o[s.poll_vote.option_id]);const d=ps(s.poll);this.state.partialNext({...d,latest_answers:r,lastActivityAt:new Date(s.created_at),ownAnswer:a,ownVotesByOptionId:o,maxVotedOptionIds:l}),this.upsertOfflineDb()},this.query=async s=>{const{poll:i}=await this.client.getPoll(s);return this.state.partialNext({...i,lastActivityAt:new Date}),i},this.update=async s=>await this.client.updatePoll({...s,id:this.id}),this.partialUpdate=async s=>await this.client.partialUpdatePoll(this.id,s),this.close=async()=>await this.client.closePoll(this.id),this.delete=async()=>await this.client.deletePoll(this.id),this.createOption=async s=>await this.client.createPollOption(this.id,s),this.updateOption=async s=>await this.client.updatePollOption(this.id,s),this.deleteOption=async s=>await this.client.deletePollOption(this.id,s),this.castVote=async(s,i)=>{const{max_votes_allowed:n,ownVotesByOptionId:r}=this.data;if(n&&n===Object.keys(r).length){this.client.notifications.addInfo({message:"Reached the vote limit. Remove an existing vote first.",origin:{emitter:"Poll",context:{messageId:i,optionId:s}},options:{type:"validation:poll:castVote:limit"}});return}return await this.client.castPollVote(i,this.id,{option_id:s})},this.removeVote=async(s,i)=>await this.client.removePollVote(i,this.id,s),this.addAnswer=async(s,i)=>await this.client.addPollAnswer(i,this.id,s),this.removeAnswer=async(s,i)=>await this.client.removePollVote(i,this.id,s),this.queryAnswers=async s=>await this.client.queryPollAnswers(this.id,s.filter,s.sort,s.options),this.queryOptionVotes=async s=>await this.client.queryPollVotes(this.id,s.filter,s.sort,s.options),this.client=e,this.id=t.id,this.state=new x(this.getInitialStateFromPollResponse(t))}get data(){return this.state.getLatestValue()}};function ve(e){let t=0,s=[];for(const[i,n]of Object.entries(e??{}))n>t?(s=[i],t=n):n===t&&s.push(i);return s}function Gc(e){return e?e.reduce((t,s)=>(Z(s)||!s.option_id||(t[s.option_id]=s),t),{}):{}}function Jc(e){return{allow_answers:e.allow_answers,allow_user_suggested_options:e.allow_user_suggested_options,description:e.description,enforce_unique_vote:e.enforce_unique_vote,id:e.id,is_closed:e.is_closed,max_votes_allowed:e.max_votes_allowed,name:e.name,options:e.options,voting_visibility:e.voting_visibility}}function Kc(e){const{lastActivityAt:t,maxVotedOptionIds:s,ownVotesByOptionId:i,ownAnswer:n,...r}=e.data,a=[...Object.values(i),...n?[n]:[]].sort((o,l)=>Date.parse(o.created_at)-Date.parse(l.created_at));return{...r,own_votes:a,id:e.id}}function ps(e){return{answers_count:e.answers_count,latest_votes_by_option:e.latest_votes_by_option,vote_count:e.vote_count,vote_counts_by_option:e.vote_counts_by_option}}var Yc=class extends ae{constructor({client:e}){super(),this.pollCache=new Map,this.fromState=t=>this.pollCache.get(t),this.registerSubscriptions=()=>{this.hasSubscriptions||(this.addUnsubscribeFunction(this.subscribeMessageNew()),this.addUnsubscribeFunction(this.subscribePollUpdated()),this.addUnsubscribeFunction(this.subscribePollClosed()),this.addUnsubscribeFunction(this.subscribeVoteCasted()),this.addUnsubscribeFunction(this.subscribeVoteChanged()),this.addUnsubscribeFunction(this.subscribeVoteRemoved()))},this.createPoll=async t=>{const{poll:s}=await this.client.createPoll(t);return s.vote_counts_by_option||(s.vote_counts_by_option={}),this.setOrOverwriteInCache(s),this.fromState(s.id)},this.getPoll=async t=>{const s=this.fromState(t);if(s)return this.client.getPoll(t).then(({poll:n})=>this.setOrOverwriteInCache(n,!0)),s;const{poll:i}=await this.client.getPoll(t);return this.setOrOverwriteInCache(i),this.fromState(t)},this.queryPolls=async(t,s=[],i={})=>{const{polls:n,next:r}=await this.client.queryPolls(t,s,i);return{polls:n.map(o=>(this.setOrOverwriteInCache(o,!0),this.fromState(o.id))),next:r}},this.hydratePollCache=(t,s)=>{for(const i of t){if(!i.poll)continue;const n=i.poll;this.setOrOverwriteInCache(n,s)}},this.setOrOverwriteInCache=(t,s)=>{if(!this.client._cacheEnabled())return;const i=this.fromState(t.id);if(i)s&&i.reinitializeState(t);else{const n=new Qc({client:this.client,poll:t});this.pollCache.set(n.id,n)}},this.subscribePollUpdated=()=>this.client.on("poll.updated",t=>{t.poll?.id&&this.fromState(t.poll.id)?.handlePollUpdated(t)}).unsubscribe,this.subscribePollClosed=()=>this.client.on("poll.closed",t=>{t.poll?.id&&this.fromState(t.poll.id)?.handlePollClosed(t)}).unsubscribe,this.subscribeVoteCasted=()=>this.client.on("poll.vote_casted",t=>{t.poll?.id&&this.fromState(t.poll.id)?.handleVoteCasted(t)}).unsubscribe,this.subscribeVoteChanged=()=>this.client.on("poll.vote_changed",t=>{t.poll?.id&&this.fromState(t.poll.id)?.handleVoteChanged(t)}).unsubscribe,this.subscribeVoteRemoved=()=>this.client.on("poll.vote_removed",t=>{t.poll?.id&&this.fromState(t.poll.id)?.handleVoteRemoved(t)}).unsubscribe,this.subscribeMessageNew=()=>this.client.on("message.new",t=>{const{message:s}=t;if(s){const i=I(s);this.hydratePollCache([i])}}).unsubscribe,this.client=e}get data(){return this.pollCache}},Ji={"channel.deleted":"channelDeletedHandler","channel.hidden":"channelHiddenHandler","channel.truncated":"channelTruncatedHandler","channel.updated":"channelUpdatedHandler","channel.visible":"channelVisibleHandler","message.new":"newMessageHandler","member.updated":"memberUpdatedHandler","notification.added_to_channel":"notificationAddedToChannelHandler","notification.message_new":"notificationNewMessageHandler","notification.removed_from_channel":"notificationRemovedFromChannelHandler"},Xc={abortInFlightQuery:!1,allowNotLoadedChannelPromotionForEvent:{"channel.visible":!0,"message.new":!0,"notification.added_to_channel":!0,"notification.message_new":!0},lockChannelOrder:!1},gs={limit:10,offset:0},Zc=class extends ae{constructor({client:e,eventHandlerOverrides:t={},options:s={},queryChannelsOverride:i}){super(),this.eventHandlers=new Map,this.eventHandlerOverrides=new Map,this.options={},this.stateOptions={},this.setChannels=n=>{this.state.next(l=>{const{channels:d}=l,c=zn(n)?n(d):n;return d===c?l:{...l,channels:c}});const{channels:r,pagination:{filters:a,sort:o}}=this.state.getLatestValue();this.client.offlineDb?.executeQuerySafely(l=>l.upsertCidsForQuery({cids:r.map(d=>d.cid),filters:a,sort:o}),{method:"upsertCidsForQuery"})},this.setEventHandlerOverrides=(n={})=>{const r=Object.entries(n).reduce((a,[o,l])=>(l&&(a[o]=l),a),{});this.eventHandlerOverrides=new Map(Object.entries(r))},this.setQueryChannelsRequest=n=>{this.queryChannelsRequest=n},this.setOptions=(n={})=>{this.options={...Xc,...n}},this.executeChannelsQuery=async(n,r=0)=>{const{filters:a,sort:o,options:l,stateOptions:d}=n,{offset:c,limit:h}={...gs,...l};try{const f=await this.queryChannelsRequest(a,o,l,d),m=c+(f?.length??0),u={...l,offset:m},{pagination:p}=this.state.getLatestValue();this.state.partialNext({channels:f,pagination:{...p,hasNext:(f?.length??0)>=h,isLoading:!1,options:u},initialized:!0,error:void 0}),this.client.offlineDb?.executeQuerySafely(y=>y.upsertCidsForQuery({cids:f.map(b=>b.cid),filters:p.filters,sort:p.sort}),{method:"upsertCidsForQuery"})}catch(f){if(r>=lo){console.warn(f);const m=new Error(`Maximum number of retries reached in queryChannels. Last error message is: ${f}`),u=this.state.getLatestValue(),p=this.client.offlineDb&&u.channels.length>0;this.state.partialNext({error:p?void 0:m,pagination:{...u.pagination,isLoading:!1,isLoadingNext:!1}});return}return await K(co),this.executeChannelsQuery(n,r+1)}},this.queryChannels=async(n,r=[],a={},o={})=>{const{pagination:{isLoading:l,filters:d},initialized:c}=this.state.getLatestValue();if(l&&!this.options.abortInFlightQuery&&JSON.stringify(d)===JSON.stringify(n))return;const h={filters:n,sort:r,options:a,stateOptions:o};try{if(this.stateOptions=o,this.state.next(f=>({...f,pagination:{...f.pagination,isLoading:!0,isLoadingNext:!1,filters:n,sort:r,options:a},error:void 0})),this.client.offlineDb?.getChannelsForQuery&&this.client.user?.id){if(!c){const f=await this.client.offlineDb.getChannelsForQuery({userId:this.client.user.id,filters:n,sort:r});if(f){const m=this.client.hydrateActiveChannels(f,{offlineMode:!0,skipInitialization:[]});this.state.partialNext({channels:m})}}if(!this.client.offlineDb.syncManager.syncStatus){this.client.offlineDb.syncManager.scheduleSyncStatusChangeCallback(this.id,async()=>{await this.executeChannelsQuery(h)});return}}await this.executeChannelsQuery(h)}catch(f){throw this.client.logger("error",f.message),this.state.next(m=>({...m,pagination:{...m.pagination,isLoading:!1}})),f}},this.loadNext=async()=>{const{pagination:n,initialized:r}=this.state.getLatestValue(),{filters:a,sort:o,options:l,isLoadingNext:d,hasNext:c}=n;if(!(!r||d||!c))try{const{offset:h,limit:f}={...gs,...l};this.state.partialNext({pagination:{...n,isLoading:!1,isLoadingNext:!0}});const m=await this.queryChannelsRequest(a,o,l,this.stateOptions),{channels:u}=this.state.getLatestValue(),p=h+(m?.length??0),y={...l,offset:p};this.state.partialNext({channels:xo([...u||[],...m],"cid"),pagination:{...n,hasNext:(m?.length??0)>=f,isLoading:!1,isLoadingNext:!1,options:y}})}catch(h){throw this.client.logger("error",h.message),this.state.next(f=>({...f,pagination:{...f.pagination,isLoadingNext:!1,isLoading:!1}})),h}},this.notificationAddedToChannelHandler=async n=>{const{id:r,type:a,members:o}=n?.channel??{};if(!a||!this.options.allowNotLoadedChannelPromotionForEvent?.["notification.added_to_channel"])return;const l=await rs({client:this.client,id:r,members:o?.reduce((f,{user:m,user_id:u})=>{const p=u||m?.id;return p&&f.push(p),f},[]),type:a}),{pagination:d,channels:c}=this.state.getLatestValue();if(!c)return;const{sort:h}=d??{};this.setChannels(ze({channels:c,channelToMove:l,sort:h}))},this.channelDeletedHandler=n=>{const{channels:r}=this.state.getLatestValue();if(!r)return;const a=[...r],o=a.findIndex(l=>l.cid===(n.cid||n.channel?.cid));o<0||(a.splice(o,1),this.setChannels(a))},this.channelHiddenHandler=this.channelDeletedHandler,this.newMessageHandler=n=>{const{pagination:r,channels:a}=this.state.getLatestValue();if(!a)return;const{filters:o,sort:l}=r??{},d=n.channel_type,c=n.channel_id;if(!d||!c)return;const h=this.client.channel(d,c),f=a.indexOf(h),m=f>=0,u=ct(h),p=je(h),y=We(o),b=Es(l);y&&p&&!o.archived||y&&!p&&o.archived||b&&u||this.options.lockChannelOrder||!m&&!this.options.allowNotLoadedChannelPromotionForEvent?.["message.new"]||this.setChannels(ze({channels:a,channelToMove:h,channelToMoveIndexWithinChannels:f,sort:l}))},this.notificationNewMessageHandler=async n=>{const{id:r,type:a}=n?.channel??{};if(!r||!a)return;const o=await rs({client:this.client,id:r,type:a}),{channels:l,pagination:d}=this.state.getLatestValue(),{filters:c,sort:h}=d??{},f=We(c),m=je(o);!l||f&&m&&!c.archived||f&&!m&&c.archived||!this.options.allowNotLoadedChannelPromotionForEvent?.["notification.message_new"]||this.setChannels(ze({channels:l,channelToMove:o,sort:h}))},this.channelVisibleHandler=async n=>{const{channel_type:r,channel_id:a}=n;if(!r||!a)return;const o=await rs({client:this.client,id:n.channel_id,type:n.channel_type}),{channels:l,pagination:d}=this.state.getLatestValue(),{sort:c,filters:h}=d??{},f=We(h),m=je(o);!l||f&&m&&!h.archived||f&&!m&&h.archived||!this.options.allowNotLoadedChannelPromotionForEvent?.["channel.visible"]||this.setChannels(ze({channels:l,channelToMove:o,sort:c}))},this.notificationRemovedFromChannelHandler=this.channelDeletedHandler,this.memberUpdatedHandler=n=>{const{pagination:r,channels:a}=this.state.getLatestValue(),{filters:o,sort:l}=r;if(!n.member?.user||n.member.user.id!==this.client.userID||!n.channel_type||!n.channel_id)return;const d=n.channel_type,c=n.channel_id,h=Es(l),f=We(o),m=Pn({atIndex:0,sort:l,targetKey:"pinned_at"});if(!a||!h&&!f||this.options.lockChannelOrder)return;const u=this.client.channel(d,c),p=a.indexOf(u),y=p>=0,b=ct(u),w=je(u),v=[...a];if(y&&v.splice(p,1),f&&!w&&o?.archived||f&&w&&!o?.archived){this.setChannels(v);return}let C=null;(m===1||m===-1&&!b)&&(C=On({channels:v}));const S=typeof C=="number"?C+1:0;a[S]!==u&&(v.splice(S,0,u),this.setChannels(v))},this.subscriptionOrOverride=n=>{const r=Ji[n.type],a=this.eventHandlers.get(r),o=this.eventHandlerOverrides.get(r);if(o&&typeof o=="function"){o(this.setChannels,n);return}a&&typeof a=="function"&&a(n)},this.registerSubscriptions=()=>{if(!this.hasSubscriptions)for(const n of Object.keys(Ji))this.addUnsubscribeFunction(this.client.on(n,this.subscriptionOrOverride).unsubscribe)},this.id=`channel-manager-${P()}`,this.client=e,this.state=new x({channels:[],pagination:{isLoading:!1,isLoadingNext:!1,hasNext:!1,filters:{},sort:{},options:gs},initialized:!1,error:void 0}),this.setEventHandlerOverrides(t),this.setOptions(s),this.queryChannelsRequest=i??((...n)=>this.client.queryChannels(...n)),this.eventHandlers=new Map(Object.entries({channelDeletedHandler:this.channelDeletedHandler,channelHiddenHandler:this.channelHiddenHandler,channelVisibleHandler:this.channelVisibleHandler,memberUpdatedHandler:this.memberUpdatedHandler,newMessageHandler:this.newMessageHandler,notificationAddedToChannelHandler:this.notificationAddedToChannelHandler,notificationNewMessageHandler:this.notificationNewMessageHandler,notificationRemovedFromChannelHandler:this.notificationRemovedFromChannelHandler}))}},Ye=3e3,ed={durations:{error:Ye,info:Ye,success:Ye,warning:Ye}},td=class{constructor(e={}){this.timeouts=new Map,this.store=new x({notifications:[]}),this.config=he(ed,e)}get notifications(){return this.store.getLatestValue().notifications}get warning(){return this.notifications.filter(e=>e.severity==="warning")}get error(){return this.notifications.filter(e=>e.severity==="error")}get info(){return this.notifications.filter(e=>e.severity==="info")}get success(){return this.notifications.filter(e=>e.severity==="success")}add({message:e,origin:t,options:s={}}){const i=P(),n=Date.now(),r=s.severity||"info",a=s.duration??this.config.durations[r],o={id:i,message:e,origin:t,type:s?.type,severity:r,createdAt:n,expiresAt:n+a,actions:s.actions,metadata:s.metadata,originalError:s.originalError};if(this.store.partialNext({notifications:[...this.store.getLatestValue().notifications,o]}),o.expiresAt){const l=setTimeout(()=>{this.remove(i)},s.duration||this.config.durations[o.severity]);this.timeouts.set(i,l)}return i}addError({message:e,origin:t,options:s}){return this.add({message:e,origin:t,options:{...s,severity:"error"}})}addWarning({message:e,origin:t,options:s}){return this.add({message:e,origin:t,options:{...s,severity:"warning"}})}addInfo({message:e,origin:t,options:s}){return this.add({message:e,origin:t,options:{...s,severity:"info"}})}addSuccess({message:e,origin:t,options:s}){return this.add({message:e,origin:t,options:{...s,severity:"success"}})}remove(e){const t=this.timeouts.get(e);t&&(clearTimeout(t),this.timeouts.delete(e)),this.store.partialNext({notifications:this.store.getLatestValue().notifications.filter(s=>s.id!==e)})}clear(){this.timeouts.forEach(e=>clearTimeout(e)),this.timeouts.clear(),this.store.partialNext({notifications:[]})}},qt=60*1e3,ai=60*qt,oi=24*ai,sd=7*oi,ms={minute:{lower:qt,upper:ai},hour:{upper:oi}},pr=2*sd,id=class{constructor({reminder:e,config:t}){this.timeout=null,this.stopRefreshBoundaryMs=pr,this.getRefreshIntervalLength=()=>{if(!this.reminder.remindAt)return null;const s=Math.abs(Bt(this.reminder.remindAt.getTime()));let i;return s===0?i=qt:s<ms.minute.lower?i=s:s<=ms.minute.upper?i=qt:s<=ms.hour.upper?i=ai:i=oi,i},this.init=()=>{if(!this.reminder.remindAt)return null;const s=this.getRefreshIntervalLength();if(s===null)return null;if(this.reminder.remindAt?.getTime()+this.stopRefreshBoundaryMs-Date.now()<=0){this.timeout=null;return}this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.reminder.refreshTimeLeft(),this.init()},s)},this.clear=()=>{this.timeout&&(clearInterval(this.timeout),this.timeout=null)},this.reminder=e,typeof t?.stopRefreshBoundaryMs=="number"&&(this.stopRefreshBoundaryMs=t.stopRefreshBoundaryMs)}},Bt=e=>e-new Date().getTime(),gr=class $s{constructor({data:t,config:s}){this.setState=i=>{this.state.next(n=>{const r={...n,...$s.toStateValue(i)};return r.remind_at&&(r.timeLeftMs=Bt(r.remind_at.getTime())),r}),i.remind_at?this.initTimer():i.remind_at||this.clearTimer()},this.refreshTimeLeft=()=>{this.remindAt&&this.state.partialNext({timeLeftMs:Bt(this.remindAt.getTime())})},this.initTimer=()=>{this.timer.init()},this.clearTimer=()=>{this.timer.clear()},this.state=new x($s.toStateValue(t)),this.timer=new id({reminder:this,config:s}),this.initTimer()}get id(){return this.state.getLatestValue().message_id}get remindAt(){return this.state.getLatestValue().remind_at}get timeLeftMs(){return this.state.getLatestValue().timeLeftMs}};gr.toStateValue=e=>({...e,created_at:new Date(e.created_at),message:e.message||null,remind_at:e.remind_at?new Date(e.remind_at):null,timeLeftMs:e.remind_at?Bt(new Date(e.remind_at).getTime()):null,updated_at:new Date(e.updated_at),user:e.user||null});var nd=gr,Vs=60*1e3,rt=60*Vs,rd=24*rt,Ki={scheduledOffsetsMs:[2*Vs,30*Vs,rt,2*rt,8*rt,rd],stopTimerRefreshBoundaryMs:pr},ad=e=>e.message.match("already has reminder created for this message_id"),od=e=>e.message.match("reminder does not exist"),mr=class at extends ae{constructor({client:t,config:s}){super(),this.upsertToState=({data:i,overwrite:n=!0})=>{if(!this.client._cacheEnabled())return;const r=this.getFromState(i.message_id);if(r)n&&r.setState(i);else{const a=new nd({data:i,config:{stopRefreshBoundaryMs:this.stopTimerRefreshBoundaryMs}});this.state.partialNext({reminders:new Map(this.reminders.set(i.message_id,a))})}return r},this.removeFromState=i=>{const n=this.getFromState(i);if(!n)return;n.clearTimer();const r=this.reminders;r.delete(i),this.state.partialNext({reminders:new Map(r)})},this.hydrateState=i=>{i.forEach(({reminder:n})=>{n&&this.upsertToState({data:n})})},this.initTimers=()=>{this.reminders.forEach(i=>i.initTimer())},this.clearTimers=()=>{this.reminders.forEach(i=>i.clearTimer())},this.registerSubscriptions=()=>{this.hasSubscriptions||(this.addUnsubscribeFunction(this.subscribeReminderCreated()),this.addUnsubscribeFunction(this.subscribeReminderUpdated()),this.addUnsubscribeFunction(this.subscribeReminderDeleted()),this.addUnsubscribeFunction(this.subscribeNotificationReminderDue()),this.addUnsubscribeFunction(this.subscribeMessageDeleted()),this.addUnsubscribeFunction(this.subscribeMessageUndeleted()),this.addUnsubscribeFunction(this.subscribePaginatorStateUpdated()),this.addUnsubscribeFunction(this.subscribeConfigStateUpdated()))},this.subscribeReminderCreated=()=>this.client.on("reminder.created",i=>{if(!at.isReminderWsEventPayload(i))return;const{reminder:n}=i;this.upsertToState({data:n})}).unsubscribe,this.subscribeReminderUpdated=()=>this.client.on("reminder.updated",i=>{if(!at.isReminderWsEventPayload(i))return;const{reminder:n}=i;this.upsertToState({data:n})}).unsubscribe,this.subscribeReminderDeleted=()=>this.client.on("reminder.deleted",i=>{at.isReminderWsEventPayload(i)&&this.removeFromState(i.message_id)}).unsubscribe,this.subscribeMessageDeleted=()=>this.client.on("message.deleted",i=>{i.message?.id&&this.removeFromState(i.message.id)}).unsubscribe,this.subscribeMessageUndeleted=()=>this.client.on("message.undeleted",i=>{i.message?.reminder&&this.upsertToState({data:i.message.reminder})}).unsubscribe,this.subscribeNotificationReminderDue=()=>this.client.on("notification.reminder_due",()=>null).unsubscribe,this.subscribePaginatorStateUpdated=()=>this.paginator.state.subscribeWithSelector(({items:i})=>[i],([i])=>{if(i)for(const n of i)this.upsertToState({data:n})}),this.subscribeConfigStateUpdated=()=>this.configState.subscribeWithSelector(({stopTimerRefreshBoundaryMs:i})=>({stopTimerRefreshBoundaryMs:i}),({stopTimerRefreshBoundaryMs:i},n)=>{typeof i=="number"&&i!==n?.stopTimerRefreshBoundaryMs&&this.reminders.forEach(r=>{r.timer&&(r.timer.stopRefreshBoundaryMs=i)})}),this.upsertReminder=async i=>{const{messageId:n}=i;if(this.getFromState(n))try{return await this.updateReminder(i)}catch(r){if(od(r))return await this.createReminder(i);throw r}else try{return await this.createReminder(i)}catch(r){if(ad(r))return await this.updateReminder(i);throw r}},this.createReminder=async i=>{const{reminder:n}=await this.client.createReminder(i);return this.upsertToState({data:n,overwrite:!1})},this.updateReminder=async i=>{const{reminder:n}=await this.client.updateReminder(i);return this.upsertToState({data:n})},this.deleteReminder=async i=>{await this.client.deleteReminder(i),this.removeFromState(i)},this.queryNextReminders=async()=>{await this.paginator.next()},this.queryPreviousReminders=async()=>{await this.paginator.prev()},this.client=t,this.configState=new x({scheduledOffsetsMs:s?.scheduledOffsetsMs??Ki.scheduledOffsetsMs,stopTimerRefreshBoundaryMs:s?.stopTimerRefreshBoundaryMs??Ki.stopTimerRefreshBoundaryMs}),this.state=new x({reminders:new Map}),this.paginator=new sc(t)}updateConfig(t){typeof t.stopTimerRefreshBoundaryMs=="number"&&t.stopTimerRefreshBoundaryMs!==this.stopTimerRefreshBoundaryMs&&this.reminders.forEach(s=>{s.timer.stopRefreshBoundaryMs=t?.stopTimerRefreshBoundaryMs}),this.configState.partialNext(t)}get stopTimerRefreshBoundaryMs(){return this.configState.getLatestValue().stopTimerRefreshBoundaryMs}get scheduledOffsetsMs(){return this.configState.getLatestValue().scheduledOffsetsMs}get reminders(){return this.state.getLatestValue().reminders}getFromState(t){return this.reminders.get(t)}};mr.isReminderWsEventPayload=e=>!!e.reminder&&(e.type.startsWith("reminder.")||e.type==="notification.reminder_due");var ld=mr;function ys(e){return typeof e=="string"||e instanceof String}var Nd=class ee{constructor(t,s,i){this.nextRequestAbortController=null,this._messageComposerSetupState=new x({setupFunction:null}),this._getConnectionID=()=>this.wsConnection?.connectionID||this.wsFallback?.connectionID,this._hasConnectionID=()=>!!this._getConnectionID(),this.setMessageComposerSetupFunction=r=>{this._messageComposerSetupState.partialNext({setupFunction:r})},this.connectUser=async(r,a)=>{if(!r.id)throw new Error('The "id" field on the user is missing');if(this.userID===r.id&&this.setUserPromise)return console.warn("Consecutive calls to connectUser is detected, ideally you should only call this function once in your app."),this.setUserPromise;if(this.userID)throw new Error("Use client.disconnect() before trying to connect as a different user. connectUser was called twice.");(this._isUsingServerAuth()||this.node)&&!this.options.allowServerSideConnect&&console.warn('Please do not use connectUser server side. connectUser impacts MAU and concurrent connection usage and thus your bill. If you have a valid use-case, add "allowServerSideConnect: true" to the client options to disable this warning.'),this.userID=r.id,this.anonymous=!1;const o=this._setToken(r,a);this._setUser(r);const l=this.openConnection();this.setUserPromise=Promise.all([o,l]).then(d=>d[1]);try{return await this.setUserPromise}catch(d){throw this.persistUserOnConnectionFailure?this.closeConnection():this.disconnectUser(),d}},this.setUser=this.connectUser,this._setToken=(r,a)=>this.tokenManager.setTokenOrProvider(a,r),this.closeConnection=async r=>(this.cleaningIntervalRef!=null&&(clearInterval(this.cleaningIntervalRef),this.cleaningIntervalRef=void 0),await Promise.all([this.wsConnection?.disconnect(r),this.wsFallback?.disconnect(r)]),this.offlineDb?.executeQuerySafely(async a=>{this.userID&&await a.upsertUserSyncStatus({userId:this.userID,lastSyncedAt:new Date().toString()})},{method:"upsertUserSyncStatus"}),Promise.resolve()),this.createChannelManager=({eventHandlerOverrides:r={},options:a={},queryChannelsOverride:o})=>new Zc({client:this,eventHandlerOverrides:r,options:a,queryChannelsOverride:o}),this.openConnection=()=>{if(!this.userID)throw Error("User is not set on client, use client.connectUser or client.connectAnonymousUser instead");if(this.wsConnection?.isConnecting&&this.wsPromise)return this.logger("info","client:openConnection() - connection already in progress",{tags:["connection","client"]}),this.wsPromise;if((this.wsConnection?.isHealthy||this.wsFallback?.isHealthy())&&this._hasConnectionID()){this.logger("info","client:openConnection() - openConnection called twice, healthy connection already exists",{tags:["connection","client"]});return}return this.clientID=`${this.userID}--${de()}`,this.wsPromise=this.connect(),this._startCleaning(),this.wsPromise},this._setupConnection=this.openConnection,this._normalizeDate=r=>{if(r instanceof Date&&(r=r.toISOString()),r==="")throw new Error("Don't pass blank string for since, use null instead if resetting the token revoke");return r},this.disconnectUser=r=>{this.logger("info","client:disconnect() - Disconnecting the client",{tags:["connection","client"]}),delete this.user,delete this._user,delete this.userID,this.anonymous=!1;const a=this.closeConnection(r);for(const o of Object.values(this.activeChannels))o._disconnect();return this.activeChannels={},this.state=new Vi({client:this}),this.threads.resetState(),setTimeout(this.tokenManager.reset),a},this.disconnect=this.disconnectUser,this.connectAnonymousUser=()=>{(this._isUsingServerAuth()||this.node)&&!this.options.allowServerSideConnect&&console.warn('Please do not use connectUser server side. connectUser impacts MAU and concurrent connection usage and thus your bill. If you have a valid use-case, add "allowServerSideConnect: true" to the client options to disable this warning.'),this.anonymous=!0,this.userID=de();const r={id:this.userID,anon:!0};return this._setToken(r,""),this._setUser(r),this._setupConnection()},this.setAnonymousUser=this.connectAnonymousUser,this.doAxiosRequest=async(r,a,o,l={})=>{await this.tokenManager.tokenReady();const d=this._enrichAxiosOptions(l);try{let c;switch(this._logApiRequest(r,a,o,d),r){case"get":c=await this.axiosInstance.get(a,d);break;case"delete":c=await this.axiosInstance.delete(a,d);break;case"post":c=await this.axiosInstance.post(a,o,d);break;case"postForm":c=await this.axiosInstance.postForm(a,o,d);break;case"put":c=await this.axiosInstance.put(a,o,d);break;case"patch":c=await this.axiosInstance.patch(a,o,d);break;case"options":c=await this.axiosInstance.options(a,d);break;default:throw new Error("Invalid request type")}return this._logApiResponse(r,a,c),this.consecutiveFailures=0,this.handleResponse(c)}catch(c){if(c.client_request_id=d.headers?.["x-client-request-id"],this._logApiError(r,a,c),this.consecutiveFailures+=1,c.response)return c.response.data.code===Ce.TOKEN_EXPIRED&&!this.tokenManager.isStatic()?(this.consecutiveFailures>1&&await K(lt(this.consecutiveFailures)),this.tokenManager.loadToken(),await this.doAxiosRequest(r,a,o,l)):this.handleResponse(c.response);throw c}},this.dispatchEvent=r=>{r.received_at||(r.received_at=new Date);const a=this._handleClientEvent(r),o=r.cid,l=o?this.activeChannels[o]:void 0;l&&l._handleChannelEvent(r),this._callClientListeners(r),l&&l._callChannelListeners(r),a.forEach(d=>d()),this.offlineDb?.executeQuerySafely(d=>d.handleEvent({event:r}),{method:`handleEvent;${r.type}`})},this.handleEvent=r=>{const a=r.data,o=JSON.parse(a);this.dispatchEvent(o)},this._updateMemberWatcherReferences=r=>{const a=this.state.userChannelReferences[r.id]||{};for(const o in a){const l=this.activeChannels[o];l?.state&&(l.state.members[r.id]&&(l.state.members[r.id].user=r),l.state.watchers[r.id]&&(l.state.watchers[r.id]=r),l.state.read[r.id]&&(l.state.read[r.id].user=r))}},this._updateUserReferences=this._updateMemberWatcherReferences,this._updateUserMessageReferences=r=>{const a=this.state.userChannelReferences[r.id]||{};for(const o in a){const l=this.activeChannels[o];if(!l)continue;l.state?.updateUserMessages(r)}},this._deleteUserMessageReference=(r,a=!1,o)=>{const l=this.state.userChannelReferences[r.id]||{};for(const d in l){const c=this.activeChannels[d];c&&c.state?.deleteUserMessages(r,a,o)}},this._handleUserEvent=r=>{if(r.user){if(r.type==="user.presence.changed"||r.type==="user.updated"){if(r.user.id===this.userID){const a={...this.user},o={...this._user};for(const l in this.user){if(l in r.user||go(l))continue;const d=l;delete a[d],delete o[d]}for(const l in o){const d=l;d in r.user&&(o[d]=r.user[d])}this._user=o,this.user={...a,...r.user}}this.state.updateUser(r.user),this._updateMemberWatcherReferences(r.user)}r.type==="user.updated"&&this._updateUserMessageReferences(r.user),r.type==="user.deleted"&&r.user.deleted_at&&(r.mark_messages_deleted||r.hard_delete)&&this._deleteUserMessageReference(r.user,r.hard_delete,r.user.deleted_at?new Date(r.user.deleted_at):null)}},this._callClientListeners=r=>{const a=this,o=[];a.listeners.all&&o.push(...a.listeners.all),a.listeners[r.type]&&o.push(...a.listeners[r.type]);for(const l of o)l(r)},this.recoverState=async()=>{this.logger("info",`client:recoverState() - Start of recoverState with connectionID ${this._getConnectionID()}`,{tags:["connection"]});const r=Object.keys(this.activeChannels);r.length&&this.recoverStateOnReconnect?(this.logger("info",`client:recoverState() - Start the querying of ${r.length} channels`,{tags:["connection","client"]}),await this.queryChannels({cid:{$in:r}},{last_message_at:-1},{limit:30}),this.logger("info","client:recoverState() - Querying channels finished",{tags:["connection","client"]}),this.dispatchEvent({type:"connection.recovered"})):this.dispatchEvent({type:"connection.recovered"}),this.wsPromise=Promise.resolve(),this.setUserPromise=Promise.resolve()},this.getChannelByMembers=(r,a)=>{const o=(a.members??[]).map(h=>typeof h=="string"?h:h.user_id??""),l=o.sort().join(","),d=Gs(r,o);if(!d)throw Error("Please specify atleast one member when creating unique conversation");for(const h in this.activeChannels){const f=this.activeChannels[h];if(!f.disconnected&&(h===d||h.indexOf(`${r}:!members-`)===0&&Object.keys(f.state.members).sort().join(",")===l))return f}const c=new ue(this,r,void 0,a);return this._cacheEnabled()&&(this.activeChannels[d]=c),c},this.getChannelById=(r,a,o)=>{if(typeof a=="string"&&~a.indexOf(":"))throw Error(`Invalid channel id ${a}, can't contain the : character`);const l=`${r}:${a}`;if(l in this.activeChannels&&this.activeChannels[l]&&!this.activeChannels[l].disconnected){const c=this.activeChannels[l];return Object.keys(o).length>0&&(c.data={...c.data,...o},c._data={...c._data,...o}),c}const d=new ue(this,r,a,o);return this._cacheEnabled()&&(this.activeChannels[d.cid]=d),d},this.updateUsers=this.upsertUsers,this.updateUser=this.upsertUser,this._unblockMessage=this.unblockMessage,this.markAllRead=this.markChannelsRead,this._isUsingServerAuth=()=>!!this.secret,this._cacheEnabled=()=>!this._isUsingServerAuth()||!this.options.disableCache,this._buildWSPayload=r=>JSON.stringify({user_id:this.userID,user_details:this._user,device:this.options.device,client_request_id:r}),this.key=t,this.listeners={},this.state=new Vi({client:this}),this.mutedChannels=[],this.mutedUsers=[],this.moderation=new qc(this),this.notifications=i?.notifications??new td,s&&ys(s)&&(this.secret=s);const n=i||(s&&!ys(s)?s:{});this.browser=typeof n.browser<"u"?n.browser:typeof window<"u",this.node=!this.browser,this.options={timeout:3e3,withCredentials:!1,warmUp:!1,recoverStateOnReconnect:!0,disableCache:!1,wsUrlParams:new URLSearchParams({}),...n},this.node&&!this.options.httpsAgent&&(this.options.httpsAgent=new Za.default.Agent({keepAlive:!0,keepAliveMsecs:3e3})),this.axiosInstance=Oe.create(this.options),this.setBaseURL(this.options.baseURL||"https://chat.stream-io-api.com"),typeof process<"u"&&"env"in process&&Xt.STREAM_LOCAL_TEST_RUN&&this.setBaseURL("http://localhost:3030"),typeof process<"u"&&"env"in process&&Xt.STREAM_LOCAL_TEST_HOST&&this.setBaseURL("http://"+Xt.STREAM_LOCAL_TEST_HOST),this.wsConnection=null,this.wsPromise=null,this.setUserPromise=null,this.activeChannels={},this.configs={},this.anonymous=!1,this.persistUserOnConnectionFailure=this.options?.persistUserOnConnectionFailure,this.tokenManager=new Ic(this.secret),this.consecutiveFailures=0,this.insightMetrics=new Sc,this.defaultWSTimeoutWithFallback=6*1e3,this.defaultWSTimeout=15*1e3,this.axiosInstance.defaults.paramsSerializer=Co,this.logger=Rs(n.logger)?n.logger:()=>null,this.recoverStateOnReconnect=this.options.recoverStateOnReconnect,this.threads=new $c({client:this}),this.polls=new Yc({client:this}),this.reminders=new ld({client:this})}static getInstance(t,s,i){return ee._instance||(typeof s=="string"?ee._instance=new ee(t,s,i):ee._instance=new ee(t,s)),ee._instance}setOfflineDBApi(t){this.offlineDb||(this.offlineDb=t)}devToken(t){return Lc(t)}getAuthType(){return this.anonymous?"anonymous":"jwt"}setBaseURL(t){this.baseURL=t,this.wsBaseURL=this.baseURL.replace("http","ws").replace(":3030",":8800")}_setUser(t){this.user=t,this.userID=t.id,this._user={...t}}async updateAppSettings(t){const s=t.apn_config;return s?.p12_cert&&(t={...t,apn_config:{...s,p12_cert:Buffer.from(s.p12_cert).toString("base64")}}),await this.patch(this.baseURL+"/app",t)}async revokeTokens(t){return await this.updateAppSettings({revoke_tokens_issued_before:this._normalizeDate(t)})}async revokeUserToken(t,s){return await this.revokeUsersToken([t],s)}async revokeUsersToken(t,s){s===void 0?s=new Date().toISOString():s=this._normalizeDate(s);const i=[];for(const n of t)i.push({id:n,set:{revoke_tokens_issued_before:s}});return await this.partialUpdateUsers(i)}async getAppSettings(){return this.appSettingsPromise=this.get(this.baseURL+"/app"),await this.appSettingsPromise}async testPushSettings(t,s={}){return await this.post(this.baseURL+"/check_push",{user_id:t,...s.messageID?{message_id:s.messageID}:{},...s.apnTemplate?{apn_template:s.apnTemplate}:{},...s.firebaseTemplate?{firebase_template:s.firebaseTemplate}:{},...s.firebaseDataTemplate?{firebase_data_template:s.firebaseDataTemplate}:{},...s.skipDevices?{skip_devices:!0}:{},...s.pushProviderName?{push_provider_name:s.pushProviderName}:{},...s.pushProviderType?{push_provider_type:s.pushProviderType}:{}})}async testSQSSettings(t={}){return await this.post(this.baseURL+"/check_sqs",t)}async testSNSSettings(t={}){return await this.post(this.baseURL+"/check_sns",t)}async setGuestUser(t){let s;this.anonymous=!0;try{s=await this.post(this.baseURL+"/guest",{user:t})}catch(l){throw this.anonymous=!1,l}this.anonymous=!1;const{created_at:i,updated_at:n,last_active:r,online:a,...o}=s.user;return await this.connectUser(o,s.access_token)}createToken(t,s,i){if(this.secret==null)throw Error("tokens can only be created server-side using the API Secret");const n={};return s&&(n.exp=s),i&&(n.iat=i),fr(this.secret,t,n,{})}on(t,s){const i=s?t:"all",n=s||t;return i in this.listeners||(this.listeners[i]=[]),this.logger("info",`Attaching listener for ${i} event`,{tags:["event","client"]}),this.listeners[i].push(n),{unsubscribe:()=>{this.logger("info",`Removing listener for ${i} event`,{tags:["event","client"]}),this.listeners[i]=this.listeners[i].filter(r=>r!==n)}}}off(t,s){const i=s?t:"all",n=s||t;i in this.listeners||(this.listeners[i]=[]),this.logger("info",`Removing listener for ${i} event`,{tags:["event","client"]}),this.listeners[i]=this.listeners[i].filter(r=>r!==n)}_logApiRequest(t,s,i,n){this.logger("info",`client: ${t} - Request - ${s}`,{tags:["api","api_request","client"],url:s,payload:i,config:n})}_logApiResponse(t,s,i){this.logger("info",`client:${t} - Response - url: ${s} > status ${i.status}`,{tags:["api","api_response","client"],url:s,response:i})}_logApiError(t,s,i){this.logger("error",`client:${t} - Error - url: ${s}`,{tags:["api","api_response","client"],url:s,error:i})}get(t,s){return this.doAxiosRequest("get",t,null,{params:s})}put(t,s){return this.doAxiosRequest("put",t,s)}post(t,s){return this.doAxiosRequest("post",t,s)}patch(t,s){return this.doAxiosRequest("patch",t,s)}delete(t,s){return this.doAxiosRequest("delete",t,null,{params:s})}sendFile(t,s,i,n,r){const a=mo(s,i,n||"multipart/form-data");return r!=null&&a.append("user",JSON.stringify(r)),this.doAxiosRequest("postForm",t,a,{headers:a.getHeaders?a.getHeaders():{},config:{timeout:0,maxContentLength:1/0,maxBodyLength:1/0}})}errorFromResponse(t){const s=typeof t.data.code<"u"?`StreamChat error code ${t.data.code}: ${t.data.message}`:`StreamChat error HTTP code: ${t.status}`;return new Tl(s,{code:t.data.code??null,response:t,status:t.status})}handleResponse(t){const s=t.data;if(Nc(t))throw this.errorFromResponse(t);return s}_handleClientEvent(t){const s=this,i=[];if(this.logger("info",`client:_handleClientEvent - Received event of type { ${t.type} }`,{tags:["event","client"],event:t}),(t.type==="user.presence.changed"||t.type==="user.updated"||t.type==="user.deleted")&&this._handleUserEvent(t),t.type==="user.messages.deleted"&&!t.cid&&t.user&&this._deleteUserMessageReference(t.user,t.hard_delete,t.created_at?new Date(t.created_at):null),t.type==="health.check"&&t.me&&(s.user=t.me,s.state.updateUser(t.me),s.mutedChannels=t.me.channel_mutes,s.mutedUsers=t.me.mutes),t.channel&&t.type==="notification.message_new"){const{channel:n}=t;this._addChannelConfig(n)}if(t.type==="notification.channel_mutes_updated"&&t.me?.channel_mutes&&(this.mutedChannels=t.me.channel_mutes),t.type==="notification.mutes_updated"&&t.me?.mutes&&(this.mutedUsers=t.me.mutes),t.type==="notification.mark_read"&&t.unread_channels===0&&Object.keys(this.activeChannels).forEach(r=>this.activeChannels[r].state.unreadCount=0),(t.type==="channel.deleted"||t.type==="notification.channel_deleted")&&t.cid){const{cid:n}=t;s.state.deleteAllChannelReference(n),this.activeChannels[t.cid]?._disconnect(),i.push(()=>{n&&delete this.activeChannels[n]})}return i}_muteStatus(t){let s;for(let i=0;i<this.mutedChannels.length;i++){const n=this.mutedChannels[i];if(n.channel?.cid===t){s={muted:n.expires?new Date(n.expires).getTime()>new Date().getTime():!0,createdAt:n.created_at?new Date(n.created_at):new Date,expiresAt:n.expires?new Date(n.expires):null};break}}return s||{muted:!1,createdAt:null,expiresAt:null}}async connect(){if(!this.userID||!this._user)throw Error("Call connectUser or connectAnonymousUser before starting the connection");if(!this.wsBaseURL)throw Error("Websocket base url not set");if(!this.clientID)throw Error("clientID is not set");!this.wsConnection&&(this.options.warmUp||this.options.enableInsights)&&this._sayHi(),this.options.wsConnection&&this.node?(this.options.wsConnection.setClient(this),this.wsConnection=this.options.wsConnection):this.wsConnection=new Mc({client:this});try{return this.wsFallback?await this.wsFallback.connect():await this.wsConnection.connect(this.options.enableWSFallback?this.defaultWSTimeoutWithFallback:this.defaultWSTimeout)}catch(t){if(this.options.enableWSFallback&&kc(t)&&vo())return this.logger("info","client:connect() - WS failed, fallback to longpoll",{tags:["connection","client"]}),this.dispatchEvent({type:"transport.changed",mode:"longpoll"}),this.wsConnection._destroyCurrentWSConnection(),this.wsConnection.disconnect().then(),this.wsFallback=new Fc({client:this}),await this.wsFallback.connect();throw t}}_sayHi(){const t=de(),s={headers:{"x-client-request-id":t}};this.doAxiosRequest("get",this.baseURL+"/hi",null,s).catch(i=>{this.options.enableInsights&&Bs("http_hi_failed",{api_key:this.key,err:i,client_request_id:t})})}async queryUsers(t,s=[],i={}){const n={presence:!1};await this.wsPromise,this._hasConnectionID()||(n.presence=!1);const r=await this.get(this.baseURL+"/users",{payload:{filter_conditions:t,sort:L(s),...n,...i}});return this.state.updateUsers(r.users),r}async queryBannedUsers(t={},s=[],i={}){return await this.get(this.baseURL+"/query_banned_users",{payload:{filter_conditions:t,sort:L(s),...i}})}async queryMessageFlags(t={},s={}){return await this.get(this.baseURL+"/moderation/flags/message",{payload:{filter_conditions:t,...s}})}async queryChannelsRequest(t,s=[],i={}){const n={state:!0,watch:!0,presence:!1};await this.wsPromise,this._hasConnectionID()||(n.watch=!1);const r={filter_conditions:t,sort:L(s),...n,...i};return(await this.post(this.baseURL+"/channels",r)).channels}async queryChannels(t,s=[],i={},n={}){const r=await this.queryChannelsRequest(t,s,i);return this.dispatchEvent({type:"channels.queried",queriedChannels:{channels:r,isLatestMessageSet:!0}}),r?.length&&this.offlineDb?.upsertChannels&&await this.offlineDb.upsertChannels({channels:r,isLatestMessagesSet:!0}),this.hydrateActiveChannels(r,n,i)}async queryReactions(t,s,i=[],n={}){const r={filter:s,sort:L(i),...n};if(this.offlineDb?.getReactions&&!n.next)try{const a=await this.offlineDb.getReactions({messageId:t,filters:s,sort:i,limit:n.limit});a&&this.dispatchEvent({type:"offline_reactions.queried",offlineReactions:a})}catch(a){this.logger("warn","An error has occurred while querying offline reactions",{error:a})}return await this.wsPromise,await this.post(this.baseURL+"/messages/"+encodeURIComponent(t)+"/reactions",r)}hydrateActiveChannels(t=[],s={},i){const{skipInitialization:n,offlineMode:r=!1}=s,a=[];for(const o of t){this._addChannelConfig(o.channel);const l=this.channel(o.channel.type,o.channel.id);l.data=o.channel,l.offlineMode=r,l.initialized=!r,l.push_preferences=o.push_preferences;let d;if(n===void 0){const{messageSet:c}=l._initializeState(o,"latest");d=c}else if(!n.includes(o.channel.id)){l.state.clearMessages();const{messageSet:c}=l._initializeState(o,"latest");d=c}d&&(d.pagination={...d.pagination,...Dn({parentSet:d,requestedPageSize:i?.message_limit||to,returnedPage:o.messages,logger:this.logger})},this.polls.hydratePollCache(o.messages,!0),this.reminders.hydrateState(o.messages)),l.messageComposer.initStateFromChannelResponse(o),a.push(l)}return a}async search(t,s,i={}){if(i.offset&&i.next)throw Error("Cannot specify offset with next");const n={filter_conditions:t,...i,sort:i.sort?L(i.sort):void 0};if(typeof s=="string")n.query=s;else if(typeof s=="object")n.message_filter_conditions=s;else throw Error(`Invalid type ${typeof s} for query parameter`);return await this.wsPromise,await this.get(this.baseURL+"/search",{payload:n})}setLocalDevice(t){if(this.wsConnection?.isConnecting&&this.wsPromise||(this.wsConnection?.isHealthy||this.wsFallback?.isHealthy())&&this._hasConnectionID())throw new Error("you can only set device before opening a websocket connection");this.options.device=t}async addDevice(t,s,i,n){return await this.post(this.baseURL+"/devices",{id:t,push_provider:s,...i!=null?{user_id:i}:{},...n!=null?{push_provider_name:n}:{}})}async getDevices(t){return await this.get(this.baseURL+"/devices",t?{user_id:t}:{})}async getUnreadCount(t){return await this.get(this.baseURL+"/unread",t?{user_id:t}:{})}async getUnreadCountBatch(t){return await this.post(this.baseURL+"/unread_batch",{user_ids:t})}async setPushPreferences(t){return await this.post(this.baseURL+"/push_preferences",{preferences:t})}async removeDevice(t,s){return await this.delete(this.baseURL+"/devices",{id:t,...s?{user_id:s}:{}})}getRateLimits(t){const{serverSide:s,web:i,android:n,ios:r,endpoints:a}=t||{};return this.get(this.baseURL+"/rate_limits",{server_side:s,web:i,android:n,ios:r,endpoints:a?a.join(","):void 0})}async getHookEvents(t){const s=t&&t.length>0?{product:t.join(",")}:{};return await this.get(this.baseURL+"/hook/events",s)}_addChannelConfig({cid:t,config:s}){this._cacheEnabled()&&(this.configs[t]=s)}channel(t,s,i={}){if(!this.userID&&!this._isUsingServerAuth())throw Error("Call connectUser or connectAnonymousUser before creating a channel");if(~t.indexOf(":"))throw new Error(`Invalid channel group ${t}, can't contain the : character`);return s&&typeof s=="object"?this.getChannelByMembers(t,s):!s&&typeof i=="object"&&i.members?.length?this.getChannelByMembers(t,i):s?this.getChannelById(t,s,i):new ue(this,t,void 0,i)}async partialUpdateUser(t){return await this.partialUpdateUsers([t])}async upsertUsers(t){const s={};for(const i of t){if(!i.id)throw Error("User ID is required when updating a user");s[i.id]=i}return await this.post(this.baseURL+"/users",{users:s})}upsertUser(t){return this.upsertUsers([t])}async partialUpdateUsers(t){for(const s of t)if(!s.id)throw Error("User ID is required when updating a user");return await this.patch(this.baseURL+"/users",{users:t})}async deleteUser(t,s){return await this.delete(this.baseURL+`/users/${encodeURIComponent(t)}`,s)}async restoreUsers(t){return await this.post(this.baseURL+"/users/restore",{user_ids:t})}async reactivateUser(t,s){return await this.post(this.baseURL+`/users/${encodeURIComponent(t)}/reactivate`,{...s})}async reactivateUsers(t,s){return await this.post(this.baseURL+"/users/reactivate",{user_ids:t,...s})}async deactivateUser(t,s){return await this.post(this.baseURL+`/users/${encodeURIComponent(t)}/deactivate`,{...s})}async deactivateUsers(t,s){return await this.post(this.baseURL+"/users/deactivate",{user_ids:t,...s})}async exportUser(t,s){return await this.get(this.baseURL+`/users/${encodeURIComponent(t)}/export`,{...s})}async banUser(t,s){return await this.post(this.baseURL+"/moderation/ban",{target_user_id:t,...s})}async unbanUser(t,s){return await this.delete(this.baseURL+"/moderation/ban",{target_user_id:t,...s})}async shadowBan(t,s){return await this.banUser(t,{shadow:!0,...s})}async removeShadowBan(t,s){return await this.unbanUser(t,{shadow:!0,...s})}async blockUser(t,s){return await this.post(this.baseURL+"/users/block",{blocked_user_id:t,...s?{user_id:s}:{}})}async getBlockedUsers(t){return await this.get(this.baseURL+"/users/block",{...t?{user_id:t}:{}})}async unBlockUser(t,s){return await this.post(this.baseURL+"/users/unblock",{blocked_user_id:t,...s?{user_id:s}:{}})}async getSharedLocations(){return await this.get(this.baseURL+"/users/live_locations")}async muteUser(t,s,i={}){return await this.post(this.baseURL+"/moderation/mute",{target_id:t,...s?{user_id:s}:{},...i})}async unmuteUser(t,s){return await this.post(this.baseURL+"/moderation/unmute",{target_id:t,...s?{user_id:s}:{}})}userMuteStatus(t){if(!this.user||!this.wsPromise)throw new Error("Make sure to await connectUser() first.");for(let s=0;s<this.mutedUsers.length;s+=1)if(this.mutedUsers[s].target.id===t)return!0;return!1}async flagMessage(t,s={}){return await this.post(this.baseURL+"/moderation/flag",{target_message_id:t,...s})}async flagUser(t,s={}){return await this.post(this.baseURL+"/moderation/flag",{target_user_id:t,...s})}async unflagMessage(t,s={}){return await this.post(this.baseURL+"/moderation/unflag",{target_message_id:t,...s})}async unflagUser(t,s={}){return await this.post(this.baseURL+"/moderation/unflag",{target_user_id:t,...s})}async _queryFlags(t={},s={}){return await this.post(this.baseURL+"/moderation/flags",{filter_conditions:t,...s})}async _queryFlagReports(t={},s={}){return await this.post(this.baseURL+"/moderation/reports",{filter_conditions:t,...s})}async _reviewFlagReport(t,s,i={}){return await this.patch(this.baseURL+`/moderation/reports/${encodeURIComponent(t)}`,{review_result:s,...i})}async unblockMessage(t,s={}){return await this.post(this.baseURL+"/moderation/unblock_message",{target_message_id:t,...s})}async markChannelsRead(t={}){await this.post(this.baseURL+"/channels/read",{...t})}createCommand(t){return this.post(this.baseURL+"/commands",t)}getCommand(t){return this.get(this.baseURL+`/commands/${encodeURIComponent(t)}`)}updateCommand(t,s){return this.put(this.baseURL+`/commands/${encodeURIComponent(t)}`,s)}deleteCommand(t){return this.delete(this.baseURL+`/commands/${encodeURIComponent(t)}`)}listCommands(){return this.get(this.baseURL+"/commands")}createChannelType(t){const s=Object.assign({},{commands:["all"]},t);return this.post(this.baseURL+"/channeltypes",s)}getChannelType(t){return this.get(this.baseURL+`/channeltypes/${encodeURIComponent(t)}`)}updateChannelType(t,s){return this.put(this.baseURL+`/channeltypes/${encodeURIComponent(t)}`,s)}deleteChannelType(t){return this.delete(this.baseURL+`/channeltypes/${encodeURIComponent(t)}`)}listChannelTypes(){return this.get(this.baseURL+"/channeltypes")}async translateMessage(t,s){return await this.post(this.baseURL+`/messages/${encodeURIComponent(t)}/translate`,{language:s})}async translate(t,s,i){return await this.post(this.baseURL+"/translate",{text:t,source_language:i,destination_language:s})}_normalizeExpiration(t){let s=null;if(typeof t=="number"){const i=new Date;i.setSeconds(i.getSeconds()+t),s=i.toISOString()}else ys(t)?s=t:t instanceof Date&&(s=t.toISOString());return s}_validateAndGetMessageId(t,s){let i;if(typeof t=="string")i=t;else{if(!t.id)throw Error(s);i=t.id}return i}pinMessage(t,s,i,n){const r=this._validateAndGetMessageId(t,"Please specify the message id when calling unpinMessage");return this.partialUpdateMessage(r,{set:{pinned:!0,pin_expires:this._normalizeExpiration(s),pinned_at:this._normalizeExpiration(n)}},i)}unpinMessage(t,s){const i=this._validateAndGetMessageId(t,"Please specify the message id when calling unpinMessage");return this.partialUpdateMessage(i,{set:{pinned:!1}},s)}async updateMessage(t,s,i){if(!t.id)throw Error("Please specify the message.id when calling updateMessage");const n=An(t);return typeof s=="string"?n.user_id=s:typeof s?.id=="string"&&(n.user_id=s.id),await this.post(this.baseURL+`/messages/${encodeURIComponent(t.id)}`,{message:n,...i})}async partialUpdateMessage(t,s,i,n){if(!t)throw Error("Please specify the message.id when calling partialUpdateMessage");let r;return typeof i=="string"?r={id:i}:typeof i?.id=="string"&&(r={id:i.id}),await this.put(this.baseURL+`/messages/${encodeURIComponent(t)}`,{...s,...n,user:r})}async deleteMessage(t,s){try{if(this.offlineDb)return s?await this.offlineDb.hardDeleteMessage({id:t}):await this.offlineDb.softDeleteMessage({id:t}),await this.offlineDb.queueTask({task:{messageId:t,payload:[t,s],type:"delete-message"}})}catch(i){this.logger("error","offlineDb:deleteMessage",{tags:["channel","offlineDb"],error:i})}return this._deleteMessage(t,s)}async _deleteMessage(t,s){let i={};return s&&(i={hard:!0}),await this.delete(this.baseURL+`/messages/${encodeURIComponent(t)}`,i)}async undeleteMessage(t,s){return await this.post(this.baseURL+`/messages/${encodeURIComponent(t)}/undelete`,{undeleted_by:s})}async getMessage(t,s){return await this.get(this.baseURL+`/messages/${encodeURIComponent(t)}`,{...s})}async queryThreads(t={}){const s={limit:10,participant_limit:10,reply_limit:3,watch:!0,...t},i={...s};s.filter&&Object.keys(s.filter).length>0&&(i.filter=s.filter),s.sort&&(Array.isArray(s.sort)?s.sort.length>0:Object.keys(s.sort).length>0)&&(i.sort=L(s.sort));const n=await this.post(`${this.baseURL}/threads`,i);return{threads:n.threads.map(r=>new Ie({client:this,threadData:r})),next:n.next}}async getThread(t,s={}){if(!t)throw new Error("Please specify the messageId when calling getThread");const i={participant_limit:100,reply_limit:3,watch:!0,...s},n=await this.get(`${this.baseURL}/threads/${encodeURIComponent(t)}`,i);return new Ie({client:this,threadData:n.thread})}async partialUpdateThread(t,s){if(!t)throw Error("Please specify the message id when calling partialUpdateThread");const i=["created_at","id","last_message_at","type","updated_at","user","reply_count","participants","channel","custom"];for(const n in{...s.set,...s.unset})if(i.includes(n))throw Error(`You cannot set ${n} field on Thread object. ${n} is reserved for server-side use. Please omit ${n} from your set object.`);return await this.patch(`${this.baseURL}/threads/${encodeURIComponent(t)}`,s)}getUserAgent(){if(this.userAgent)return this.userAgent;const t="9.17.0",s="browser-esm";let i="";this.sdkIdentifier?i=`stream-chat-${this.sdkIdentifier.name}-v${this.sdkIdentifier.version}-llc-v${t}`:i=`stream-chat-js-v${t}-${this.node?"node":"browser"}`;const{os:n,model:r}=this.deviceIdentifier??{};return[["os",n],["device_model",r],["client_bundle",s]].reduce((a,[o,l])=>l&&l.length>0?a.concat(`|${o}=${l}`):a,i)}setUserAgent(t){this.userAgent=t}_enrichAxiosOptions(t={params:{},headers:{},config:{}}){const s=this._getToken(),i=s?{Authorization:s}:void 0;let n=null;this.nextRequestAbortController!==null&&(n=this.nextRequestAbortController.signal,this.nextRequestAbortController=null),t.headers?.["x-client-request-id"]||(t.headers={...t.headers,"x-client-request-id":de()});const{params:r,headers:a,...o}=this.options.axiosRequestConfig||{};return{params:{user_id:this.userID,connection_id:this._getConnectionID(),api_key:this.key,...t.params,...r||{}},headers:{...i,"stream-auth-type":this.getAuthType(),"X-Stream-Client":this.getUserAgent(),...t.headers,...a||{}},...n?{signal:n}:{},...t.config,...o||{}}}_getToken(){return!this.tokenManager||this.anonymous?null:this.tokenManager.getToken()}_startCleaning(){const t=this;this.cleaningIntervalRef==null&&(this.cleaningIntervalRef=setInterval(()=>{for(const s of Object.values(t.activeChannels))s.clean()},500))}verifyWebhook(t,s){return!!this.secret&&Tc(t,this.secret,s)}getPermission(t){return this.get(`${this.baseURL}/permissions/${encodeURIComponent(t)}`)}createPermission(t){return this.post(`${this.baseURL}/permissions`,{...t})}updatePermission(t,s){return this.put(`${this.baseURL}/permissions/${encodeURIComponent(t)}`,{...s})}deletePermission(t){return this.delete(`${this.baseURL}/permissions/${encodeURIComponent(t)}`)}listPermissions(){return this.get(`${this.baseURL}/permissions`)}createRole(t){return this.post(`${this.baseURL}/roles`,{name:t})}listRoles(){return this.get(`${this.baseURL}/roles`)}deleteRole(t){return this.delete(`${this.baseURL}/roles/${encodeURIComponent(t)}`)}sync(t,s,i={}){return this.post(`${this.baseURL}/sync`,{channel_cids:t,last_sync_at:s,...i})}async sendUserCustomEvent(t,s){return await this.post(`${this.baseURL}/users/${encodeURIComponent(t)}/event`,{event:s})}createBlockList(t){return this.post(`${this.baseURL}/blocklists`,t)}listBlockLists(t){return this.get(`${this.baseURL}/blocklists`,t)}getBlockList(t,s){return this.get(`${this.baseURL}/blocklists/${encodeURIComponent(t)}`,s)}updateBlockList(t,s){return this.put(`${this.baseURL}/blocklists/${encodeURIComponent(t)}`,s)}deleteBlockList(t,s){return this.delete(`${this.baseURL}/blocklists/${encodeURIComponent(t)}`,s)}exportChannels(t,s={}){const i={channels:t,...s};return this.post(`${this.baseURL}/export_channels`,i)}exportUsers(t){return this.post(`${this.baseURL}/export/users`,t)}exportChannel(t,s){return this.exportChannels([t],s)}getExportChannelStatus(t){return this.get(`${this.baseURL}/export_channels/${encodeURIComponent(t)}`)}campaign(t,s){return t&&typeof t=="object"?new hi(this,null,t):new hi(this,t,s)}segment(t,s,i){return typeof s=="string"?new zi(this,t,s,i):new zi(this,t,null,s)}validateServerSideAuth(){if(!this.secret)throw new Error("Campaigns is a server-side only feature. Please initialize the client with a secret to use this feature.")}createSegment(t,s,i){this.validateServerSideAuth();const n={id:s,type:t,...i};return this.post(this.baseURL+"/segments",n)}createUserSegment(t,s){return this.validateServerSideAuth(),this.createSegment("user",t,s)}createChannelSegment(t,s){return this.validateServerSideAuth(),this.createSegment("channel",t,s)}getSegment(t){return this.validateServerSideAuth(),this.get(this.baseURL+`/segments/${encodeURIComponent(t)}`)}updateSegment(t,s){return this.validateServerSideAuth(),this.put(this.baseURL+`/segments/${encodeURIComponent(t)}`,s)}addSegmentTargets(t,s){this.validateServerSideAuth();const i={target_ids:s};return this.post(this.baseURL+`/segments/${encodeURIComponent(t)}/addtargets`,i)}querySegmentTargets(t,s={},i=[],n={}){return this.validateServerSideAuth(),this.post(this.baseURL+`/segments/${encodeURIComponent(t)}/targets/query`,{filter:s||{},sort:i||[],...n})}removeSegmentTargets(t,s){this.validateServerSideAuth();const i={target_ids:s};return this.post(this.baseURL+`/segments/${encodeURIComponent(t)}/deletetargets`,i)}querySegments(t,s,i={}){return this.validateServerSideAuth(),this.post(this.baseURL+"/segments/query",{filter:t,sort:s,...i})}deleteSegment(t){return this.validateServerSideAuth(),this.delete(this.baseURL+`/segments/${encodeURIComponent(t)}`)}segmentTargetExists(t,s){return this.validateServerSideAuth(),this.get(this.baseURL+`/segments/${encodeURIComponent(t)}/target/${encodeURIComponent(s)}`)}createCampaign(t){return this.validateServerSideAuth(),this.post(this.baseURL+"/campaigns",{...t})}getCampaign(t,s){return this.validateServerSideAuth(),this.get(this.baseURL+`/campaigns/${encodeURIComponent(t)}`,{...s?.users})}startCampaign(t,s){return this.validateServerSideAuth(),this.post(this.baseURL+`/campaigns/${encodeURIComponent(t)}/start`,{scheduled_for:s?.scheduledFor,stop_at:s?.stopAt})}async queryCampaigns(t,s,i){return this.validateServerSideAuth(),await this.post(this.baseURL+"/campaigns/query",{filter:t,sort:s,...i||{}})}updateCampaign(t,s){return this.validateServerSideAuth(),this.put(this.baseURL+`/campaigns/${encodeURIComponent(t)}`,s)}deleteCampaign(t){return this.validateServerSideAuth(),this.delete(this.baseURL+`/campaigns/${encodeURIComponent(t)}`)}stopCampaign(t){return this.validateServerSideAuth(),this.post(this.baseURL+`/campaigns/${encodeURIComponent(t)}/stop`)}enrichURL(t){return this.get(this.baseURL+"/og",{url:t})}getTask(t){return this.get(`${this.baseURL}/tasks/${encodeURIComponent(t)}`)}async deleteChannels(t,s={}){return await this.post(this.baseURL+"/channels/delete",{cids:t,...s})}async deleteUsers(t,s={}){if(typeof s.user<"u"&&!["soft","hard","pruning"].includes(s.user))throw new Error("Invalid delete user options. user must be one of [soft hard pruning]");if(typeof s.conversations<"u"&&!["soft","hard"].includes(s.conversations))throw new Error("Invalid delete user options. conversations must be one of [soft hard]");if(typeof s.messages<"u"&&!["soft","hard","pruning"].includes(s.messages))throw new Error("Invalid delete user options. messages must be one of [soft hard pruning]");return await this.post(this.baseURL+"/users/delete",{user_ids:t,...s})}async _createImportURL(t){return await this.post(this.baseURL+"/import_urls",{filename:t})}async _createImport(t,s={mode:"upsert"}){return await this.post(this.baseURL+"/imports",{path:t,...s})}async _getImport(t){return await this.get(this.baseURL+`/imports/${encodeURIComponent(t)}`)}async _listImports(t){return await this.get(this.baseURL+"/imports",t)}async upsertPushProvider(t){return await this.post(this.baseURL+"/push_providers",{push_provider:t})}async deletePushProvider({type:t,name:s}){return await this.delete(this.baseURL+`/push_providers/${encodeURIComponent(t)}/${encodeURIComponent(s)}`)}async listPushProviders(){return await this.get(this.baseURL+"/push_providers")}createAbortControllerForNextRequest(){return this.nextRequestAbortController=new AbortController}async commitMessage(t){return await this.post(this.baseURL+`/messages/${encodeURIComponent(t)}/commit`)}async createPoll(t,s){return await this.post(this.baseURL+"/polls",{...t,...s?{user_id:s}:{}})}async getPoll(t,s){return await this.get(this.baseURL+`/polls/${encodeURIComponent(t)}`,s?{user_id:s}:{})}async updatePoll(t,s){return await this.put(this.baseURL+"/polls",{...t,...s?{user_id:s}:{}})}async partialUpdatePoll(t,s,i){return await this.patch(this.baseURL+`/polls/${encodeURIComponent(t)}`,{...s,...i?{user_id:i}:{}})}async deletePoll(t,s){return await this.delete(this.baseURL+`/polls/${encodeURIComponent(t)}`,{...s?{user_id:s}:{}})}closePoll(t,s){return this.partialUpdatePoll(t,{set:{is_closed:!0}},s)}async createPollOption(t,s,i){return await this.post(this.baseURL+`/polls/${encodeURIComponent(t)}/options`,{...s,...i?{user_id:i}:{}})}async getPollOption(t,s,i){return await this.get(this.baseURL+`/polls/${encodeURIComponent(t)}/options/${encodeURIComponent(s)}`,i?{user_id:i}:{})}async updatePollOption(t,s,i){return await this.put(this.baseURL+`/polls/${encodeURIComponent(t)}/options`,{...s,...i?{user_id:i}:{}})}async deletePollOption(t,s,i){return await this.delete(this.baseURL+`/polls/${encodeURIComponent(t)}/options/${encodeURIComponent(s)}`,i?{user_id:i}:{})}async castPollVote(t,s,i,n){return await this.post(this.baseURL+`/messages/${encodeURIComponent(t)}/polls/${encodeURIComponent(s)}/vote`,{vote:i,...n?{user_id:n}:{}})}addPollAnswer(t,s,i,n){return this.castPollVote(t,s,{answer_text:i},n)}async removePollVote(t,s,i,n){return await this.delete(this.baseURL+`/messages/${encodeURIComponent(t)}/polls/${encodeURIComponent(s)}/vote/${encodeURIComponent(i)}`,{...n?{user_id:n}:{}})}async queryPolls(t={},s=[],i={},n){const r=n?`?user_id=${n}`:"";return await this.post(this.baseURL+`/polls/query${r}`,{filter:t,sort:L(s),...i})}async queryPollVotes(t,s={},i=[],n={},r){const a=r?`?user_id=${r}`:"";return await this.post(this.baseURL+`/polls/${encodeURIComponent(t)}/votes${a}`,{filter:s,sort:L(i),...n})}async queryPollAnswers(t,s={},i=[],n={},r){const a=r?`?user_id=${r}`:"";return await this.post(this.baseURL+`/polls/${encodeURIComponent(t)}/votes${a}`,{filter:{...s,is_answer:!0},sort:L(i),...n})}async queryMessageHistory(t={},s=[],i={}){return await this.post(this.baseURL+"/messages/history",{filter:t,sort:L(s),...i})}async updateFlags(t,s,i={}){return await this.post(this.baseURL+"/automod/v1/moderation/update_flags",{message_ids:t,reviewed_by:s,...i})}async queryDrafts(t={}){const s={...t,sort:t.sort?L(t.sort):void 0};return await this.post(this.baseURL+"/drafts/query",s)}async createReminder({messageId:t,...s}){return await this.post(`${this.baseURL}/messages/${t}/reminders`,s)}async updateReminder({messageId:t,...s}){return await this.patch(`${this.baseURL}/messages/${t}/reminders`,s)}async deleteReminder(t,s){return await this.delete(`${this.baseURL}/messages/${t}/reminders`,s?{user_id:s}:{})}async queryReminders({filter:t,sort:s,...i}={}){return await this.post(`${this.baseURL}/reminders/query`,{filter:t,sort:s&&L(s),...i})}async updateLocation(t){return await this.put(this.baseURL+"/users/live_locations",t)}uploadFile(t,s,i,n){return this.sendFile(`${this.baseURL}/uploads/file`,t,s,i,n)}uploadImage(t,s,i,n){return this.sendFile(`${this.baseURL}/uploads/image`,t,s,i,n)}deleteFile(t){return this.delete(`${this.baseURL}/uploads/file`,{url:t})}deleteImage(t){return this.delete(`${this.baseURL}/uploads/image`,{url:t})}},Hs=e=>new Date(e.end_at).getTime()<Date.now();function Yi(e){return!e||e.type==="deleted"||!e.shared_location?.end_at?!1:!Hs(e.shared_location)}var cd=3e3,Xi=class yr extends ae{constructor({client:t,getDeviceId:s,watchLocation:i}){if(!t.userID)throw new Error("Live-location sharing is reserved for client-side use only");super(),this.registerSubscriptions=()=>{this.incrementRefCount(),!this.hasSubscriptions&&(this.addUnsubscribeFunction(this.subscribeLiveLocationSharingUpdates()),this.addUnsubscribeFunction(this.subscribeTargetMessagesChange()))},this.unregisterSubscriptions=()=>super.unregisterSubscriptions(),this.client=t,this.state=new x({messages:new Map,ready:!1}),this._deviceId=s(),this.getDeviceId=s,this.watchLocation=i}async init(){await this.assureStateInit(),this.registerSubscriptions()}get messages(){return this.state.getLatestValue().messages}get stateIsReady(){return this.state.getLatestValue().ready}get deviceId(){return this._deviceId||(this._deviceId=this.getDeviceId()),this._deviceId}async assureStateInit(){if(this.stateIsReady)return;const{active_live_locations:t}=await this.client.getSharedLocations();this.state.next({messages:new Map(t.filter(s=>!Hs(s)).map(s=>[s.message_id,{...s,stopSharingTimeout:setTimeout(()=>{this.unregisterMessages([s.message_id])},new Date(s.end_at).getTime()-Date.now())}])),ready:!0})}subscribeTargetMessagesChange(){let t=null;const s=this.state.subscribeWithSelector(({messages:i})=>({messages:i}),({messages:i})=>{i.size?i.size&&!t&&(t=this.subscribeWatchLocation()):(t?.(),t=null)});return()=>{s(),t?.()}}subscribeWatchLocation(){let t=Date.now();return this.watchLocation(({latitude:i,longitude:n})=>{Date.now()<t||(t=Date.now()+cd,Wn(yr.symbol,async()=>{const r=[];await this.assureStateInit();const a=[];for(const[o,l]of this.messages){if(Hs(l)){a.push(l.message_id);continue}if(l.latitude===i&&l.longitude===n)continue;const d=this.client.updateLocation({created_by_device_id:l.created_by_device_id,message_id:o,latitude:i,longitude:n});r.push(d)}this.unregisterMessages(a),r.length>0&&await Promise.allSettled(r)}))})}subscribeLiveLocationSharingUpdates(){const t=[...["live_location_sharing.started","message.updated","message.deleted"].map(s=>this.client.on(s,i=>{i.message&&(i.type==="live_location_sharing.started"?this.registerMessage(i.message):i.type==="message.updated"?(this.messages.has(i.message.id)&&!Yi(i.message)&&this.unregisterMessages([i.message.id]),this.registerMessage(i.message)):this.unregisterMessages([i.message.id]))})),this.client.on("live_location_sharing.stopped",s=>{s.live_location&&this.unregisterMessages([s.live_location?.message_id])})];return()=>t.forEach(s=>s.unsubscribe())}registerMessage(t){!this.client.userID||t?.user?.id!==this.client.userID||!Yi(t)||this.state.next(s=>{const i=new Map(s.messages);return i.set(t.id,{...t.shared_location,stopSharingTimeout:setTimeout(()=>{this.unregisterMessages([t.id])},new Date(t.shared_location.end_at).getTime()-Date.now())}),{...s,messages:i}})}unregisterMessages(t){const s=this.messages,i=new Set(t),n=new Map(Array.from(s).filter(([r,a])=>(i.has(r)&&a.stopSharingTimeout&&(clearTimeout(a.stopSharingTimeout),a.stopSharingTimeout=null),!i.has(r))));n.size!==s.size&&this.state.partialNext({messages:n})}};Xi.symbol=Symbol(Xi.name);var Fd=class{constructor(e,t){if(!e)throw new Error("Size must be greater than 0");this.keys=[],this.size=e,this.map=new Map,this.dispose=t?.dispose??null}add(e,t){if(this.keys.indexOf(e)>-1)this.keys.splice(this.keys.indexOf(e),1);else if(this.keys.length>=this.size){const i=this.keys.shift();if(i){const n=this.peek(i);n&&this.dispose?.(i,n),this.map.delete(i)}}this.keys.push(e),this.map.set(e,t)}peek(e){return this.map.get(e)}get(e){const t=this.peek(e);return t&&this.keys.indexOf(e)!==this.size-1&&(this.keys.splice(this.keys.indexOf(e),1),this.keys.push(e)),t}};export{Od as C,Fd as F,ii as L,Ft as M,x as S,Pd as U,Il as V,Ud as a,Po as b,Ld as c,Ad as d,Td as e,I as f,qn as g,Md as h,Z as i,me as j,Id as k,Fn as l,Vn as m,Bn as n,$n as o,Nn as p,xd as q,Dd as r,kd as s,Nd as t};
